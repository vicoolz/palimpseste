<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PALIMPSESTE</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <!-- Supabase SDK (async pour ne pas bloquer) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" async></script>
    <style>
        :root {
            --bg: #0d0d0d;
            --bg-card: #161618;
            --bg-elevated: #1e1e21;
            --text: #e8e6e3;
            --text-secondary: #9d9a95;
            --muted: #5c5a56;
            --accent: #e63946;
            --accent-secondary: #f4a261;
            --accent-tertiary: #2a9d8f;
            --accent-purple: #9b5de5;
            --border: #2a2a2d;
            --glow: 0 0 60px rgba(230,57,70,0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.7;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            /* Grain subtil fa√ßon vieux papier */
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
        }
        
        /* Stats Panel - Style √©pur√© */
        .stats-panel {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 260px;
            background: linear-gradient(180deg, var(--bg-card) 0%, var(--bg) 100%);
            border-right: 1px solid var(--border);
            padding: 1.5rem 1.25rem;
            overflow-y: auto;
            z-index: 50;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .stats-logo {
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 0.25em;
            color: var(--text);
            text-transform: uppercase;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }
        .stats-section h3 {
            font-size: 0.6rem;
            font-weight: 600;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: var(--muted);
            margin-bottom: 1rem;
        }
        .big-number {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--text), var(--text-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1;
        }
        .big-number-label {
            font-size: 0.75rem;
            color: var(--muted);
            margin-top: 0.25rem;
        }
        .mini-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }
        .mini-stat {
            background: var(--bg-elevated);
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid var(--border);
        }
        .mini-stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text);
        }
        .mini-stat-label {
            font-size: 0.7rem;
            color: var(--muted);
            margin-top: 0.25rem;
        }
        
        /* Author bars */
        .author-bars {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .author-bar {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .author-bar-name {
            font-size: 0.75rem;
            color: var(--text-secondary);
            width: 100px;
            flex-shrink: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .author-bar-track {
            flex: 1;
            height: 6px;
            background: var(--bg);
            border-radius: 3px;
            overflow: hidden;
        }
        .author-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        .author-bar-count {
            font-size: 0.7rem;
            color: var(--muted);
            width: 24px;
            text-align: right;
        }
        
        /* Genre donut placeholder */
        .genre-chart {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .genre-pill {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.4rem 0.75rem;
            background: var(--bg-elevated);
            border-radius: 100px;
            border: 1px solid var(--border);
            font-size: 0.7rem;
            color: var(--text-secondary);
        }
        .genre-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        /* Connexions */
        .connections-section { margin-top: 1rem; }
        .connections-hint {
            font-size: 0.7rem;
            color: var(--muted);
            margin-bottom: 0.75rem;
        }
        .connection-graph {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .connection-node {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        .connection-node:hover {
            border-color: var(--accent);
            color: var(--text);
            transform: translateX(4px);
        }
        .connection-node.discovered {
            border-color: var(--accent-tertiary);
            background: rgba(48,209,88,0.1);
        }
        .connection-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent);
            flex-shrink: 0;
        }
        .connection-node.discovered .connection-dot {
            background: var(--accent-tertiary);
        }
        .connection-label {
            font-size: 0.6rem;
            color: var(--muted);
            margin-top: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        /* Fun stats */
        .fun-stat {
            margin-top: 1rem;
            padding: 0.75rem;
            background: linear-gradient(135deg, rgba(255,159,10,0.1), rgba(191,90,242,0.1));
            border-radius: 8px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-align: center;
            line-height: 1.4;
        }
        .fun-stat strong { color: var(--accent-secondary); }
        
        /* Section Favoris */
        .favorites-section {
            max-height: 280px;
            overflow-y: auto;
        }
        .favorite-item {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            padding: 0.5rem 0.6rem;
            background: transparent;
            border-left: 2px solid var(--accent);
            margin-bottom: 0.6rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .favorite-item:hover {
            background: var(--bg-elevated);
            padding-left: 0.8rem;
        }
        .favorite-content {
            flex: 1;
            min-width: 0;
        }
        .favorite-title {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .favorite-author {
            font-size: 0.6rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .favorite-preview {
            display: none; /* Simplifi√© */
        }
        .favorite-remove {
            background: none;
            border: none;
            color: var(--muted);
            cursor: pointer;
            padding: 0.2rem;
            font-size: 0.7rem;
            opacity: 0;
            transition: all 0.2s;
        }
        .favorite-item:hover .favorite-remove {
            opacity: 1;
        }
        .favorite-remove:hover {
            color: var(--accent);
        }
        .favorites-empty {
            font-size: 0.75rem;
            color: var(--muted);
            text-align: center;
            padding: 1rem;
            font-style: italic;
        }
        .source-badge {
            font-size: 0.55rem;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            background: rgba(191,90,242,0.2);
            color: var(--accent-purple);
            margin-left: 0.3rem;
        }
        
        /* Achievements */
        .achievements {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .achievement {
            padding: 0.4rem 0.6rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            opacity: 0.4;
            transition: all 0.3s;
        }
        .achievement.unlocked {
            opacity: 1;
            border-color: var(--accent-secondary);
            background: rgba(255,159,10,0.1);
        }
        .achievement-icon { font-size: 1rem; }
        
        /* Path visualization */
        .reading-path {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            flex-wrap: wrap;
            margin-top: 0.5rem;
            font-size: 0.65rem;
        }
        .path-node {
            padding: 0.2rem 0.4rem;
            background: var(--bg-elevated);
            border-radius: 4px;
            color: var(--text-secondary);
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .path-arrow { color: var(--muted); }
        
        /* Recommandation banner */
        .reco-banner {
            background: linear-gradient(135deg, rgba(255,69,58,0.15), rgba(191,90,242,0.15));
            border: 1px solid rgba(255,69,58,0.3);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: none;
        }
        .reco-banner.show { display: block; }
        .reco-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--accent);
            margin-bottom: 0.5rem;
        }
        .reco-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        .reco-authors {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            margin-top: 0.75rem;
        }
        .reco-author {
            padding: 0.35rem 0.7rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.75rem;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
        }
        .reco-author:hover {
            border-color: var(--accent);
            background: rgba(255,69,58,0.1);
        }
        
        /* Main content */
        header {
            position: fixed;
            top: 0;
            left: 260px;
            right: 0;
            z-index: 100;
            background: rgba(13,13,13,0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
        }
        .header-inner {
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .header-title {
            font-family: 'Inter', sans-serif;
            font-size: 0.75rem;
            font-weight: 500;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--muted);
            white-space: nowrap;
            flex-shrink: 0;
        }
        .header-actions { display: flex; gap: 0.5rem; align-items: center; flex-shrink: 0; }
        .header-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--muted);
            padding: 0.4rem 0.8rem;
            border-radius: 2px;
            font-size: 0.7rem;
            font-weight: 500;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
        }
        .header-btn:hover { border-color: var(--text); color: var(--text); }
        
        /* Language selector */
        .lang-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .lang-select {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            appearance: none;
            padding-right: 1.5rem;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%238e8e93' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
        }
        .lang-select:hover { border-color: var(--text); }
        .lang-select:focus { outline: none; border-color: var(--text); }
        .lang-icon { font-size: 0.9rem; }
        
        /* Search Bar */
        .search-container {
            position: relative;
            flex: 1;
            min-width: 200px;
            max-width: 400px;
            margin: 0 1rem;
        }
        .search-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }
        .search-input {
            width: 100%;
            padding: 0.6rem 1rem 0.6rem 2.5rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 25px;
            color: var(--text);
            font-size: 0.85rem;
            transition: all 0.2s;
            min-width: 150px;
        }
        .search-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(230, 57, 70, 0.1);
        }
        .search-input::placeholder {
            color: var(--muted);
        }
        .search-icon {
            position: absolute;
            left: 0.85rem;
            color: var(--muted);
            font-size: 0.9rem;
            pointer-events: none;
        }
        .search-clear {
            position: absolute;
            right: 0.75rem;
            background: none;
            border: none;
            color: var(--muted);
            cursor: pointer;
            font-size: 1rem;
            display: none;
            padding: 0.25rem;
        }
        .search-clear.visible { display: block; }
        .search-clear:hover { color: var(--text); }
        
        main {
            margin-left: 260px;
            max-width: 720px;
            margin-right: auto;
            margin-left: calc(260px + (100% - 260px - 720px) / 2);
            padding: 4.5rem 2rem 4rem;
        }
        @media (max-width: 1100px) {
            main { margin-left: 260px; margin-right: 1rem; }
        }
        
        /* Search Results Overlay */
        .search-results-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 400;
            display: none;
            overflow-y: auto;
        }
        .search-results-overlay.open { display: block; }
        .search-results-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }
        .search-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }
        .search-results-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text);
        }
        .search-results-query {
            color: var(--accent);
        }
        .search-results-close {
            background: none;
            border: none;
            color: var(--text);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
        }
        .search-results-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        .search-tab {
            padding: 0.5rem 1rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .search-tab:hover { border-color: var(--text); color: var(--text); }
        .search-tab.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }
        .search-tab .count {
            margin-left: 0.35rem;
            opacity: 0.7;
        }
        .search-results-grid {
            display: grid;
            gap: 1rem;
        }
        .search-result-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem 1.25rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .search-result-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }
        .search-result-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.35rem;
        }
        .search-result-author {
            font-size: 0.85rem;
            color: var(--accent);
            margin-bottom: 0.5rem;
        }
        .search-result-snippet {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .search-result-snippet mark {
            background: rgba(230, 57, 70, 0.3);
            color: var(--text);
            padding: 0 0.15rem;
            border-radius: 2px;
        }
        .search-result-meta {
            display: flex;
            gap: 0.75rem;
            margin-top: 0.75rem;
            font-size: 0.7rem;
            color: var(--muted);
        }
        .search-result-source {
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }
        .search-loading {
            text-align: center;
            padding: 3rem;
            color: var(--muted);
        }
        .search-no-results {
            text-align: center;
            padding: 3rem;
            color: var(--muted);
        }
        .search-no-results-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 3px;
            margin-bottom: 2.5rem;
            overflow: hidden;
            opacity: 0;
            transform: translateY(20px) rotate(-0.3deg);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, var(--accent) 0%, var(--accent-purple) 100%);
        }
        .card:hover { 
            transform: translateY(-2px) rotate(0deg); 
            box-shadow: -8px 8px 0 var(--border);
        }
        .card.show { opacity: 1; transform: rotate(-0.3deg); }
        .card.show:hover { transform: translateY(-2px) rotate(0deg); }
        
        .card-head {
            padding: 1.5rem 1.5rem 0.75rem;
            padding-left: 1.75rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
            border-bottom: 1px dashed var(--border);
        }
        .author {
            font-family: 'Playfair Display', serif;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text);
            letter-spacing: 0.02em;
        }
        .work {
            font-size: 0.8rem;
            color: var(--muted);
            margin-top: 0.25rem;
            font-weight: 400;
            font-style: italic;
        }
        .tag {
            font-size: 0.55rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            padding: 0.35rem 0.75rem;
            background: transparent;
            color: var(--muted);
            border: 1px solid var(--border);
            border-radius: 0;
        }
        .tag.po√©sie { border-color: var(--accent-purple); color: var(--accent-purple); }
        .tag.fable { border-color: var(--accent-tertiary); color: var(--accent-tertiary); }
        .tag.nouvelle { border-color: var(--accent-secondary); color: var(--accent-secondary); }
        .tag.mystique { border-color: #c9a227; color: #c9a227; }
        .tag.philosophie { border-color: #8b7355; color: #a08060; }
        .tag.roman { border-color: #c44569; color: #c44569; }
        .tag.th√©√¢tre { border-color: #3d9be9; color: #3d9be9; }
        .tag.conte { border-color: var(--accent-secondary); color: var(--accent-secondary); }
        
        /* Language badge */
        .lang-badge {
            font-size: 0.6rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0.25rem 0.5rem;
            background: rgba(255,255,255,0.1);
            color: var(--muted);
            border-radius: 4px;
            margin-left: 0.5rem;
        }
        .lang-badge.en { background: rgba(0,82,180,0.2); color: #64b5f6; }
        .lang-badge.de { background: rgba(255,204,0,0.2); color: #ffd54f; }
        .lang-badge.it { background: rgba(0,140,69,0.2); color: #81c784; }
        .lang-badge.es { background: rgba(198,11,30,0.2); color: #e57373; }
        .lang-badge.pt { background: rgba(0,102,0,0.2); color: #66bb6a; }
        .lang-badge.ru { background: rgba(0,57,166,0.2); color: #7986cb; }
        .lang-badge.la { background: rgba(139,90,43,0.2); color: #bcaaa4; }
        .lang-badge.zh { background: rgba(222,41,16,0.2); color: #ef5350; }
        .lang-badge.ja { background: rgba(188,0,45,0.2); color: #f06292; }
        .lang-badge.ar { background: rgba(0,122,61,0.2); color: #4db6ac; }
        .lang-badge.el { background: rgba(13,94,175,0.2); color: #4fc3f7; }
        
        .card-body {
            padding: 1.25rem 1.5rem 1.25rem 1.75rem;
            font-size: 1.05rem;
            line-height: 1.85;
            position: relative;
            color: var(--text-secondary);
            font-weight: 300;
        }
        .text-teaser {
            white-space: pre-wrap;
        }
        .text-teaser::after {
            content: ' ‚ñ™‚ñ™‚ñ™';
            color: var(--muted);
            font-size: 0.7em;
        }
        .text-full {
            display: none;
            white-space: pre-wrap;
            margin-top: 1.25rem;
            padding-top: 1.25rem;
            border-top: 1px solid var(--border);
            animation: fadeIn 0.4s ease;
        }
        .text-full.visible { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Bouton Suite - style brutaliste */
        .btn-suite {
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            margin-top: 1.25rem;
            padding: 0.6rem 1.25rem;
            background: transparent;
            border: 1px solid var(--accent);
            border-radius: 0;
            color: var(--accent);
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-suite:hover {
            background: var(--accent);
            color: var(--bg);
        }
        .btn-suite.exhausted {
            border-color: var(--muted);
            color: var(--muted);
            cursor: default;
        }
        .btn-suite .arrow {
            transition: transform 0.3s;
        }
        .btn-suite:hover .arrow {
            transform: translateX(3px);
        }
        
        /* Chunks de texte r√©v√©l√©s progressivement */
        .text-chunk {
            margin-top: 1rem;
            padding-top: 0.75rem;
        }
        .text-chunk + .text-chunk {
            border-top: 1px dotted var(--border);
        }
        
        .card-foot {
            padding: 1.25rem 1.75rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-start;
            align-items: center;
            gap: 0.5rem;
        }
        .actions { display: flex; gap: 0.4rem; }
        .btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--muted);
            padding: 0.5rem 1rem;
            border-radius: 0;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.65rem;
            font-weight: 600;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }
        .btn:hover { border-color: var(--text); color: var(--text); }
        .btn.active { 
            background: var(--accent); 
            border-color: var(--accent); 
            color: var(--bg); 
        }
        
        .feed-loading {
            text-align: center;
            padding: 4rem;
            color: var(--muted);
            font-size: 0.75rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }
        .spinner {
            width: 24px;
            height: 24px;
            border: 1px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            margin: 0 auto 1rem;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-elevated);
            border: 1px solid var(--accent);
            color: var(--text);
            padding: 0.9rem 1.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
            z-index: 300;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }
        .toast.show { transform: translateX(-50%) translateY(0); }
        
        .progress {
            position: fixed;
            top: 0;
            left: 280px;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--accent), var(--accent-secondary));
            z-index: 1000;
            transition: width 0.1s;
        }
        
        /* Reader overlay */
        .reader-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg);
            z-index: 200;
            display: none;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .reader-overlay.open { display: flex; }
        .reader-header {
            padding: 1.25rem 2rem;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .reader-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.1rem;
            font-weight: 400;
            color: var(--text);
        }
        .reader-close {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            color: var(--text);
            width: 44px;
            height: 44px;
            border-radius: 12px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .reader-close:hover { border-color: var(--accent); color: var(--accent); }
        .reader-content {
            flex: 1;
            overflow-y: auto;
            padding: 3rem 2rem;
            font-size: 1.15rem;
            line-height: 2.2;
            max-width: 700px;
            margin: 0 auto;
            width: 100%;
            font-weight: 300;
        }

        /* Navigateur de Cat√©gories */
        .category-nav {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            animation: slideDown 0.3s ease;
        }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .cat-breadcrumbs {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            font-family: 'Courier Prime', monospace;
        }
        .cat-crumb {
            cursor: pointer;
            color: var(--muted);
            transition: color 0.2s;
        }
        .cat-crumb:hover { color: var(--accent); text-decoration: underline; }
        .cat-crumb.active { color: var(--text); font-weight: bold; pointer-events: none; }
        .cat-sep { color: var(--border); }
        
        .cat-subcategories {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .cat-pill {
            display: inline-flex;
            align-items: center;
            padding: 0.3rem 0.8rem;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 999px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-secondary);
        }
        .cat-pill:hover {
            border-color: var(--accent);
            color: var(--accent);
            transform: translateY(-2px);
        }
        .cat-pill .count {
            font-size: 0.7em;
            margin-left: 0.4rem;
            opacity: 0.6;
        }
        .cat-close {
            margin-top: 1rem;
            background: none;
            border: none;
            color: var(--muted);
            font-size: 0.8rem;
            cursor: pointer;
            padding: 0;
            text-decoration: underline;
        }
        .cat-close:hover { color: var(--accent); }
        
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--muted);
            font-style: italic;
            line-height: 1.8;
        }
        
        /* Branches enrichies */
        .branches-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .branch-group {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 0.8rem;
            border: 1px solid var(--border);
        }
        .branch-group-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .branch-items {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
        }
        
        /* Favorites View Overlay */
        .favorites-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(13,13,13,0.95);
            z-index: 250;
            display: none;
            animation: fadeIn 0.3s ease;
            overflow-y: auto;
        }
        .favorites-overlay.open { display: block; }
        .favorites-view {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
        }
        .favorites-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 1.5rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border);
        }
        .favorites-title {
            font-size: 0.8rem;
            font-weight: 700;
            letter-spacing: 0.2em;
            color: var(--accent);
        }
        .favorites-grid {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .fav-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-left: 4px solid var(--accent);
            padding: 1.5rem;
            transition: all 0.2s;
        }
        .fav-card:hover {
            border-color: var(--accent);
            box-shadow: -4px 4px 0 var(--border);
        }
        .fav-card-head {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        .fav-card-author {
            font-family: 'Playfair Display', serif;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
        }
        .fav-card-title {
            font-size: 0.8rem;
            color: var(--muted);
            font-style: italic;
            margin-top: 0.25rem;
        }
        .fav-card-text {
            font-size: 0.95rem;
            line-height: 1.8;
            color: var(--text-secondary);
            white-space: pre-wrap;
        }
        .fav-card-actions {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 0.5rem;
        }
        .fav-empty {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--muted);
        }
        .fav-empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }
        .fav-empty-text {
            font-size: 0.8rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }
        
        /* Bouton favoris dans le header */
        .favorites-btn {
            color: var(--accent) !important;
            border-color: var(--accent) !important;
        }
        .favorites-btn:hover {
            background: var(--accent) !important;
            color: var(--bg) !important;
        }
        
        /* Statistiques de lecture */
        .reading-stats-section {
            background: linear-gradient(135deg, rgba(255,69,58,0.05) 0%, transparent 100%);
            border: 1px solid var(--border);
            border-left: 3px solid var(--accent);
        }
        .reading-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        .reading-stat-item {
            text-align: center;
            padding: 0.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
        }
        .reading-stat-icon {
            font-size: 1.2rem;
            margin-bottom: 0.25rem;
        }
        .reading-stat-value {
            font-family: 'Playfair Display', serif;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text);
        }
        .reading-stat-label {
            font-size: 0.65rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .streak-item .reading-stat-value {
            color: var(--accent);
        }
        .streak-bar {
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }
        .streak-progress {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #ff9500);
            width: 0%;
            transition: width 0.5s ease;
        }
        .streak-hint {
            font-size: 0.7rem;
            color: var(--muted);
            text-align: center;
            margin-bottom: 1rem;
            font-style: italic;
        }
        .weekly-chart {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            height: 50px;
            gap: 3px;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border);
        }
        .weekly-bar {
            flex: 1;
            background: var(--border);
            min-height: 4px;
            transition: all 0.3s;
            position: relative;
        }
        .weekly-bar.active {
            background: var(--accent);
        }
        .weekly-bar.today {
            background: linear-gradient(to top, var(--accent), #ff9500);
            box-shadow: 0 0 8px rgba(255,69,58,0.5);
        }
        .weekly-bar::after {
            content: attr(data-day);
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.55rem;
            color: var(--muted);
        }
        
        @media (max-width: 900px) {
            .stats-panel { display: none; }
            header { left: 0; }
            main { margin-left: auto; padding: 5rem 1rem 3rem; }
            .progress { left: 0; }
        }
        
        /* Achievement popup */
        .achievement-popup {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: linear-gradient(135deg, rgba(30,30,32,0.98), rgba(20,20,22,0.98));
            border: 1px solid var(--accent);
            border-radius: 16px;
            padding: 1.25rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(255,69,58,0.3), 0 0 60px rgba(255,69,58,0.1);
            transform: translateX(120%);
            transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .achievement-popup.show { transform: translateX(0); }
        .achievement-icon { font-size: 2.5rem; animation: bounce 0.6s ease infinite; }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        .achievement-info { display: flex; flex-direction: column; gap: 0.25rem; }
        .achievement-title { font-size: 0.7rem; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; }
        .achievement-name { font-family: 'Playfair Display', serif; font-size: 1.1rem; font-weight: 600; color: var(--text); }
        .achievement-desc { font-size: 0.8rem; color: var(--text-secondary); }
        
        /* Achievement badges grid */
        .achievements { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 0.5rem; 
        }
        .achievement {
            width: 36px;
            height: 36px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            filter: grayscale(1) opacity(0.3);
            transition: all 0.3s;
            cursor: help;
        }
        .achievement.unlocked {
            filter: none;
            border-color: var(--accent);
            box-shadow: 0 0 12px rgba(255,69,58,0.3);
            animation: unlockPulse 2s ease infinite;
        }
        @keyframes unlockPulse {
            0%, 100% { box-shadow: 0 0 12px rgba(255,69,58,0.3); }
            50% { box-shadow: 0 0 20px rgba(255,69,58,0.5); }
        }
        
        /* Fun stat */
        .fun-stat {
            margin-top: 1rem;
            padding: 0.75rem;
            background: linear-gradient(135deg, rgba(255,69,58,0.1), rgba(191,90,242,0.1));
            border-radius: 10px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-align: center;
            font-style: italic;
            transition: opacity 0.3s;
        }
        
        /* Reading path */
        .reading-path {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.25rem;
            margin-top: 0.75rem;
            padding: 0.5rem;
            background: var(--bg-elevated);
            border-radius: 8px;
            font-size: 0.7rem;
        }
        .path-node {
            background: var(--bg-card);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }
        .path-node:last-of-type { 
            color: var(--accent); 
            border-color: var(--accent); 
        }
        .path-arrow { color: var(--text-muted); font-size: 0.6rem; }
        
        /* Related authors (dans les cartes) */
        .related-authors {
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, rgba(255,69,58,0.05), rgba(191,90,242,0.05));
            border-top: 1px solid var(--border);
        }
        .related-title {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            font-weight: 500;
        }
        .related-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .related-btn {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .related-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            transform: scale(1.05);
        }
        .no-related {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .btn-small {
            padding: 0.3rem 0.6rem;
            font-size: 0.75rem;
        }
        .explore-hint {
            font-size: 0.7rem;
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        .card-head:hover .explore-hint {
            opacity: 1;
        }
        
        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           üê¶ SOCIAL FEATURES - Style Twitter/X
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        
        /* Modal Auth */
        .auth-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 500;
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }
        .auth-modal.open { display: flex; }
        .auth-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            width: 100%;
            max-width: 400px;
            margin: 1rem;
        }
        .auth-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            color: var(--text);
            margin-bottom: 0.5rem;
            text-align: center;
        }
        .auth-subtitle {
            font-size: 0.85rem;
            color: var(--muted);
            text-align: center;
            margin-bottom: 1.5rem;
        }
        .auth-input {
            width: 100%;
            padding: 0.9rem 1rem;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.95rem;
            margin-bottom: 0.75rem;
            transition: border-color 0.2s;
        }
        .auth-input:focus {
            outline: none;
            border-color: var(--accent);
        }
        .auth-input::placeholder { color: var(--muted); }
        .auth-btn {
            width: 100%;
            padding: 0.9rem;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 0.5rem;
        }
        .auth-btn:hover { background: #ff4757; transform: scale(1.02); }
        .auth-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .auth-btn.secondary {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }
        .auth-btn.secondary:hover { border-color: var(--text); color: var(--text); }
        .auth-divider {
            display: flex;
            align-items: center;
            margin: 1.25rem 0;
            color: var(--muted);
            font-size: 0.8rem;
        }
        .auth-divider::before, .auth-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }
        .auth-divider span { padding: 0 1rem; }
        .auth-switch {
            text-align: center;
            margin-top: 1.25rem;
            font-size: 0.85rem;
            color: var(--muted);
        }
        .auth-switch a {
            color: var(--accent);
            cursor: pointer;
            text-decoration: none;
        }
        .auth-switch a:hover { text-decoration: underline; }
        .auth-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: var(--muted);
            font-size: 1.5rem;
            cursor: pointer;
        }
        .auth-close:hover { color: var(--text); }
        .auth-error {
            background: rgba(255,69,58,0.1);
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.85rem;
            margin-bottom: 1rem;
            display: none;
        }
        .auth-error.show { display: block; }
        
        /* User menu in header */
        .user-menu {
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), var(--accent-purple));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s;
        }
        .user-avatar:hover { border-color: var(--accent); }
        .user-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            min-width: 180px;
            display: none;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            z-index: 100;
        }
        .user-dropdown.open { display: block; }
        .user-dropdown-item {
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .user-dropdown-item:first-child { border-radius: 12px 12px 0 0; }
        .user-dropdown-item:last-child { border-radius: 0 0 12px 12px; }
        .user-dropdown-item:hover {
            background: var(--bg-elevated);
            color: var(--text);
        }
        .user-dropdown-item.danger:hover { color: var(--accent); }
        .user-dropdown-divider {
            height: 1px;
            background: var(--border);
            margin: 0.25rem 0;
        }
        
        /* Social Feed Tab */
        .feed-tabs {
            display: flex;
            gap: 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.25rem;
            margin-bottom: 1.5rem;
        }
        .feed-tab {
            flex: 1;
            padding: 0.6rem 1rem;
            background: transparent;
            border: none;
            color: var(--muted);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .feed-tab:hover { color: var(--text); }
        .feed-tab.active {
            background: var(--accent);
            color: white;
        }
        .feed-refresh {
            padding: 0.5rem 0.7rem;
            background: transparent;
            border: none;
            color: var(--muted);
            font-size: 1rem;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s;
            margin-left: 0.5rem;
        }
        .feed-refresh:hover {
            color: var(--accent);
            transform: rotate(180deg);
        }
        .feed-refresh.spinning {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .feed-live-indicator {
            padding: 0.4rem 1rem;
            font-size: 0.75rem;
            color: var(--muted);
            text-align: center;
            border-bottom: 1px solid var(--border);
        }
        .feed-live-indicator.new-content {
            background: rgba(42, 157, 143, 0.1);
            color: var(--accent);
            cursor: pointer;
        }
        
        /* Share button on cards */
        .btn-share {
            background: transparent;
            border: 1px solid var(--accent-tertiary);
            color: var(--accent-tertiary);
        }
        .btn-share:hover {
            background: var(--accent-tertiary);
            color: var(--bg);
        }
        
        /* Selection highlight for sharing */
        .text-selectable::selection {
            background: rgba(42, 157, 143, 0.4);
        }
        
        /* Share Modal */
        .share-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 500;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .share-modal.open { display: flex; }
        .share-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            width: 100%;
            max-width: 500px;
            margin: 1rem;
        }
        .share-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .share-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
        }
        .share-preview {
            background: var(--bg);
            border-left: 3px solid var(--accent-tertiary);
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0 8px 8px 0;
        }
        .share-preview-text {
            font-family: 'Playfair Display', serif;
            font-size: 1.1rem;
            font-style: italic;
            color: var(--text);
            line-height: 1.6;
            margin-bottom: 0.75rem;
        }
        .share-preview-source {
            font-size: 0.8rem;
            color: var(--muted);
        }
        .share-commentary {
            width: 100%;
            padding: 0.9rem;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.9rem;
            resize: vertical;
            min-height: 80px;
            margin-bottom: 1rem;
            font-family: inherit;
        }
        .share-commentary:focus { outline: none; border-color: var(--accent-tertiary); }
        .share-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }
        .share-btn {
            padding: 0.7rem 1.5rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .share-btn.primary {
            background: var(--accent-tertiary);
            border: none;
            color: white;
        }
        .share-btn.primary:hover { background: #25877b; }
        .share-btn.secondary {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }
        .share-btn.secondary:hover { border-color: var(--text); color: var(--text); }
        
        /* Extrait Card (social feed) */
        .extrait-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }
        .extrait-card:hover {
            border-color: var(--accent-tertiary);
        }
        .extrait-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }
        .extrait-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), var(--accent-purple));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
        }
        .extrait-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        .extrait-user-info {
            flex: 1;
            min-width: 0;
        }
        .extrait-username {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text);
        }
        .extrait-username-link {
            cursor: pointer;
            transition: color 0.2s;
        }
        .extrait-username-link:hover {
            color: var(--accent);
        }
        .follow-btn {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            border: 1px solid var(--accent);
            background: transparent;
            color: var(--accent);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: auto;
        }
        .follow-btn:hover {
            background: var(--accent);
            color: white;
        }
        .follow-btn.following {
            background: var(--accent-tertiary);
            border-color: var(--accent-tertiary);
            color: white;
        }
        .follow-btn.following:hover {
            background: #dc3545;
            border-color: #dc3545;
        }
        .user-profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        .user-profile-modal.open {
            opacity: 1;
            visibility: visible;
        }
        .user-profile-content {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            border: 1px solid var(--border);
        }
        .profile-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .profile-avatar-large {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), var(--accent-purple));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 600;
            color: white;
        }
        .profile-info h3 {
            font-size: 1.25rem;
            margin-bottom: 0.25rem;
        }
        .profile-stats {
            display: flex;
            gap: 1.5rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .profile-stat strong {
            color: var(--text);
        }
        .profile-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        .profile-actions button {
            flex: 1;
            padding: 0.75rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }
        .btn-follow-large {
            background: var(--accent);
            color: white;
        }
        .btn-follow-large.following {
            background: var(--accent-tertiary);
        }
        .btn-follow-small {
            padding: 0.35rem 0.75rem;
            font-size: 0.7rem;
            border-radius: 20px;
            border: 1px solid var(--accent);
            background: transparent;
            color: var(--accent);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            margin-left: auto;
        }
        .btn-follow-small:hover {
            background: var(--accent);
            color: white;
        }
        .btn-follow-small.following {
            border-color: var(--accent-tertiary);
            color: var(--accent-tertiary);
        }
        .btn-follow-small.following:hover {
            background: rgba(42, 157, 143, 0.2);
        }
        
        /* Discover Users Grid */
        .discover-header {
            text-align: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }
        .discover-header h3 {
            font-size: 1.1rem;
            color: var(--text);
            margin-bottom: 0.5rem;
        }
        .discover-header p {
            font-size: 0.85rem;
            color: var(--muted);
        }
        .discover-grid {
            display: grid;
            gap: 0.75rem;
        }
        .discover-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            transition: all 0.2s;
        }
        .discover-card:hover {
            border-color: var(--accent);
            transform: translateX(4px);
        }
        .discover-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), var(--accent-purple));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: 600;
            color: white;
            cursor: pointer;
            flex-shrink: 0;
        }
        .discover-info {
            flex: 1;
            cursor: pointer;
        }
        .discover-name {
            font-weight: 600;
            color: var(--text);
            font-size: 1rem;
        }
        .discover-stats {
            font-size: 0.8rem;
            color: var(--muted);
            margin-top: 0.2rem;
        }
        
        .btn-close-profile {
            background: var(--bg-elevated);
            color: var(--text);
            border: 1px solid var(--border) !important;
        }
        .friends-list {
            margin-top: 1.5rem;
            border-top: 1px solid var(--border);
            padding-top: 1rem;
        }
        .friends-list h4 {
            font-size: 0.85rem;
            color: var(--muted);
            margin-bottom: 0.75rem;
        }
        .friend-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0;
            cursor: pointer;
        }
        .friend-item:hover {
            background: var(--bg-elevated);
            margin: 0 -1rem;
            padding: 0.5rem 1rem;
            border-radius: 8px;
        }
        .friend-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent-purple);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: white;
        }
        .extrait-time {
            font-size: 0.75rem;
            color: var(--muted);
        }
        .extrait-text {
            font-family: 'Playfair Display', serif;
            font-size: 1.1rem;
            font-style: italic;
            color: var(--text);
            line-height: 1.7;
            padding: 1rem;
            background: var(--bg);
            border-left: 3px solid var(--accent-tertiary);
            border-radius: 0 8px 8px 0;
            margin-bottom: 0.75rem;
        }
        .extrait-source {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        .extrait-source strong {
            color: var(--text);
        }
        .extrait-commentary {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
        }
        .extrait-actions {
            display: flex;
            gap: 1.5rem;
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
        }
        .extrait-action {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            background: none;
            border: none;
            color: var(--muted);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            padding: 0.3rem 0;
        }
        .extrait-action:hover { color: var(--text); }
        .extrait-action.liked { color: var(--accent); }
        .extrait-action .icon { font-size: 1.1rem; }
        
        /* Empty social feed */
        .social-empty {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--muted);
        }
        .social-empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }
        .social-empty-title {
            font-size: 1rem;
            color: var(--text);
            margin-bottom: 0.5rem;
        }
        .social-empty-text {
            font-size: 0.85rem;
        }
        
        /* Profile section in sidebar */
        .profile-section {
            background: var(--bg-elevated);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .profile-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }
        .profile-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), var(--accent-purple));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }
        .profile-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text);
        }
        .profile-stats {
            display: flex;
            gap: 1rem;
            font-size: 0.75rem;
            color: var(--muted);
        }
        .profile-stat strong {
            color: var(--text);
        }
        .login-prompt {
            text-align: center;
            padding: 0.75rem;
        }
        .login-prompt-text {
            font-size: 0.8rem;
            color: var(--muted);
            margin-bottom: 0.75rem;
        }
        .login-prompt-btn {
            background: var(--accent);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .login-prompt-btn:hover { background: #ff4757; }
    </style>
</head>
<body>
    <div class="progress" id="progress"></div>
    
    <div class="stats-panel">
        <div class="stats-logo">PALIMPSESTE</div>
        
        <!-- Section Profil Social -->
        <div id="profileSection" class="profile-section">
            <div id="profileLoggedOut" class="login-prompt">
                <div class="login-prompt-text">üê¶ Rejoignez la communaut√© pour partager vos extraits pr√©f√©r√©s</div>
                <button class="login-prompt-btn" onclick="openAuthModal('login')">Se connecter</button>
            </div>
            <div id="profileLoggedIn" style="display:none;">
                <div class="profile-header">
                    <div class="profile-avatar" id="sidebarAvatar">üë§</div>
                    <div>
                        <div class="profile-name" id="sidebarUsername">Utilisateur</div>
                        <div class="profile-stats">
                            <span class="profile-stat"><strong id="myExtraitsCount">0</strong> extraits</span>
                            <span class="profile-stat"><strong id="myLikesCount">0</strong> likes</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="stats-section">
            <h3>üé≤ Votre d√©rive</h3>
            <div class="big-number" id="totalRead">0</div>
            <div class="big-number-label">textes travers√©s</div>
            <div class="mini-stats">
                <div class="mini-stat">
                    <div class="mini-stat-value" id="likeCountPanel">0</div>
                    <div class="mini-stat-label">coups de ‚ù§Ô∏è</div>
                </div>
                <div class="mini-stat">
                    <div class="mini-stat-value" id="authorCount">0</div>
                    <div class="mini-stat-label">auteurs</div>
                </div>
            </div>
            <div class="fun-stat" id="funStat"></div>
        </div>
        
        <div class="stats-section reading-stats-section">
            <h3>üìä Statistiques de lecture</h3>
            <div class="reading-stats-grid">
                <div class="reading-stat-item">
                    <div class="reading-stat-icon">‚è±Ô∏è</div>
                    <div class="reading-stat-value" id="totalReadingTime">0 min</div>
                    <div class="reading-stat-label">temps de lecture</div>
                </div>
                <div class="reading-stat-item">
                    <div class="reading-stat-icon">üìñ</div>
                    <div class="reading-stat-value" id="totalWordsRead">0</div>
                    <div class="reading-stat-label">mots lus</div>
                </div>
                <div class="reading-stat-item streak-item">
                    <div class="reading-stat-icon">üî•</div>
                    <div class="reading-stat-value" id="currentStreak">0</div>
                    <div class="reading-stat-label">jours d'affil√©e</div>
                </div>
            </div>
            <div class="streak-bar">
                <div class="streak-progress" id="streakProgress"></div>
            </div>
            <div class="streak-hint" id="streakHint">Lisez chaque jour pour maintenir votre streak !</div>
            <div class="weekly-chart" id="weeklyChart"></div>
        </div>
        
        <div class="stats-section">
            <h3>üó∫Ô∏è Territoire explor√©</h3>
            <div class="author-bars" id="authorBars"></div>
        </div>
        
        <div class="stats-section">
            <h3>Genres explor√©s</h3>
            <div class="genre-chart" id="genreChart"></div>
        </div>
        
        <div class="stats-section connections-section" id="connectionsSection" style="display:none;">
            <h3>ÔøΩÔ∏è Fils √† tirer</h3>
            <p class="connections-hint">Cliquez pour vous perdre...</p>
            <div class="connection-graph" id="connectionGraph"></div>
        </div>
        
        <div class="stats-section favorites-section" id="favoritesSection">
            <h3>üíé Mes favoris</h3>
            <div id="favoritesList"><div class="favorites-empty">Cliquez ‚ô• pour sauvegarder</div></div>
        </div>
        
        <div class="stats-section" id="achievementSection">
            <h3>üèÜ Badges</h3>
            <div class="achievements" id="achievementList"></div>
            <div class="reading-path" id="readingPath"></div>
        </div>
    </div>
    
    <header>
        <div class="header-inner">
            <div class="header-title" id="headerTitle">Laissez-vous d√©river...</div>
            
            <!-- Search Bar -->
            <div class="search-container">
                <div class="search-input-wrapper">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="search-input" id="searchInput" 
                           placeholder="Rechercher un auteur, un mot, un th√®me..." 
                           onkeydown="if(event.key==='Enter') performSearch()">
                    <button class="search-clear" id="searchClear" onclick="clearSearch()">‚úï</button>
                </div>
            </div>
            
            <div class="header-actions">
                <div class="lang-selector">
                    <span class="lang-icon">üåç</span>
                    <select class="lang-select" id="langSelect" onchange="changeLanguage(this.value)" title="Choisir les langues">
                        <option value="all">Toutes langues</option>
                        <option value="fr">üá´üá∑ Fran√ßais</option>
                        <option value="en">üá¨üáß English</option>
                        <option value="de">üá©üá™ Deutsch</option>
                        <option value="it">üáÆüáπ Italiano</option>
                        <option value="es">üá™üá∏ Espa√±ol</option>
                        <option value="pt">üáµüáπ Portugu√™s</option>
                        <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
                        <option value="la">üèõÔ∏è Latina</option>
                        <option value="zh">üá®üá≥ ‰∏≠Êñá</option>
                        <option value="ja">üáØüáµ Êó•Êú¨Ë™û</option>
                        <option value="ar">üá∏üá¶ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                        <option value="el">üá¨üá∑ ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨</option>
                    </select>
                </div>
                <button class="header-btn" onclick="shuffleFeed()" title="Effacer et recharger de nouveaux textes">üåä Refresh</button>
                <button class="header-btn" onclick="randomJump()" title="D√©couvrir un auteur au hasard">üé≤ Hasard</button>
                <button class="header-btn favorites-btn" onclick="openFavoritesView()" title="Voir tous mes favoris">‚ô• <span id="favCount">0</span></button>
                <button class="header-btn" onclick="openSocialFeed()" title="Voir le feed communautaire">üê¶ Social</button>
                <!-- User Menu -->
                <div class="user-menu" id="userMenu">
                    <div class="user-avatar" id="headerAvatar" onclick="toggleUserDropdown()">üë§</div>
                    <div class="user-dropdown" id="userDropdown">
                        <div class="user-dropdown-item" onclick="openAuthModal('login')" id="loginMenuItem">üîë Se connecter</div>
                        <div class="user-dropdown-item" onclick="openAuthModal('register')" id="registerMenuItem">‚úçÔ∏è Cr√©er un compte</div>
                        <div class="user-dropdown-item" onclick="openMyProfile()" id="profileMenuItem" style="display:none;">üë§ Mon profil</div>
                        <div class="user-dropdown-divider" id="logoutDivider" style="display:none;"></div>
                        <div class="user-dropdown-item danger" onclick="logoutUser()" id="logoutMenuItem" style="display:none;">üö™ D√©connexion</div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Navigateur de Cat√©gories (Arborescence) -->
        <div id="categoryNav" class="category-nav" style="display:none;">
            <div class="cat-breadcrumbs" id="catBreadcrumbs"></div>
            <div class="cat-subcategories" id="catSubcategories"></div>
            <button class="cat-close" onclick="closeCategoryMode()">‚úï Quitter l'exploration</button>
        </div>
    </header>
    
    <main id="feed"></main>
    <div id="recoBanner" class="reco-banner" style="display:none;">
        <div class="reco-content">
            <div class="reco-title">‚ú® Auteurs connexes √† d√©couvrir</div>
            <div class="reco-text">Bas√© sur vos lectures favorites</div>
            <div class="reco-authors" id="recoAuthors"></div>
        </div>
    </div>
    <div class="feed-loading" id="loading"><div class="spinner"></div><span>Exploration de Wikisource...</span></div>
    
    <div class="reader-overlay" id="reader">
        <div class="reader-header">
            <div class="reader-title" id="readerTitle">Texte complet</div>
            <button class="reader-close" onclick="closeReader()">‚úï</button>
        </div>
        <div class="reader-content" id="readerContent"></div>
    </div>
    
    <!-- Vue Favoris -->
    <div class="favorites-overlay" id="favoritesOverlay">
        <div class="favorites-view">
            <div class="favorites-header">
                <div class="favorites-title">‚ô• MES FAVORIS</div>
                <button class="reader-close" onclick="closeFavoritesView()">‚úï</button>
            </div>
            <div class="favorites-grid" id="favoritesGrid"></div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <!-- Modal d'authentification -->
    <div class="auth-modal" id="authModal">
        <div class="auth-box">
            <button class="auth-close" onclick="closeAuthModal()">‚úï</button>
            
            <!-- Login Form -->
            <div id="loginForm">
                <div class="auth-title">Bon retour üìö</div>
                <div class="auth-subtitle">Connectez-vous pour partager vos extraits</div>
                <div class="auth-error" id="loginError"></div>
                <input type="email" class="auth-input" id="loginEmail" placeholder="Email">
                <input type="password" class="auth-input" id="loginPassword" placeholder="Mot de passe">
                <button class="auth-btn" onclick="loginWithEmail()" id="loginBtn">Se connecter</button>
                <div class="auth-divider"><span>ou</span></div>
                <button class="auth-btn secondary" onclick="loginWithGoogle()">üåê Continuer avec Google</button>
                <div class="auth-switch">Pas encore de compte ? <a onclick="switchAuthForm('register')">S'inscrire</a></div>
            </div>
            
            <!-- Register Form -->
            <div id="registerForm" style="display:none;">
                <div class="auth-title">Bienvenue üåü</div>
                <div class="auth-subtitle">Cr√©ez votre compte pour rejoindre la communaut√©</div>
                <div class="auth-error" id="registerError"></div>
                <input type="text" class="auth-input" id="registerUsername" placeholder="Nom d'utilisateur">
                <input type="email" class="auth-input" id="registerEmail" placeholder="Email">
                <input type="password" class="auth-input" id="registerPassword" placeholder="Mot de passe (min. 6 caract√®res)">
                <button class="auth-btn" onclick="registerWithEmail()" id="registerBtn">Cr√©er mon compte</button>
                <div class="auth-divider"><span>ou</span></div>
                <button class="auth-btn secondary" onclick="loginWithGoogle()">üåê Continuer avec Google</button>
                <div class="auth-switch">D√©j√† un compte ? <a onclick="switchAuthForm('login')">Se connecter</a></div>
            </div>
        </div>
    </div>
    
    <!-- Modal de partage d'extrait -->
    <div class="share-modal" id="shareModal">
        <div class="share-box">
            <div class="share-header">
                <div class="share-title">üê¶ Partager cet extrait</div>
                <button class="auth-close" onclick="closeShareModal()">‚úï</button>
            </div>
            <div class="share-preview">
                <div class="share-preview-text" id="sharePreviewText"></div>
                <div class="share-preview-source" id="sharePreviewSource"></div>
            </div>
            <textarea class="share-commentary" id="shareCommentary" placeholder="Ajoutez un commentaire... (optionnel)"></textarea>
            <div class="share-actions">
                <button class="share-btn secondary" onclick="closeShareModal()">Annuler</button>
                <button class="share-btn primary" onclick="publishExtrait()" id="publishBtn">üöÄ Publier</button>
            </div>
        </div>
    </div>
    
    <!-- Overlay Feed Social -->
    <div class="favorites-overlay" id="socialOverlay">
        <div class="favorites-view">
            <div class="favorites-header">
                <div class="favorites-title">üê¶ FEED COMMUNAUTAIRE</div>
                <button class="reader-close" onclick="closeSocialFeed()">‚úï</button>
            </div>
            <div class="feed-tabs">
                <button class="feed-tab active" onclick="switchSocialTab('recent')" id="tabRecent">üî• R√©cents</button>
                <button class="feed-tab" onclick="switchSocialTab('friends')" id="tabFriends">üë• Amis</button>
                <button class="feed-tab" onclick="switchSocialTab('followers')" id="tabFollowers">üíå Abonn√©s</button>
                <button class="feed-tab" onclick="switchSocialTab('popular')" id="tabPopular">‚≠ê Populaires</button>
                <button class="feed-tab" onclick="switchSocialTab('discover')" id="tabDiscover">üîé D√©couvrir</button>
                <button class="feed-tab" onclick="switchSocialTab('mine')" id="tabMine">üë§ Mes extraits</button>
                <button class="feed-refresh" onclick="refreshFeed()" id="refreshBtn" title="Actualiser">üîÑ</button>
            </div>
            <div class="feed-live-indicator" id="liveIndicator">üü¢ En direct</div>
            <div id="socialFeed"></div>
        </div>
    </div>

    <!-- Modal Profil Utilisateur -->
    <div class="user-profile-modal" id="userProfileModal" onclick="if(event.target === this) closeUserProfile()">
        <div class="user-profile-content">
            <div class="profile-header">
                <div class="profile-avatar-large" id="profileAvatar">?</div>
                <div class="profile-info">
                    <h3 id="profileUsername">Utilisateur</h3>
                    <div class="profile-stats">
                        <span class="profile-stat"><strong id="profileFollowers">0</strong> abonn√©s</span>
                        <span class="profile-stat"><strong id="profileFollowing">0</strong> abonnements</span>
                        <span class="profile-stat"><strong id="profileExtraits">0</strong> extraits</span>
                    </div>
                </div>
            </div>
            <div class="profile-actions">
                <button class="btn-follow-large" id="profileFollowBtn" onclick="toggleFollowFromProfile()">Suivre</button>
                <button class="btn-close-profile" onclick="closeUserProfile()">Fermer</button>
            </div>
            <div class="friends-list" id="profileFollowersList" style="display:none;">
                <h4>üë• Abonn√©s (te suivent)</h4>
                <div id="followersListContent"></div>
            </div>
            <div class="friends-list" id="profileFriendsList" style="display:none;">
                <h4>üì§ Abonnements (que tu suis)</h4>
                <div id="friendsListContent"></div>
            </div>
        </div>
    </div>

    <!-- Search Results Overlay -->
    <div class="search-results-overlay" id="searchResultsOverlay" onclick="if(event.target === this) closeSearchResults()">
        <div class="search-results-container">
            <div class="search-results-header">
                <div class="search-results-title">
                    üîç R√©sultats pour "<span class="search-results-query" id="searchQueryDisplay"></span>"
                </div>
                <button class="search-results-close" onclick="closeSearchResults()">‚úï</button>
            </div>
            <div class="search-results-tabs" id="searchResultsTabs"></div>
            <div class="search-results-grid" id="searchResultsGrid"></div>
        </div>
    </div>

    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üê¶ SUPABASE - Configuration Social
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        const SUPABASE_URL = 'https://cqoepdrqifilqxnvflyy.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNxb2VwZHJxaWZpbHF4bnZmbHl5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxNzQxMTksImV4cCI6MjA4NDc1MDExOX0.e7dJmzUEgzDIix12ca38HvBmF7Cgp_fTZPT6gZ6Xy5s';
        
        // Client Supabase (initialis√© si configur√©)
        let supabaseClient = null;
        let currentUser = null;
        let socialExtraits = [];
        let currentSocialTab = 'recent';
        
        // V√©rifie si Supabase est configur√©
        function isSupabaseConfigured() {
            return SUPABASE_URL !== 'YOUR_SUPABASE_URL' && SUPABASE_ANON_KEY !== 'YOUR_SUPABASE_ANON_KEY';
        }
        
        // Initialise Supabase si configur√©
        function initSupabase() {
            if (!isSupabaseConfigured()) {
                console.log('‚ö†Ô∏è Supabase non configur√© - Mode local uniquement');
                return false;
            }
            try {
                // V√©rifier que le SDK est charg√©
                if (typeof window.supabase === 'undefined') {
                    console.warn('‚ö†Ô∏è SDK Supabase pas encore charg√© - retry dans 500ms');
                    // R√©essayer dans 500ms (le SDK est en async)
                    setTimeout(initSupabase, 500);
                    return false;
                }
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('‚úÖ Supabase initialis√©');
                
                // √âcouter les changements d'auth
                supabaseClient.auth.onAuthStateChange((event, session) => {
                    console.log('Auth event:', event);
                    if (session?.user) {
                        currentUser = session.user;
                        onUserLoggedIn();
                    } else {
                        currentUser = null;
                        onUserLoggedOut();
                    }
                });
                
                // V√©rifier si d√©j√† connect√©
                checkSession();
                return true;
            } catch (e) {
                console.error('Erreur init Supabase:', e);
                return false;
            }
        }
        
        async function checkSession() {
            if (!supabaseClient) return;
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session?.user) {
                currentUser = session.user;
                onUserLoggedIn();
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üîê AUTHENTIFICATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        function openAuthModal(mode = 'login') {
            document.getElementById('authModal').classList.add('open');
            switchAuthForm(mode);
            closeUserDropdown();
        }
        
        function closeAuthModal() {
            document.getElementById('authModal').classList.remove('open');
            // Reset errors
            document.getElementById('loginError').classList.remove('show');
            document.getElementById('registerError').classList.remove('show');
        }
        
        function switchAuthForm(mode) {
            document.getElementById('loginForm').style.display = mode === 'login' ? 'block' : 'none';
            document.getElementById('registerForm').style.display = mode === 'register' ? 'block' : 'none';
        }
        
        async function loginWithEmail() {
            if (!supabaseClient) {
                showAuthError('login', 'Supabase non configur√©. Voir console pour instructions.');
                return;
            }
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showAuthError('login', 'Veuillez remplir tous les champs');
                return;
            }
            
            document.getElementById('loginBtn').disabled = true;
            
            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
            
            document.getElementById('loginBtn').disabled = false;
            
            if (error) {
                showAuthError('login', error.message);
            } else {
                closeAuthModal();
                toast('‚úÖ Connexion r√©ussie !');
            }
        }
        
        async function registerWithEmail() {
            if (!supabaseClient) {
                showAuthError('register', 'Supabase non configur√©. Voir console pour instructions.');
                return;
            }
            
            const username = document.getElementById('registerUsername').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            
            if (!username || !email || !password) {
                showAuthError('register', 'Veuillez remplir tous les champs');
                return;
            }
            
            if (password.length < 6) {
                showAuthError('register', 'Le mot de passe doit faire au moins 6 caract√®res');
                return;
            }
            
            document.getElementById('registerBtn').disabled = true;
            
            const { data, error } = await supabaseClient.auth.signUp({
                email,
                password,
                options: {
                    data: { username }
                }
            });
            
            document.getElementById('registerBtn').disabled = false;
            
            if (error) {
                showAuthError('register', error.message);
            } else {
                // Cr√©er le profil utilisateur
                await createUserProfile(data.user.id, username);
                closeAuthModal();
                toast('üéâ Compte cr√©√© ! V√©rifiez votre email.');
            }
        }
        
        async function loginWithGoogle() {
            if (!supabaseClient) {
                toast('‚ö†Ô∏è Supabase non configur√©');
                return;
            }
            
            const { data, error } = await supabaseClient.auth.signInWithOAuth({
                provider: 'google',
                options: {
                    redirectTo: window.location.origin
                }
            });
            
            if (error) {
                toast('‚ùå Erreur: ' + error.message);
            }
        }
        
        async function logoutUser() {
            if (!supabaseClient) return;
            
            await supabaseClient.auth.signOut();
            closeUserDropdown();
            toast('üëã D√©connect√©');
        }
        
        function showAuthError(form, message) {
            const el = document.getElementById(form + 'Error');
            el.textContent = message;
            el.classList.add('show');
        }
        
        async function createUserProfile(userId, username) {
            if (!supabaseClient) return;
            
            // Utiliser upsert pour mettre √† jour si le profil existe d√©j√† (cr√©√© par le trigger)
            await supabaseClient.from('profiles').upsert({
                id: userId,
                username: username,
                created_at: new Date().toISOString()
            }, { onConflict: 'id' });
        }
        
        // Callbacks auth
        function onUserLoggedIn() {
            const username = currentUser.user_metadata?.username || currentUser.email?.split('@')[0] || 'Utilisateur';
            const initial = username.charAt(0).toUpperCase();
            
            // Update header
            document.getElementById('headerAvatar').innerHTML = initial;
            document.getElementById('loginMenuItem').style.display = 'none';
            document.getElementById('registerMenuItem').style.display = 'none';
            document.getElementById('profileMenuItem').style.display = 'block';
            document.getElementById('logoutDivider').style.display = 'block';
            document.getElementById('logoutMenuItem').style.display = 'block';
            
            // Update sidebar
            document.getElementById('profileLoggedOut').style.display = 'none';
            document.getElementById('profileLoggedIn').style.display = 'block';
            document.getElementById('sidebarAvatar').innerHTML = initial;
            document.getElementById('sidebarUsername').textContent = username;
            
            // Load user stats
            loadUserStats();
        }
        
        function onUserLoggedOut() {
            document.getElementById('headerAvatar').innerHTML = 'üë§';
            document.getElementById('loginMenuItem').style.display = 'block';
            document.getElementById('registerMenuItem').style.display = 'block';
            document.getElementById('profileMenuItem').style.display = 'none';
            document.getElementById('logoutDivider').style.display = 'none';
            document.getElementById('logoutMenuItem').style.display = 'none';
            
            document.getElementById('profileLoggedOut').style.display = 'block';
            document.getElementById('profileLoggedIn').style.display = 'none';
        }
        
        function toggleUserDropdown() {
            document.getElementById('userDropdown').classList.toggle('open');
        }
        
        function closeUserDropdown() {
            document.getElementById('userDropdown').classList.remove('open');
        }
        
        // Fermer dropdown si clic ailleurs
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.user-menu')) {
                closeUserDropdown();
            }
        });
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üì§ PARTAGE D'EXTRAITS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        let pendingShare = null;
        
        function openShareModal(text, author, title, sourceUrl) {
            if (!currentUser) {
                openAuthModal('login');
                toast('üìù Connectez-vous pour partager');
                return;
            }
            
            pendingShare = { text, author, title, sourceUrl };
            
            document.getElementById('sharePreviewText').textContent = text.length > 300 
                ? text.substring(0, 300) + '...' 
                : text;
            document.getElementById('sharePreviewSource').textContent = `‚Äî ${author}, ${title}`;
            document.getElementById('shareCommentary').value = '';
            document.getElementById('shareModal').classList.add('open');
        }
        
        function closeShareModal() {
            document.getElementById('shareModal').classList.remove('open');
            pendingShare = null;
        }
        
        async function publishExtrait() {
            if (!supabaseClient || !currentUser || !pendingShare) {
                toast('‚ö†Ô∏è Impossible de publier');
                return;
            }
            
            document.getElementById('publishBtn').disabled = true;
            
            const commentary = document.getElementById('shareCommentary').value.trim();
            
            const { data, error } = await supabaseClient.from('extraits').insert({
                user_id: currentUser.id,
                texte: pendingShare.text.substring(0, 1000), // Limite 1000 chars
                source_title: pendingShare.title,
                source_author: pendingShare.author,
                source_url: pendingShare.sourceUrl || '',
                commentary: commentary || null,
                likes_count: 0,
                created_at: new Date().toISOString()
            });
            
            document.getElementById('publishBtn').disabled = false;
            
            if (error) {
                toast('‚ùå Erreur: ' + error.message);
            } else {
                closeShareModal();
                toast('üê¶ Extrait publi√© !');
                loadUserStats();
            }
        }
        
        // Fonction pour ajouter un bouton de partage sur la s√©lection
        function setupTextSelection(cardElement, author, title, sourceUrl) {
            const textElement = cardElement.querySelector('.card-body');
            if (!textElement) return;
            
            textElement.classList.add('text-selectable');
            
            textElement.addEventListener('mouseup', () => {
                const selection = window.getSelection();
                const selectedText = selection.toString().trim();
                
                if (selectedText.length >= 20 && selectedText.length <= 1000) {
                    // Montrer un tooltip ou bouton flottant
                    showShareTooltip(selectedText, author, title, sourceUrl);
                }
            });
        }
        
        let shareTooltip = null;
        
        function showShareTooltip(text, author, title, sourceUrl) {
            hideShareTooltip();
            
            const selection = window.getSelection();
            if (!selection.rangeCount) return;
            
            const range = selection.getRangeAt(0);
            const rect = range.getBoundingClientRect();
            
            shareTooltip = document.createElement('div');
            shareTooltip.className = 'share-tooltip';
            shareTooltip.innerHTML = `<button onclick="openShareModal('${text.replace(/'/g, "\\'")}', '${author}', '${title}', '${sourceUrl}')">üê¶ Partager</button>`;
            shareTooltip.style.cssText = `
                position: fixed;
                top: ${rect.top - 40}px;
                left: ${rect.left + rect.width/2 - 50}px;
                background: var(--accent-tertiary);
                color: white;
                padding: 0.5rem 1rem;
                border-radius: 8px;
                z-index: 1000;
                cursor: pointer;
                font-size: 0.85rem;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            document.body.appendChild(shareTooltip);
            
            // Auto-hide apr√®s 5s
            setTimeout(hideShareTooltip, 5000);
        }
        
        function hideShareTooltip() {
            if (shareTooltip) {
                shareTooltip.remove();
                shareTooltip = null;
            }
        }
        
        document.addEventListener('mousedown', (e) => {
            if (!e.target.closest('.share-tooltip')) {
                hideShareTooltip();
            }
        });
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üì± FEED SOCIAL
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        let feedSubscription = null;
        let likesSubscription = null;
        let lastFeedUpdate = null;
        
        function openSocialFeed() {
            document.getElementById('socialOverlay').classList.add('open');
            loadSocialFeed();
            setupRealtimeSubscriptions();
        }
        
        function closeSocialFeed() {
            document.getElementById('socialOverlay').classList.remove('open');
            // Cleanup subscriptions when closing
            if (feedSubscription) {
                supabaseClient.removeChannel(feedSubscription);
                feedSubscription = null;
            }
            if (likesSubscription) {
                supabaseClient.removeChannel(likesSubscription);
                likesSubscription = null;
            }
        }
        
        // Setup realtime subscriptions
        function setupRealtimeSubscriptions() {
            if (!supabaseClient || feedSubscription) return;
            
            // Subscribe to new extraits
            feedSubscription = supabaseClient
                .channel('extraits-changes')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'extraits' },
                    (payload) => {
                        console.log('üì® Nouveau changement extraits:', payload);
                        showNewContentIndicator();
                    }
                )
                .subscribe();
            
            // Subscribe to likes changes
            likesSubscription = supabaseClient
                .channel('likes-changes')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'likes' },
                    (payload) => {
                        console.log('‚ù§Ô∏è Nouveau changement likes:', payload);
                        showNewContentIndicator();
                    }
                )
                .subscribe();
            
            console.log('üî¥ Subscriptions realtime activ√©es');
        }
        
        function showNewContentIndicator() {
            const indicator = document.getElementById('liveIndicator');
            indicator.textContent = 'üîî Nouveau contenu disponible - Cliquez pour actualiser';
            indicator.classList.add('new-content');
            indicator.onclick = () => refreshFeed();
        }
        
        async function refreshFeed() {
            const btn = document.getElementById('refreshBtn');
            const indicator = document.getElementById('liveIndicator');
            
            btn.classList.add('spinning');
            indicator.textContent = 'üü¢ En direct';
            indicator.classList.remove('new-content');
            indicator.onclick = null;
            
            await loadSocialFeed();
            
            setTimeout(() => btn.classList.remove('spinning'), 500);
            toast('üîÑ Feed actualis√© !');
        }
        
        function switchSocialTab(tab) {
            currentSocialTab = tab;
            document.querySelectorAll('.feed-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
            loadSocialFeed();
        }
        
        async function loadSocialFeed() {
            const container = document.getElementById('socialFeed');
            
            if (!isSupabaseConfigured()) {
                container.innerHTML = `
                    <div class="social-empty">
                        <div class="social-empty-icon">‚öôÔ∏è</div>
                        <div class="social-empty-title">Configuration requise</div>
                        <div class="social-empty-text">
                            Pour activer le feed social, configurez Supabase:<br><br>
                            1. Cr√©ez un compte sur <a href="https://supabase.com" target="_blank" style="color:var(--accent)">supabase.com</a><br>
                            2. Cr√©ez un nouveau projet<br>
                            3. Copiez l'URL et la cl√© anon<br>
                            4. Remplacez les valeurs dans le code<br><br>
                            <code style="background:var(--bg);padding:0.5rem;border-radius:4px;display:block;margin-top:1rem;font-size:0.75rem;">
                            const SUPABASE_URL = 'votre_url';<br>
                            const SUPABASE_ANON_KEY = 'votre_cl√©';
                            </code>
                        </div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '<div class="feed-loading"><div class="spinner"></div><span>Chargement...</span></div>';
            
            let query = supabaseClient
                .from('extraits')
                .select('*, profiles(username)')
                .order('created_at', { ascending: false })
                .limit(50);
            
            if (currentSocialTab === 'popular') {
                // Pour les populaires, on charge tous les extraits puis on trie par vrais likes
                const { data: allExtraits } = await supabaseClient
                    .from('extraits')
                    .select('*, profiles(username)')
                    .limit(100);
                
                if (allExtraits && allExtraits.length > 0) {
                    // Compter les vrais likes pour chaque extrait
                    const { data: allLikes } = await supabaseClient
                        .from('likes')
                        .select('extrait_id');
                    
                    const likeCounts = {};
                    if (allLikes) {
                        allLikes.forEach(like => {
                            likeCounts[like.extrait_id] = (likeCounts[like.extrait_id] || 0) + 1;
                        });
                    }
                    
                    // Trier par nombre de likes r√©els
                    socialExtraits = allExtraits
                        .map(e => ({ ...e, realLikes: likeCounts[e.id] || 0 }))
                        .sort((a, b) => b.realLikes - a.realLikes)
                        .slice(0, 50);
                    
                    renderSocialFeed();
                    return;
                }
                
                container.innerHTML = `
                    <div class="social-empty">
                        <div class="social-empty-icon">üì≠</div>
                        <div class="social-empty-title">Aucun extrait populaire</div>
                        <div class="social-empty-text">Soyez le premier √† partager et recevoir des likes !</div>
                    </div>
                `;
                return;
            } else if (currentSocialTab === 'mine' && currentUser) {
                query = supabaseClient
                    .from('extraits')
                    .select('*, profiles(username)')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });
            } else if (currentSocialTab === 'friends' && currentUser) {
                // Charger les extraits des amis
                await loadUserFollowing();
                
                if (userFollowing.size === 0) {
                    container.innerHTML = `
                        <div class="social-empty">
                            <div class="social-empty-icon">üë•</div>
                            <div class="social-empty-title">Aucun ami suivi</div>
                            <div class="social-empty-text">
                                Vous ne suivez personne pour l'instant.<br>
                                Allez dans l'onglet "üîé D√©couvrir" pour trouver des utilisateurs !
                            </div>
                        </div>
                    `;
                    return;
                }
                
                query = supabaseClient
                    .from('extraits')
                    .select('*, profiles(username)')
                    .in('user_id', Array.from(userFollowing))
                    .order('created_at', { ascending: false })
                    .limit(50);
            } else if (currentSocialTab === 'discover') {
                // Afficher tous les utilisateurs actifs
                await loadUserFollowing();
                await loadDiscoverUsers();
                return;
            } else if (currentSocialTab === 'followers') {
                // Afficher mes abonn√©s (qui me suivent)
                await loadMyFollowers();
                return;
            }
            
            const { data, error } = await query;
            
            if (error) {
                container.innerHTML = `<div class="social-empty">‚ùå Erreur: ${error.message}</div>`;
                return;
            }
            
            if (!data || data.length === 0) {
                container.innerHTML = `
                    <div class="social-empty">
                        <div class="social-empty-icon">üì≠</div>
                        <div class="social-empty-title">Aucun extrait</div>
                        <div class="social-empty-text">
                            ${currentSocialTab === 'mine' 
                                ? "Vous n'avez pas encore partag√© d'extraits. S√©lectionnez du texte dans une lecture pour partager !"
                                : "Soyez le premier √† partager un extrait !"}
                        </div>
                    </div>
                `;
                return;
            }
            
            socialExtraits = data;
            renderSocialFeed();
        }
        
        async function renderSocialFeed() {
            const container = document.getElementById('socialFeed');
            
            // Charger les likes et follows de l'utilisateur
            let userLikes = new Set();
            let likeCounts = {};
            
            if (supabaseClient) {
                // Compter les vrais likes pour chaque extrait depuis la table likes
                const extraitIds = socialExtraits.map(e => e.id);
                const { data: allLikes } = await supabaseClient
                    .from('likes')
                    .select('extrait_id')
                    .in('extrait_id', extraitIds);
                
                // Compter les likes par extrait
                if (allLikes) {
                    allLikes.forEach(like => {
                        likeCounts[like.extrait_id] = (likeCounts[like.extrait_id] || 0) + 1;
                    });
                }
                
                if (currentUser) {
                    const { data } = await supabaseClient
                        .from('likes')
                        .select('extrait_id')
                        .eq('user_id', currentUser.id);
                    userLikes = new Set(data?.map(l => l.extrait_id) || []);
                    
                    // Charger les follows si pas d√©j√† fait
                    await loadUserFollowing();
                }
            }
            
            container.innerHTML = socialExtraits.map(extrait => {
                const username = extrait.profiles?.username || 'Anonyme';
                const initial = username.charAt(0).toUpperCase();
                const timeAgo = formatTimeAgo(new Date(extrait.created_at));
                const isLiked = userLikes.has(extrait.id);
                const realLikeCount = likeCounts[extrait.id] || 0;
                
                return `
                    <div class="extrait-card" data-id="${extrait.id}">
                        <div class="extrait-header">
                            <div class="extrait-avatar" onclick="openUserProfile('${extrait.user_id}', '${username}')" style="cursor:pointer">${initial}</div>
                            <div class="extrait-user-info" onclick="openUserProfile('${extrait.user_id}', '${username}')" style="cursor:pointer">
                                <div class="extrait-username">${username}</div>
                                <div class="extrait-time">${timeAgo}</div>
                            </div>
                            ${currentUser && extrait.user_id !== currentUser.id ? `
                                <button class="btn-follow-small ${userFollowing.has(extrait.user_id) ? 'following' : ''}" onclick="toggleFollow('${extrait.user_id}', event)">
                                    ${userFollowing.has(extrait.user_id) ? '‚úì Suivi' : '+ Suivre'}
                                </button>
                            ` : ''}
                        </div>
                        <div class="extrait-text">${escapeHtml(extrait.texte)}</div>
                        <div class="extrait-source">
                            <strong>${escapeHtml(extrait.source_author)}</strong> ‚Äî ${escapeHtml(extrait.source_title)}
                        </div>
                        ${extrait.commentary ? `<div class="extrait-commentary">${escapeHtml(extrait.commentary)}</div>` : ''}
                        <div class="extrait-actions">
                            <button class="extrait-action ${isLiked ? 'liked' : ''}" onclick="toggleLikeExtrait('${extrait.id}')">
                                <span class="icon">${isLiked ? '‚ù§Ô∏è' : 'ü§ç'}</span>
                                <span>${realLikeCount}</span>
                            </button>
                            <button class="extrait-action" onclick="copyExtrait('${extrait.id}')">
                                <span class="icon">üìã</span>
                                <span>Copier</span>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function toggleLikeExtrait(extraitId) {
            if (!currentUser) {
                openAuthModal('login');
                toast('üìù Connectez-vous pour liker');
                return;
            }
            
            if (!supabaseClient) return;
            
            try {
                // V√©rifier si d√©j√† lik√©
                const { data: existing, error: checkError } = await supabaseClient
                    .from('likes')
                    .select('id')
                    .eq('user_id', currentUser.id)
                    .eq('extrait_id', extraitId)
                    .single();
                
                if (existing) {
                    // Unlike
                    const { error: deleteError } = await supabaseClient
                        .from('likes')
                        .delete()
                        .eq('id', existing.id);
                    
                    if (deleteError) {
                        console.error('Erreur unlike:', deleteError);
                        toast('‚ùå Erreur lors du unlike');
                        return;
                    }
                    
                    // Mettre √† jour le compteur
                    const { data: extrait } = await supabaseClient
                        .from('extraits')
                        .select('likes_count')
                        .eq('id', extraitId)
                        .single();
                    
                    await supabaseClient
                        .from('extraits')
                        .update({ likes_count: Math.max(0, (extrait?.likes_count || 1) - 1) })
                        .eq('id', extraitId);
                    
                    toast('üíî Like retir√©');
                } else {
                    // Like
                    const { error: insertError } = await supabaseClient
                        .from('likes')
                        .insert({
                            user_id: currentUser.id,
                            extrait_id: extraitId,
                            created_at: new Date().toISOString()
                        });
                    
                    if (insertError) {
                        console.error('Erreur like:', insertError);
                        toast('‚ùå Erreur lors du like');
                        return;
                    }
                    
                    // Mettre √† jour le compteur
                    const { data: extrait } = await supabaseClient
                        .from('extraits')
                        .select('likes_count')
                        .eq('id', extraitId)
                        .single();
                    
                    await supabaseClient
                        .from('extraits')
                        .update({ likes_count: (extrait?.likes_count || 0) + 1 })
                        .eq('id', extraitId);
                    
                    toast('‚ù§Ô∏è Lik√© !');
                }
                
                // Refresh
                loadSocialFeed();
            } catch (err) {
                console.error('Erreur toggle like:', err);
                toast('‚ùå Erreur');
            }
        }
        
        function copyExtrait(extraitId) {
            const extrait = socialExtraits.find(e => e.id === extraitId);
            if (!extrait) return;
            
            const text = `"${extrait.texte}"\n‚Äî ${extrait.source_author}, ${extrait.source_title}`;
            navigator.clipboard.writeText(text);
            toast('üìã Extrait copi√© !');
        }
        
        async function loadUserStats() {
            if (!supabaseClient || !currentUser) return;
            
            // Compter les extraits
            const { count: extraitCount } = await supabaseClient
                .from('extraits')
                .select('*', { count: 'exact', head: true })
                .eq('user_id', currentUser.id);
            
            // Compter les likes re√ßus
            const { data: myExtraits } = await supabaseClient
                .from('extraits')
                .select('likes_count')
                .eq('user_id', currentUser.id);
            
            const totalLikes = myExtraits?.reduce((sum, e) => sum + (e.likes_count || 0), 0) || 0;
            
            document.getElementById('myExtraitsCount').textContent = extraitCount || 0;
            document.getElementById('myLikesCount').textContent = totalLikes;
        }
        
        // Helpers
        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return '√Ä l\'instant';
            if (seconds < 3600) return Math.floor(seconds / 60) + ' min';
            if (seconds < 86400) return Math.floor(seconds / 3600) + ' h';
            if (seconds < 604800) return Math.floor(seconds / 86400) + ' j';
            return date.toLocaleDateString('fr-FR');
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function openMyProfile() {
            closeUserDropdown();
            switchSocialTab('mine');
            openSocialFeed();
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üë• SYST√àME D'AMIS (FOLLOWERS)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        let currentProfileUserId = null;
        let userFollowing = new Set(); // IDs des personnes qu'on suit
        
        // Charger la liste des personnes qu'on suit
        async function loadUserFollowing() {
            if (!currentUser || !supabaseClient) return;
            
            const { data } = await supabaseClient
                .from('follows')
                .select('following_id')
                .eq('follower_id', currentUser.id);
            
            userFollowing = new Set(data?.map(f => f.following_id) || []);
        }
        
        // Charger et afficher les utilisateurs √† d√©couvrir
        async function loadDiscoverUsers() {
            const container = document.getElementById('socialFeed');
            
            if (!supabaseClient) {
                container.innerHTML = '<div class="social-empty">‚ö†Ô∏è Non connect√©</div>';
                return;
            }
            
            // R√©cup√©rer tous les profils avec leur nombre d'extraits
            const { data: profiles, error } = await supabaseClient
                .from('profiles')
                .select('id, username, created_at')
                .order('created_at', { ascending: false })
                .limit(50);
            
            if (error || !profiles) {
                container.innerHTML = '<div class="social-empty">‚ùå Erreur lors du chargement</div>';
                return;
            }
            
            // Compter les extraits pour chaque profil
            const profilesWithStats = await Promise.all(profiles.map(async (p) => {
                const { count } = await supabaseClient
                    .from('extraits')
                    .select('*', { count: 'exact', head: true })
                    .eq('user_id', p.id);
                return { ...p, extraitCount: count || 0 };
            }));
            
            // Filtrer pour ne pas s'afficher soi-m√™me
            const filteredProfiles = profilesWithStats.filter(p => 
                !currentUser || p.id !== currentUser.id
            );
            
            if (filteredProfiles.length === 0) {
                container.innerHTML = `
                    <div class="social-empty">
                        <div class="social-empty-icon">üå±</div>
                        <div class="social-empty-title">Pas encore d'utilisateurs</div>
                        <div class="social-empty-text">Soyez le premier √† inviter des amis !</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="discover-header">
                    <h3>üë• Utilisateurs √† d√©couvrir</h3>
                    <p>Suivez des personnes pour voir leurs extraits dans l'onglet "Amis"</p>
                </div>
                <div class="discover-grid">
                    ${filteredProfiles.map(p => {
                        const isFollowing = userFollowing.has(p.id);
                        const initial = (p.username || '?').charAt(0).toUpperCase();
                        return `
                            <div class="discover-card">
                                <div class="discover-avatar" onclick="openUserProfile('${p.id}', '${p.username}')">${initial}</div>
                                <div class="discover-info" onclick="openUserProfile('${p.id}', '${p.username}')">
                                    <div class="discover-name">${escapeHtml(p.username || 'Anonyme')}</div>
                                    <div class="discover-stats">${p.extraitCount} extrait${p.extraitCount > 1 ? 's' : ''}</div>
                                </div>
                                <button class="btn-follow-small ${isFollowing ? 'following' : ''}" onclick="toggleFollow('${p.id}', event)">
                                    ${isFollowing ? '‚úì Suivi' : '+ Suivre'}
                                </button>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        // Charger mes abonn√©s (les gens qui me suivent)
        async function loadMyFollowers() {
            const container = document.getElementById('socialFeed');
            
            if (!supabaseClient || !currentUser) {
                container.innerHTML = `
                    <div class="social-empty">
                        <div class="social-empty-icon">üîê</div>
                        <div class="social-empty-title">Connexion requise</div>
                        <div class="social-empty-text">Connectez-vous pour voir qui vous suit</div>
                    </div>
                `;
                return;
            }
            
            // R√©cup√©rer les followers
            const { data: followers, error } = await supabaseClient
                .from('follows')
                .select('follower_id, created_at, profiles!follows_follower_id_fkey(id, username)')
                .eq('following_id', currentUser.id)
                .order('created_at', { ascending: false });
            
            if (error) {
                container.innerHTML = '<div class="social-empty">‚ùå Erreur lors du chargement</div>';
                console.error('Erreur followers:', error);
                return;
            }
            
            if (!followers || followers.length === 0) {
                container.innerHTML = `
                    <div class="social-empty">
                        <div class="social-empty-icon">üíå</div>
                        <div class="social-empty-title">Pas encore d'abonn√©s</div>
                        <div class="social-empty-text">
                            Personne ne vous suit encore.<br>
                            Partagez des extraits pour attirer des lecteurs !
                        </div>
                    </div>
                `;
                return;
            }
            
            // Charger qui on suit
            await loadUserFollowing();
            
            container.innerHTML = `
                <div class="discover-header">
                    <h3>üíå Vos abonn√©s (${followers.length})</h3>
                    <p>Ces personnes vous suivent et voient vos extraits</p>
                </div>
                <div class="discover-grid">
                    ${followers.map(f => {
                        const username = f.profiles?.username || 'Anonyme';
                        const initial = username.charAt(0).toUpperCase();
                        const isFollowing = userFollowing.has(f.follower_id);
                        const followedAt = formatTimeAgo(new Date(f.created_at));
                        return `
                            <div class="discover-card">
                                <div class="discover-avatar" onclick="openUserProfile('${f.follower_id}', '${username}')">${initial}</div>
                                <div class="discover-info" onclick="openUserProfile('${f.follower_id}', '${username}')">
                                    <div class="discover-name">${escapeHtml(username)}</div>
                                    <div class="discover-stats">Vous suit depuis ${followedAt}</div>
                                </div>
                                <button class="btn-follow-small ${isFollowing ? 'following' : ''}" onclick="toggleFollow('${f.follower_id}', event)">
                                    ${isFollowing ? '‚úì Suivi' : '+ Suivre'}
                                </button>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        // Ouvrir le profil d'un utilisateur
        async function openUserProfile(userId, username) {
            if (!supabaseClient) return;
            
            currentProfileUserId = userId;
            
            // Charger les infos du profil
            const { data: profile } = await supabaseClient
                .from('profiles')
                .select('*')
                .eq('id', userId)
                .single();
            
            // Compter les extraits
            const { count: extraitCount } = await supabaseClient
                .from('extraits')
                .select('*', { count: 'exact', head: true })
                .eq('user_id', userId);
            
            // Compter followers/following
            const { count: followersCount } = await supabaseClient
                .from('follows')
                .select('*', { count: 'exact', head: true })
                .eq('following_id', userId);
            
            const { count: followingCount } = await supabaseClient
                .from('follows')
                .select('*', { count: 'exact', head: true })
                .eq('follower_id', userId);
            
            // Mettre √† jour l'UI
            const displayName = profile?.username || username || 'Anonyme';
            document.getElementById('profileAvatar').textContent = displayName.charAt(0).toUpperCase();
            document.getElementById('profileUsername').textContent = displayName;
            document.getElementById('profileFollowers').textContent = followersCount || 0;
            document.getElementById('profileFollowing').textContent = followingCount || 0;
            document.getElementById('profileExtraits').textContent = extraitCount || 0;
            
            // Bouton suivre
            const followBtn = document.getElementById('profileFollowBtn');
            if (currentUser && userId !== currentUser.id) {
                followBtn.style.display = 'block';
                const isFollowing = userFollowing.has(userId);
                followBtn.textContent = isFollowing ? 'Ne plus suivre' : 'Suivre';
                followBtn.classList.toggle('following', isFollowing);
            } else {
                followBtn.style.display = 'none';
            }
            
            // Charger les listes de followers et following
            await loadProfileFollowers(userId);
            await loadProfileFollowing(userId);
            
            // Ouvrir la modal
            document.getElementById('userProfileModal').classList.add('open');
        }
        
        // Charger les followers (personnes qui suivent cet utilisateur)
        async function loadProfileFollowers(userId) {
            if (!supabaseClient) return;
            
            const { data } = await supabaseClient
                .from('follows')
                .select('follower_id, profiles!follows_follower_id_fkey(username)')
                .eq('following_id', userId)
                .limit(20);
            
            const container = document.getElementById('followersListContent');
            const section = document.getElementById('profileFollowersList');
            
            if (!data || data.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            container.innerHTML = data.map(f => {
                const name = f.profiles?.username || 'Anonyme';
                return `
                    <div class="friend-item" onclick="openUserProfile('${f.follower_id}', '${name}')">
                        <div class="friend-avatar">${name.charAt(0).toUpperCase()}</div>
                        <span>${name}</span>
                    </div>
                `;
            }).join('');
        }
        
        // Charger les personnes suivies par un utilisateur
        async function loadProfileFollowing(userId) {
            if (!supabaseClient) return;
            
            const { data } = await supabaseClient
                .from('follows')
                .select('following_id, profiles!follows_following_id_fkey(username)')
                .eq('follower_id', userId)
                .limit(20);
            
            const container = document.getElementById('friendsListContent');
            const section = document.getElementById('profileFriendsList');
            
            if (!data || data.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            container.innerHTML = data.map(f => {
                const name = f.profiles?.username || 'Anonyme';
                return `
                    <div class="friend-item" onclick="openUserProfile('${f.following_id}', '${name}')">
                        <div class="friend-avatar">${name.charAt(0).toUpperCase()}</div>
                        <span>${name}</span>
                    </div>
                `;
            }).join('');
        }
        
        // Fermer la modal profil
        function closeUserProfile() {
            document.getElementById('userProfileModal').classList.remove('open');
            currentProfileUserId = null;
        }
        
        // Suivre/Ne plus suivre depuis la modal profil
        async function toggleFollowFromProfile() {
            if (!currentProfileUserId) return;
            await toggleFollow(currentProfileUserId);
            
            // Rafra√Æchir l'affichage
            const followBtn = document.getElementById('profileFollowBtn');
            const isNowFollowing = userFollowing.has(currentProfileUserId);
            followBtn.textContent = isNowFollowing ? 'Ne plus suivre' : 'Suivre';
            followBtn.classList.toggle('following', isNowFollowing);
            
            // Mettre √† jour le compteur followers
            const { count } = await supabaseClient
                .from('follows')
                .select('*', { count: 'exact', head: true })
                .eq('following_id', currentProfileUserId);
            document.getElementById('profileFollowers').textContent = count || 0;
        }
        
        // Suivre/Ne plus suivre un utilisateur
        async function toggleFollow(userId, event) {
            if (event) event.stopPropagation();
            
            if (!currentUser) {
                openAuthModal('login');
                toast('üìù Connectez-vous pour suivre');
                return;
            }
            
            if (!supabaseClient || userId === currentUser.id) return;
            
            const isFollowing = userFollowing.has(userId);
            
            if (isFollowing) {
                // Unfollow
                await supabaseClient
                    .from('follows')
                    .delete()
                    .eq('follower_id', currentUser.id)
                    .eq('following_id', userId);
                userFollowing.delete(userId);
                toast('üëã Vous ne suivez plus cet utilisateur');
            } else {
                // Follow
                await supabaseClient
                    .from('follows')
                    .insert({
                        follower_id: currentUser.id,
                        following_id: userId,
                        created_at: new Date().toISOString()
                    });
                userFollowing.add(userId);
                toast('‚úÖ Vous suivez maintenant cet utilisateur !');
            }
            
            // Rafra√Æchir le feed si on est sur l'onglet amis
            if (currentSocialTab === 'friends') {
                loadSocialFeed();
            }
        }
        
        // Fonction pour partager depuis une carte
        function shareCardExtrait(cardId) {
            const card = document.getElementById(cardId);
            if (!card) return;
            
            const text = card.dataset.text || '';
            const author = card.dataset.author || 'Inconnu';
            const title = card.dataset.title || 'Sans titre';
            
            // R√©cup√©rer la s√©lection si elle existe, sinon utiliser le teaser
            const selection = window.getSelection().toString().trim();
            const textToShare = selection.length >= 20 ? selection : text.substring(0, 500);
            
            // Construire l'URL Wikisource
            const lang = card.dataset.lang || 'fr';
            const sourceUrl = `https://${lang}.wikisource.org/wiki/${encodeURIComponent(title)}`;
            
            openShareModal(textToShare, author, title, sourceUrl);
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üåç CONFIGURATION MULTILINGUE - Litt√©rature mondiale
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const WIKISOURCES = [
            { lang: 'fr', name: 'Fran√ßais', url: 'https://fr.wikisource.org' },
            { lang: 'en', name: 'English', url: 'https://en.wikisource.org' },
            { lang: 'de', name: 'Deutsch', url: 'https://de.wikisource.org' },
            { lang: 'it', name: 'Italiano', url: 'https://it.wikisource.org' },
            { lang: 'es', name: 'Espa√±ol', url: 'https://es.wikisource.org' },
            { lang: 'pt', name: 'Portugu√™s', url: 'https://pt.wikisource.org' },
            { lang: 'ru', name: '–†—É—Å—Å–∫–∏–π', url: 'https://ru.wikisource.org' },
            { lang: 'la', name: 'Latina', url: 'https://la.wikisource.org' },
            { lang: 'zh', name: '‰∏≠Êñá', url: 'https://zh.wikisource.org' },
            { lang: 'ja', name: 'Êó•Êú¨Ë™û', url: 'https://ja.wikisource.org' },
            { lang: 'ar', name: 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©', url: 'https://ar.wikisource.org' },
            { lang: 'el', name: 'ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨', url: 'https://el.wikisource.org' },
        ];
        
        // Sources alternatives (APIs propres sans scories)
        const ALT_SOURCES = {
            poetrydb: {
                name: 'PoetryDB',
                url: 'https://poetrydb.org',
                lang: 'en',
                // Auteurs disponibles dans PoetryDB
                authors: ['Shakespeare', 'Emily Dickinson', 'William Blake', 'John Keats', 
                          'Percy Shelley', 'Lord Byron', 'William Wordsworth', 'Edgar Allan Poe',
                          'Walt Whitman', 'Robert Frost', 'Oscar Wilde', 'Alfred Tennyson']
            },
            gutenberg: {
                name: 'Project Gutenberg',
                url: 'https://www.gutenberg.org',
                // ≈íuvres populaires avec leurs IDs Gutenberg (domaine public)
                works: [
                    { id: 1342, title: 'Pride and Prejudice', author: 'Jane Austen', lang: 'en' },
                    { id: 11, title: 'Alice\'s Adventures in Wonderland', author: 'Lewis Carroll', lang: 'en' },
                    { id: 84, title: 'Frankenstein', author: 'Mary Shelley', lang: 'en' },
                    { id: 1661, title: 'The Adventures of Sherlock Holmes', author: 'Arthur Conan Doyle', lang: 'en' },
                    { id: 2701, title: 'Moby Dick', author: 'Herman Melville', lang: 'en' },
                    { id: 1232, title: 'The Prince', author: 'Niccol√≤ Machiavelli', lang: 'en' },
                    { id: 174, title: 'The Picture of Dorian Gray', author: 'Oscar Wilde', lang: 'en' },
                    { id: 345, title: 'Dracula', author: 'Bram Stoker', lang: 'en' },
                    { id: 1400, title: 'Great Expectations', author: 'Charles Dickens', lang: 'en' },
                    { id: 98, title: 'A Tale of Two Cities', author: 'Charles Dickens', lang: 'en' },
                    { id: 2600, title: 'War and Peace', author: 'Leo Tolstoy', lang: 'en' },
                    { id: 2554, title: 'Crime and Punishment', author: 'Fyodor Dostoevsky', lang: 'en' },
                    { id: 4300, title: 'Ulysses', author: 'James Joyce', lang: 'en' },
                    { id: 1080, title: 'A Modest Proposal', author: 'Jonathan Swift', lang: 'en' },
                    { id: 76, title: 'Adventures of Huckleberry Finn', author: 'Mark Twain', lang: 'en' },
                    { id: 74, title: 'The Adventures of Tom Sawyer', author: 'Mark Twain', lang: 'en' },
                    { id: 219, title: 'Heart of Darkness', author: 'Joseph Conrad', lang: 'en' },
                    { id: 5200, title: 'Metamorphosis', author: 'Franz Kafka', lang: 'en' },
                    { id: 1952, title: 'The Yellow Wallpaper', author: 'Charlotte Perkins Gilman', lang: 'en' },
                    { id: 120, title: 'Treasure Island', author: 'Robert Louis Stevenson', lang: 'en' },
                    // Fran√ßais
                    { id: 17489, title: 'Les Mis√©rables', author: 'Victor Hugo', lang: 'fr' },
                    { id: 13951, title: 'Le Comte de Monte-Cristo', author: 'Alexandre Dumas', lang: 'fr' },
                    { id: 14287, title: 'Les Trois Mousquetaires', author: 'Alexandre Dumas', lang: 'fr' },
                    { id: 4650, title: 'Du c√¥t√© de chez Swann', author: 'Marcel Proust', lang: 'fr' },
                    { id: 17396, title: 'Madame Bovary', author: 'Gustave Flaubert', lang: 'fr' },
                    { id: 13704, title: 'Le Rouge et le Noir', author: 'Stendhal', lang: 'fr' },
                    { id: 5053, title: 'Germinal', author: '√âmile Zola', lang: 'fr' },
                    // Autres langues
                    { id: 2000, title: 'Don Quixote', author: 'Miguel de Cervantes', lang: 'es' },
                    { id: 1012, title: 'The Divine Comedy', author: 'Dante Alighieri', lang: 'it' },
                    { id: 2229, title: 'The Sorrows of Young Werther', author: 'Johann Wolfgang von Goethe', lang: 'de' },
                    { id: 7849, title: 'Faust', author: 'Johann Wolfgang von Goethe', lang: 'de' }
                ]
            }
        };
        
        // Mots-cl√©s de recherche par langue (termes qui fonctionnent bien sur Wikisource)
        const SEARCH_TERMS = {
            fr: [
                'Les Fleurs du Mal', 'Fables de La Fontaine', 'Les Contemplations',
                'Baudelaire', 'Hugo po√®me', 'Verlaine', 'Rimbaud',
                'Maupassant nouvelle', 'Balzac', 'Zola chapitre',
                'Moli√®re acte', 'Racine trag√©die', 'La Fontaine fable',
                'Musset po√©sie', 'Lamartine m√©ditation', 'Nerval sonnet',
                'Flaubert', 'Stendhal', 'Voltaire conte'
            ],
            en: [
                'Shakespeare sonnet', 'Milton Paradise', 'Keats ode',
                'Byron poem', 'Shelley', 'Wordsworth', 'Blake songs',
                'Dickens chapter', 'Austen', 'Poe tale',
                'Whitman leaves', 'Dickinson poem', 'Tennyson'
            ],
            de: [
                'Goethe Faust', 'Schiller', 'Heine Gedicht',
                'Rilke', 'Novalis', 'H√∂lderlin', 'Grimm M√§rchen',
                'Kafka', 'Mann Kapitel', 'Nietzsche'
            ],
            it: [
                'Dante Divina', 'Petrarca sonetto', 'Leopardi canto',
                'Manzoni capitolo', 'Boccaccio novella', 'Ariosto',
                'Pirandello', 'Foscolo', 'Carducci'
            ],
            es: [
                'Cervantes Quijote', 'G√≥ngora soneto', 'Quevedo',
                'Lorca poema', 'Machado', 'B√©cquer rima',
                'Calder√≥n', 'Lope de Vega'
            ],
            pt: ['Cam√µes soneto', 'Pessoa poema', 'E√ßa de Queir√≥s', 'Machado de Assis'],
            ru: ['–ü—É—à–∫–∏–Ω —Å—Ç–∏—Ö–æ—Ç–≤–æ—Ä–µ–Ω–∏–µ', '–¢–æ–ª—Å—Ç–æ–π –≥–ª–∞–≤–∞', '–î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π', '–ß–µ—Ö–æ–≤ —Ä–∞—Å—Å–∫–∞–∑', '–õ–µ—Ä–º–æ–Ω—Ç–æ–≤'],
            la: ['Vergilius Aeneis', 'Horatius ode', 'Ovidius', 'Cicero', 'Catullus carmen'],
            zh: ['ÊùéÁôΩ Ë©©', 'ÊùúÁî´', 'ËòáËªæ', 'ÁôΩÂ±ÖÊòì'],
            ja: ['Ëä•Â∑ùÈæç‰πã‰ªã', 'Â§èÁõÆÊº±Áü≥', 'Â§™ÂÆ∞Ê≤ª', 'ÂÆÆÊ≤¢Ë≥¢Ê≤ª'],
            ar: ['ÿßŸÑŸÖÿ™ŸÜÿ®Ÿä ŸÇÿµŸäÿØÿ©', 'ÿ£ÿ®Ÿà ÿ™ŸÖÿßŸÖ', 'ÿßŸÑÿ®ÿ≠ÿ™ÿ±Ÿä'],
            el: ['ŒüŒºŒÆœÅŒøœÖ', 'Œ£Œ±œÄœÜœé', 'Œ†ŒØŒΩŒ¥Œ±œÅŒøœÇ'],
        };
        
        // √âtat de la langue courante ('all' = toutes langues, ou code langue sp√©cifique)
        let selectedLang = 'all';
        let currentWikisource = WIKISOURCES[0];
        
        // Fonction pour changer la langue
        function changeLanguage(lang) {
            selectedLang = lang;
            localStorage.setItem('palimpseste_lang', lang);
            toast(lang === 'all' ? 'üåç Toutes les langues activ√©es' : `üåê Langue: ${WIKISOURCES.find(w => w.lang === lang)?.name || lang}`);
            // Recharger le feed avec la nouvelle langue
            shuffleFeed();
        }
        
        // R√©cup√©rer les Wikisources selon le filtre de langue
        function getActiveWikisources() {
            if (selectedLang === 'all') return WIKISOURCES;
            return WIKISOURCES.filter(w => w.lang === selectedLang);
        }
        
        const GENRE_COLORS = {
            'po√©sie': '#bf5af2', 'poetry': '#bf5af2', 'Gedicht': '#bf5af2', 'poesia': '#bf5af2', 'poema': '#bf5af2',
            'fable': '#30d158', 'Fabel': '#30d158', 'favola': '#30d158', 'f√°bula': '#30d158',
            'conte': '#ff9f0a', 'tale': '#ff9f0a', 'M√§rchen': '#ff9f0a', 'racconto': '#ff9f0a', 'cuento': '#ff9f0a',
            'nouvelle': '#ff453a', 'story': '#ff453a', 'Novelle': '#ff453a', 'novella': '#ff453a',
            'th√©√¢tre': '#64d2ff', 'drama': '#64d2ff', 'theater': '#64d2ff', 'teatro': '#64d2ff',
            'texte': '#6e6e73', 'text': '#6e6e73',
            'mystique': '#ffd60a', 'mystic': '#ffd60a',
            'philosophie': '#ac8e68', 'philosophy': '#ac8e68',
            'roman': '#ff6482', 'novel': '#ff6482', 'Roman': '#ff6482', 'romanzo': '#ff6482'
        };
        
        // Graphe dynamique des connexions (enrichi au fur et √† mesure)
        let authorConnections = {};

        let state = {
            likes: new Set(), readCount: 0, loading: false, cache: new Map(),
            textPool: [], shownPages: new Set(), cardIdx: 0,
            authorStats: {}, genreStats: {},
            likedAuthors: new Set(), discoveredConnections: new Set(),
            achievements: [], readingPath: [],
            // Statistiques de lecture
            readingStats: {
                totalWordsRead: 0,
                totalReadingTime: 0, // en secondes
                streak: 0,
                lastReadDate: null,
                sessionsToday: 0,
                bestStreak: 0,
                dailyWords: {} // { 'YYYY-MM-DD': wordsCount }
            }
        };
        
        // Timer de lecture
        let readingTimer = null;
        let sessionStartTime = null;


        // Recherche via l'API - supporte plusieurs Wikisources
        async function searchTexts(query, limit = 20, wikisource = currentWikisource) {
            const url = `${wikisource.url}/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(query)}&srlimit=${limit}&srnamespace=0&format=json&origin=*`;
            console.log('searchTexts:', query, 'sur', wikisource.lang);
            try {
                const res = await fetch(url);
                const data = await res.json();
                const results = (data.query?.search || []).map(r => ({ ...r, lang: wikisource.lang, wikisource }));
                console.log('searchTexts: r√©sultats =', results.length);
                return results;
            } catch (e) { 
                console.error('searchTexts error:', e);
                return []; 
            }
        }
        
        // R√©cup√®re le texte avec gestion intelligente (multilingue)
        async function fetchText(page, depth = 0, wikisource = currentWikisource) {
            if (depth > 4) {
                console.log('fetchText: profondeur max atteinte pour', page);
                return null;
            }
            
            // Filtrage pr√©coce des pages ind√©sirables
            if (!isValidTitle(page)) {
                console.log('fetchText: titre invalide', page);
                return null;
            }
            
            const cacheKey = `${wikisource.lang}:${page}`;
            if (state.cache.has(cacheKey)) return state.cache.get(cacheKey);

            // Requ√™te enrichie : texte + cat√©gories + liens pour analyse du graphe
            const url = `${wikisource.url}/w/api.php?action=parse&page=${encodeURIComponent(page)}&prop=text|displaytitle|categories|links&pllimit=500&format=json&origin=*&redirects=true`;
            
            try {
                const res = await fetch(url);
                const data = await res.json();
                if (data.error) return null;
                
                if (data.parse?.text) {
                    // V√©rifier le displaytitle aussi
                    const displayTitle = data.parse.displaytitle || '';
                    if (!isValidTitle(displayTitle)) return null;
                    
                    const html = data.parse.text['*'];
                    const links = data.parse.links || [];
                    
                    // ‚ïê‚ïê‚ïê ANALYSE DU GRAPHE DES LIENS ‚ïê‚ïê‚ïê
                    // Compter les liens vers des sous-pages (m√™me pr√©fixe + "/")
                    const basePage = page.split('/')[0];
                    const subPageLinks = links.filter(l => {
                        const title = l['*'] || '';
                        return title.startsWith(basePage + '/') && l.ns === 0;
                    });
                    
                    // Si la page a beaucoup de liens vers ses sous-pages, c'est un sommaire
                    const isLikelySommaire = subPageLinks.length >= 5;
                    
                    if (isLikelySommaire && subPageLinks.length > 0) {
                        // Choisir une sous-page au hasard et la suivre
                        const randomSub = subPageLinks[Math.floor(Math.random() * subPageLinks.length)];
                        console.log('üìö Sommaire d√©tect√©:', page, '‚Üí suivre', randomSub['*']);
                        return await fetchText(randomSub['*'], depth + 1, wikisource);
                    }
                    
                    const analysis = analyzeHtml(html);
                    
                    // Si page d'index classique (redirections, √©ditions multiples)
                    if (analysis.isIndex && analysis.subLink) {
                        return await fetchText(analysis.subLink, depth + 1, wikisource);
                    }
                    
                    // ‚ïê‚ïê‚ïê ANALYSE STATISTIQUE DE QUALIT√â ‚ïê‚ïê‚ïê
                    // Filtrage des "faux textes" (pages de garde, listes, etc.)
                    const quality = analyzeContentQuality(analysis.text, links, page);
                    if (!quality.isGood) {
                         console.log(`‚ö†Ô∏è Rejet Qualit√© (${quality.reason}): ${page}`);
                         // Si c'est rejet√© parce que c'est un sommaire/liste, on essaie de trouver un lien pertinent
                         if (quality.reason === 'link_density' || quality.reason === 'listy') {
                             const contentLinks = links.filter(l => l.ns === 0 && !l['*'].includes(':'));
                             if (contentLinks.length > 0) {
                                 const randomLink = contentLinks[Math.floor(Math.random() * contentLinks.length)];
                                 return await fetchText(randomLink['*'], depth + 1, wikisource);
                             }
                         }
                         return null;
                    }

                    if (analysis.text && analysis.text.length > 150) {
                        // Nettoyer le titre (supprimer HTML et spans)
                        let cleanTitle = (data.parse.displaytitle || page)
                            .replace(/<[^>]+>/g, '')  // Supprimer tout HTML
                            .replace(/&nbsp;/g, ' ')
                            .replace(/&amp;/g, '&')
                            .replace(/&lt;/g, '<')
                            .replace(/&gt;/g, '>')
                            .replace(/mw-page-title[^\s]*/gi, '')  // Supprimer classes MW r√©siduelles
                            .trim();
                        
                        // Double v√©rification du titre nettoy√©
                        if (!isValidTitle(cleanTitle)) return null;
                        
                        // ===== D√âTECTION AUTEUR (multilingue) =====
                        let detectedAuthor = null;
                        
                        // 1. Chercher dans les liens de la page (liens "Auteur:XXX" / "Author:XXX" / etc.)
                        const authorPrefixes = ['Auteur:', 'Author:', 'Autor:', 'Autore:', '‰ΩúËÄÖ:'];
                        const links = data.parse.links || [];
                        for (const link of links) {
                            const linkTitle = link['*'] || '';
                            for (const prefix of authorPrefixes) {
                                if (linkTitle.startsWith(prefix)) {
                                    const authorName = linkTitle.replace(prefix, '').trim();
                                    if (authorName.length > 2 && authorName.length < 50) {
                                        detectedAuthor = authorName;
                                        break;
                                    }
                                }
                            }
                            if (detectedAuthor) break;
                        }
                        
                        // 2. Chercher dans les cat√©gories (patterns multilingues)
                        if (!detectedAuthor) {
                            const categories = data.parse.categories || [];
                            for (const cat of categories) {
                                const catName = cat['*'] || '';
                                // Patterns multilingues
                                const authorMatch = catName.match(/(?:Textes|Po√®mes|≈íuvres|Works|Texts|Poems|Werke|Opere|Obras)\s+(?:de|by|von|di)\s+(.+)/i);
                                if (authorMatch && authorMatch[1].length > 2) {
                                    detectedAuthor = authorMatch[1].trim();
                                    break;
                                }
                            }
                        }
                        
                        // 3. Chercher un lien Auteur: dans le HTML
                        if (!detectedAuthor) {
                            detectedAuthor = analysis.authorFromHtml;
                        }
                        
                        const result = { 
                            text: analysis.text, 
                            title: cleanTitle,
                            author: detectedAuthor,
                            lang: wikisource.lang,
                            wikisource: wikisource
                        };
                        state.cache.set(cacheKey, result);
                        return result;
                    }
                }
                return null;
            } catch (e) { return null; }
        }

        function analyzeHtml(html) {
            const div = document.createElement('div');
            div.innerHTML = html;
            
            // ===== EXTRAIRE L'AUTEUR DEPUIS LE HTML =====
            let authorFromHtml = null;
            
            // 1. Chercher les liens "Auteur:XXX" dans le HTML
            const authorLinks = div.querySelectorAll('a[href*="Auteur:"]');
            for (const a of authorLinks) {
                const href = a.getAttribute('href') || '';
                const match = href.match(/Auteur:([^"&?#]+)/);
                if (match) {
                    authorFromHtml = decodeURIComponent(match[1]).replace(/_/g, ' ').trim();
                    break;
                }
            }
            
            // 2. Chercher dans les √©l√©ments de header/metadata Wikisource
            if (!authorFromHtml) {
                const headerAuthor = div.querySelector('.ws-author, .author, .auteur, [class*="auteur"]');
                if (headerAuthor) {
                    const authorText = headerAuthor.textContent.trim();
                    if (authorText.length > 2 && authorText.length < 50) {
                        authorFromHtml = authorText;
                    }
                }
            }
            
            // 3. Chercher le pattern "par XXX" ou "de XXX" en d√©but de page
            if (!authorFromHtml) {
                const firstLines = div.textContent.substring(0, 500);
                const parMatch = firstLines.match(/(?:^|\n)\s*(?:par|de)\s+([A-Z√Ä-√ú][a-z√†-√º]+(?:\s+(?:de\s+)?[A-Z√Ä-√ú][a-z√†-√º\-]+){0,3})\s*(?:\n|$)/m);
                if (parMatch && parMatch[1].length > 3 && parMatch[1].length < 40) {
                    authorFromHtml = parMatch[1].trim();
                }
            }
            
            // Supprimer tous les spans avec page-title AVANT toute analyse
            div.querySelectorAll('span[class*="page-title"], .mw-page-title-main, .mw-page-title').forEach(el => el.remove());
            
            // D√©tecter page d'index/sommaire (simplifi√© - seulement les cas √©vidents)
            const isRedirect = !!div.querySelector('.redirectMsg');
            const txt = div.textContent;
            const hasEditions = txt.includes('propose plusieurs √©ditions') || 
                               txt.includes('Cette page r√©pertorie');
            
            // Seulement les redirections et pages d'√©ditions multiples sont des index
            const isIndex = isRedirect || hasEditions;
            
            // Trouver un sous-lien utile si c'est un index
            let subLink = null;
            if (isIndex) {
                const links = div.querySelectorAll('a[href^="/wiki/"]');
                for (const a of links) {
                    const href = a.getAttribute('href');
                    if (href && !href.includes(':') && !href.includes('Auteur') && !href.includes('Discussion')) {
                        const name = decodeURIComponent(href.replace('/wiki/', ''));
                        // Chercher des pages qui ressemblent √† du contenu r√©el
                        if (name.includes('/') && !name.endsWith('/')) {
                            // √âviter les pages de m√©tadonn√©es
                            if (!name.includes('Pr√©face') && !name.includes('Notice') && 
                                !name.includes('Table') && !name.includes('Index')) {
                                subLink = name;
                                break;
                            }
                        }
                    }
                }
            }
            
            // Nettoyer - supprimer tous les √©l√©ments non d√©sir√©s
            div.querySelectorAll('.ws-noexport, .noprint, .mw-editsection, script, style, .reference, .toc, .navbox, .infobox, .metadata, .hatnote, .ambox, .catlinks, .mw-headline, .redirectMsg, .homonymie, .bandeau-homonymie, .bandeau-portail, .headertemplate, .ws-header, .mw-page-title-main, .mw-page-title, span[class*="page-title"], .titreoeuvre, .auteur-oeuvre, .header').forEach(el => el.remove());
            
            let content = div.querySelector('.prp-pages-output, .poem') || div.querySelector('.mw-parser-output') || div;
            
            // Supprimer TOUS les spans de MediaWiki
            content.querySelectorAll('span').forEach(el => {
                const cls = el.className || '';
                if (cls.includes('page-title') || cls.includes('mw-') || cls.includes('ws-')) {
                    el.remove();
                }
            });
            
            let text = content.innerText || content.textContent;
            
            // Nettoyer les r√©sidus HTML et MediaWiki
            text = text.replace(/\[modifier[^\]]*\]/g, '').replace(/\[\d+\]/g, '')
                       .replace(/modifier le wikicode/gi, '').replace(/\n{3,}/g, '\n\n')
                       .replace(/<span[^>]*>|<\/span>/gi, '')  // Supprimer spans r√©siduels
                       .replace(/<[^>]+>/g, '')  // Supprimer tout HTML r√©siduel
                       .replace(/mw-page-title[^\s]*/gi, '')  // Supprimer classes MW
                       .replace(/&nbsp;/g, ' ').replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>')
                       .replace(/Po√©sies \([^)]+\)/g, '')  // Supprimer titres de recueils parasites
                       .trim();
            
            // Enlever m√©tadonn√©es, pr√©faces, mentions de conf√©rence en d√©but
            const lines = text.split('\n');
            let start = 0;
            for (let i = 0; i < Math.min(15, lines.length); i++) {
                const l = lines[i].toLowerCase();
                const line = lines[i].trim();
                if (l.includes('sommaire') || l.includes('√©dition') || l.includes('navigation') || 
                    l.includes('conf√©rence') || l.includes('pr√©sent√©') || l.includes('si√®ge') ||
                    l.includes('pr√©sid√©e par') || l.includes('professeur') || l.includes('facult√©') ||
                    l.includes('mw-page-title') || l.includes('span class') ||
                    line.length < 3 || (line.startsWith('(') && line.endsWith(')'))) {
                    start = i + 1;
                } else if (line.length > 40) break;
            }
            text = lines.slice(start).join('\n').trim();
            
            if (text.length > 5000) {
                text = text.substring(0, 5000);
                const cut = Math.max(text.lastIndexOf('\n\n'), text.lastIndexOf('. '));
                if (cut > 4000) text = text.substring(0, cut + 1);
                text += '\n\n[...]';
            }
            
            // ‚ïê‚ïê‚ïê D√âTECTION ROBUSTE DES SCORIES ‚ïê‚ïê‚ïê
            if (isLikelyJunk(text)) {
                return { text: '', isIndex: true, subLink, authorFromHtml };
            }
            
            return { text, isIndex, subLink, authorFromHtml };
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üõ°Ô∏è FILTRE MINIMAL - On laisse le graphe des liens faire le travail
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function isLikelyJunk(text) {
            // Filtre minimal : juste v√©rifier qu'il y a du contenu
            if (!text || text.length < 100) return true;
            const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
            if (lines.length < 2) return true;
            return false;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üï∏Ô∏è EXPLORATION PAR ARBORESCENCE (Cat√©gories)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        let currentCategoryPath = [];
        let currentBrowseMode = null; // 'category' ou 'search'
        
        // Branches enrichies par genre (auteurs majeurs + courants)
        const GENRE_BRANCHES = {
            'philosophie': {
                'Courants': ['Rationalisme', 'Empirisme', 'Id√©alisme', 'Existentialisme', 'Sto√Øcisme', '√âpicurisme', 'Scepticisme', 'Ph√©nom√©nologie'],
                'Domaines': ['M√©taphysique', '√âthique', '√âpist√©mologie', 'Logique', 'Esth√©tique', 'Philosophie politique', 'Ontologie'],
                'Antiquit√©': ['Platon', 'Aristote', '√âpict√®te', 'Marc Aur√®le', 'S√©n√®que', 'Cic√©ron', 'Lucr√®ce'],
                'XVIIe si√®cle': ['Descartes', 'Pascal', 'Spinoza', 'Leibniz', 'Malebranche', 'Hobbes', 'Locke'],
                'XVIIIe si√®cle': ['Voltaire', 'Rousseau', 'Montesquieu', 'Diderot', 'Hume', 'Kant', 'Condillac'],
                'XIXe si√®cle': ['Hegel', 'Schopenhauer', 'Nietzsche', 'Kierkegaard', 'Comte', 'Marx', 'Bergson']
            },
            'po√©sie': {
                'Formes': ['Sonnet', 'Ode', '√âl√©gie', 'Ballade', 'Fable', '√âpop√©e', 'Ha√Øku'],
                'Mouvements': ['Romantisme', 'Parnasse', 'Symbolisme', 'Surr√©alisme', 'Baroque'],
                'XVIe si√®cle': ['Ronsard', 'Du Bellay', 'Louise Lab√©', 'Marot'],
                'XVIIe si√®cle': ['La Fontaine', 'Malherbe', 'Boileau', 'Racine'],
                'XIXe si√®cle': ['Hugo', 'Baudelaire', 'Verlaine', 'Rimbaud', 'Mallarm√©', 'Lamartine', 'Musset', 'Nerval'],
                'XXe si√®cle': ['Apollinaire', '√âluard', 'Aragon', 'Pr√©vert', 'Char', 'Val√©ry']
            },
            'roman': {
                'Genres': ['Roman √©pistolaire', 'Roman historique', 'Roman r√©aliste', 'Roman naturaliste', 'Roman psychologique'],
                'XVIIe si√®cle': ['Madame de La Fayette', 'Scarron', 'F√©nelon'],
                'XVIIIe si√®cle': ['Voltaire', 'Rousseau', 'Diderot', 'Laclos', 'Pr√©vost', 'Bernardin de Saint-Pierre'],
                'XIXe si√®cle': ['Balzac', 'Stendhal', 'Flaubert', 'Zola', 'Maupassant', 'Hugo', 'Dumas', 'Sand'],
                'XXe si√®cle': ['Proust', 'Gide', 'C√©line', 'Camus', 'Sartre', 'Colette']
            },
            'th√©√¢tre': {
                'Genres': ['Trag√©die', 'Com√©die', 'Drame', 'Farce', 'Vaudeville'],
                'Antiquit√©': ['Sophocle', 'Euripide', 'Eschyle', 'Aristophane', 'Plaute', 'T√©rence'],
                'XVIIe si√®cle': ['Moli√®re', 'Racine', 'Corneille', 'Marivaux'],
                'XVIIIe si√®cle': ['Beaumarchais', 'Voltaire', 'Marivaux'],
                'XIXe si√®cle': ['Hugo', 'Musset', 'Rostand', 'Labiche'],
                'XXe si√®cle': ['Claudel', 'Giraudoux', 'Anouilh', 'Ionesco', 'Beckett']
            },
            'conte': {
                'Types': ['Conte merveilleux', 'Conte philosophique', 'Conte moral', 'Conte fantastique'],
                'Auteurs': ['Perrault', 'Grimm', 'Andersen', 'Voltaire', 'Maupassant', 'Hoffmann']
            },
            'nouvelle': {
                'Styles': ['Nouvelle r√©aliste', 'Nouvelle fantastique', 'Nouvelle psychologique'],
                'Auteurs': ['Maupassant', 'M√©rim√©e', 'Balzac', 'Flaubert', 'Zola', 'Villiers de l\'Isle-Adam']
            },
            'mystique': {
                'Traditions': ['Mystique chr√©tienne', 'Mystique soufie', 'Kabbale'],
                'Auteurs': ['Th√©r√®se d\'Avila', 'Jean de la Croix', 'Ma√Ætre Eckhart', 'Fran√ßois de Sales', 'F√©nelon', 'Bossuet']
            },
            'fable': {
                'Auteurs': ['La Fontaine', '√âsope', 'Ph√®dre', 'Florian']
            },
            'histoire': {
                'P√©riodes': ['Antiquit√©', 'Moyen √Çge', 'Renaissance', 'R√©volution fran√ßaise', 'XIXe si√®cle'],
                'Historiens': ['H√©rodote', 'Thucydide', 'Tacite', 'Michelet', 'Tocqueville', 'Voltaire']
            }
        };
        
        // Mappage des genres simples vers les cat√©gories racines Wikisource
        const CATEGORY_ROOTS = {
            fr: {
                'po√©sie': 'Cat√©gorie:Po√©sie',
                'roman': 'Cat√©gorie:Romans',
                'th√©√¢tre': 'Cat√©gorie:Th√©√¢tre',
                'philosophie': 'Cat√©gorie:Philosophie',
                'conte': 'Cat√©gorie:Contes',
                'fable': 'Cat√©gorie:Fables',
                'nouvelle': 'Cat√©gorie:Nouvelles',
                'essai': 'Cat√©gorie:Essais',
                'histoire': 'Cat√©gorie:Histoire',
                'lettres': 'Cat√©gorie:Correspondances',
                'mystique': 'Cat√©gorie:Textes_spirituels'
            },
            en: {
                'poetry': 'Category:Poetry',
                'novel': 'Category:Novels',
                'drama': 'Category:Plays',
                'philosophy': 'Category:Philosophy',
                'tale': 'Category:Tales',
                'history': 'Category:History',
                'essay': 'Category:Essays'
            },
            de: {
                'Gedicht': 'Kategorie:Gedicht_Titel',
                'Roman': 'Kategorie:Roman',
                'M√§rchen': 'Kategorie:M√§rchen'
            }
        };

        async function exploreCategory(genreOrCategoryName, isSubCat = false) {
            const wikisource = currentWikisource;
            const lang = wikisource.lang;
            const genreLower = genreOrCategoryName.toLowerCase();
            
            // Afficher l'UI
            document.getElementById('categoryNav').style.display = 'block';
            document.getElementById('catSubcategories').innerHTML = '<div style="color:var(--muted)">Chargement...</div>';
            document.getElementById('feed').innerHTML = '';
            state.textPool = [];
            
            // Cas 1: C'est un genre racine avec branches enrichies
            if (!isSubCat && GENRE_BRANCHES[genreLower]) {
                currentCategoryPath = [genreOrCategoryName];
                currentBrowseMode = 'branches';
                renderBreadcrumbs();
                renderEnrichedBranches(genreLower);
                return;
            }
            
            // Cas 2: C'est une branche (recherche par terme)
            if (!isSubCat) {
                currentCategoryPath = [genreOrCategoryName];
            } else if (!currentCategoryPath.includes(genreOrCategoryName)) {
                currentCategoryPath.push(genreOrCategoryName);
            } else {
                const index = currentCategoryPath.indexOf(genreOrCategoryName);
                currentCategoryPath = currentCategoryPath.slice(0, index + 1);
            }
            
            renderBreadcrumbs();
            currentBrowseMode = 'search';
            
            // Rechercher sur Wikisource
            await searchByTerm(genreOrCategoryName, wikisource);
        }
        
        // Affiche les branches enrichies pour un genre
        function renderEnrichedBranches(genre) {
            const branches = GENRE_BRANCHES[genre];
            if (!branches) return;
            
            const container = document.getElementById('catSubcategories');
            let html = '<div class="branches-container">';
            
            for (const [groupName, items] of Object.entries(branches)) {
                html += `<div class="branch-group">
                    <div class="branch-group-title">${groupName}</div>
                    <div class="branch-items">
                        ${items.map(item => `<div class="cat-pill" onclick="exploreCategory('${item.replace(/'/g, "\\'")}', true)">${item}</div>`).join('')}
                    </div>
                </div>`;
            }
            
            html += '</div>';
            container.innerHTML = html;
            
            // Message d'info
            document.getElementById('feed').innerHTML = '<div class="empty-state">üëÜ Choisissez une branche ci-dessus pour explorer les textes</div>';
        }
        
        // Recherche par terme (auteur, courant, etc.)
        async function searchByTerm(term, wikisource) {
            document.getElementById('catSubcategories').innerHTML = `<div style="color:var(--muted)">üîç Recherche "${term}"...</div>`;
            
            try {
                // Recherche √©largie sur Wikisource
                const results = await searchTexts(term, 50, wikisource);
                
                // Filtrer les r√©sultats valides
                const validResults = results.filter(r => isValidTitle(r.title) && r.snippet?.length > 20);
                
                // Info sur les r√©sultats
                const container = document.getElementById('catSubcategories');
                if (validResults.length > 0) {
                    container.innerHTML = `<div style="font-size:0.8rem; color:var(--accent);">üìö ${validResults.length} texte${validResults.length > 1 ? 's' : ''} trouv√©${validResults.length > 1 ? 's' : ''} pour "${term}"</div>`;
                } else {
                    container.innerHTML = `<div style="font-size:0.8rem; color:var(--muted);">Aucun r√©sultat pour "${term}"</div>`;
                }
                
                // Remplir le pool
                state.textPool = validResults.map(r => ({
                    title: r.title,
                    snippet: r.snippet,
                    lang: wikisource.lang,
                    wikisource: wikisource,
                    source: 'search_exploration'
                }));
                
                // M√©langer et charger
                state.textPool = state.textPool.sort(() => Math.random() - 0.5);
                
                if (state.textPool.length > 0) {
                    loadMore();
                } else {
                    document.getElementById('feed').innerHTML = `<div class="empty-state">Aucun texte trouv√© pour "${term}".<br>Essayez un autre terme.</div>`;
                }
                
            } catch (e) {
                console.error('Search error:', e);
                document.getElementById('catSubcategories').innerHTML = '<div style="color:var(--accent)">Erreur de recherche</div>';
            }
        }
        
        async function fetchCategoryData(categoryName, wikisource) {
            // R√©cup√©rer sous-cat√©gories et pages
            const url = `${wikisource.url}/w/api.php?action=query&list=categorymembers&cmtitle=${encodeURIComponent(categoryName)}&cmlimit=100&format=json&origin=*`;
            
            try {
                const res = await fetch(url);
                const data = await res.json();
                const members = data.query?.categorymembers || [];
                
                const subcats = members.filter(m => m.ns === 14); // 14 = Category
                const pages = members.filter(m => m.ns === 0);    // 0 = Page
                
                renderSubcategories(subcats, pages.length);
                
                // Remplir le pool avec les pages trouv√©es
                state.textPool = []; // Reset pour cette cat√©gorie
                for (const p of pages) {
                    if (isValidTitle(p.title)) {
                         state.textPool.push({
                             title: p.title,
                             lang: wikisource.lang,
                             wikisource: wikisource,
                             source: 'category_exploration'
                         });
                    }
                }
                
                console.log('Category pages:', state.textPool.length, 'textes valides sur', pages.length);
                
                // M√©langer et charger
                state.textPool = state.textPool.sort(() => Math.random() - 0.5);
                
                if (state.textPool.length > 0) {
                    loadMore();
                } else if (subcats.length === 0) {
                    document.getElementById('feed').innerHTML = '<div class="empty-state">Aucun texte direct dans cette cat√©gorie.<br>Essayez une autre branche.</div>';
                }
                
            } catch (e) {
                console.error('Category error:', e);
                document.getElementById('catSubcategories').innerHTML = '<div style="color:var(--accent)">Erreur de chargement</div>';
            }
        }
        
        function renderBreadcrumbs() {
            const container = document.getElementById('catBreadcrumbs');
            container.innerHTML = currentCategoryPath.map((cat, idx) => {
                const name = cat.split(':')[1] || cat;
                const isLast = idx === currentCategoryPath.length - 1;
                return `
                    <span class="cat-crumb ${isLast ? 'active' : ''}" onclick="exploreCategory('${cat.replace(/'/g, "\\'")}', true)">${name}</span>
                    ${!isLast ? '<span class="cat-sep">></span>' : ''}
                `;
            }).join('');
        }
        
        function renderSubcategories(subcats, pageCount = 0) {
            const container = document.getElementById('catSubcategories');
            
            let html = '';
            
            // Info sur les pages directes
            if (pageCount > 0) {
                html += `<div style="font-size:0.8rem; color:var(--accent); margin-bottom:0.5rem;">üìö ${pageCount} texte${pageCount > 1 ? 's' : ''} dans cette cat√©gorie</div>`;
            }
            
            if (subcats.length === 0) {
                if (pageCount === 0) {
                    html += '<div style="font-size:0.8rem; color:var(--muted); font-style:italic;">Cat√©gorie vide ou sous-pages uniquement</div>';
                }
                container.innerHTML = html;
                return;
            }
            
            html += `<div style="font-size:0.75rem; color:var(--muted); margin-bottom:0.3rem;">‚Ü≥ ${subcats.length} sous-cat√©gorie${subcats.length > 1 ? 's' : ''} :</div>`;
            html += subcats.map(c => {
                const name = (c.title.split(':')[1] || c.title).replace(/_/g, ' ');
                return `<div class="cat-pill" onclick="exploreCategory('${c.title.replace(/'/g, "\\'")}', true)">${name}</div>`;
            }).join('');
            
            container.innerHTML = html;
        }
        
        function closeCategoryMode() {
            document.getElementById('categoryNav').style.display = 'none';
            currentCategoryPath = [];
            shuffleFeed(); // Revenir au mode normal
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ÔøΩ PROJECT GUTENBERG - Classiques du domaine public
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function fetchGutenberg() {
            const works = ALT_SOURCES.gutenberg.works;
            // Filtrer par langue si n√©cessaire
            const filtered = selectedLang === 'all' 
                ? works 
                : works.filter(w => w.lang === selectedLang);
            
            if (filtered.length === 0) return [];
            
            // Choisir une ≈ìuvre au hasard
            const work = filtered[Math.floor(Math.random() * filtered.length)];
            const cacheKey = `gutenberg:${work.id}`;
            
            // √âviter les doublons
            if (state.shownPages.has(cacheKey)) return [];
            
            try {
                // Utiliser l'API de t√©l√©chargement texte de Gutenberg
                const res = await fetch(`https://www.gutenberg.org/files/${work.id}/${work.id}-0.txt`, {
                    mode: 'cors'
                }).catch(() => 
                    // Fallback sur un autre format
                    fetch(`https://www.gutenberg.org/cache/epub/${work.id}/pg${work.id}.txt`)
                );
                
                if (!res.ok) throw new Error('Gutenberg fetch failed');
                
                let text = await res.text();
                
                // Nettoyer le texte Gutenberg (retirer header/footer l√©gaux)
                const startMarkers = ['*** START OF', '***START OF', 'START OF THE PROJECT'];
                const endMarkers = ['*** END OF', '***END OF', 'END OF THE PROJECT', 'End of Project'];
                
                for (const marker of startMarkers) {
                    const idx = text.indexOf(marker);
                    if (idx !== -1) {
                        const nextLine = text.indexOf('\n', idx);
                        text = text.substring(nextLine + 1);
                        break;
                    }
                }
                
                for (const marker of endMarkers) {
                    const idx = text.indexOf(marker);
                    if (idx !== -1) {
                        text = text.substring(0, idx);
                        break;
                    }
                }
                
                // Prendre un extrait al√©atoire (pas tout le livre!)
                const paragraphs = text.split(/\n\n+/).filter(p => p.trim().length > 100);
                if (paragraphs.length > 10) {
                    // Choisir un passage au hasard (pas le d√©but)
                    const startIdx = Math.floor(Math.random() * Math.max(1, paragraphs.length - 10)) + 5;
                    const excerpt = paragraphs.slice(startIdx, startIdx + 5).join('\n\n');
                    
                    console.log('üìö Gutenberg:', work.title, 'by', work.author);
                    
                    return [{
                        title: work.title,
                        text: excerpt.trim(),
                        author: work.author,
                        source: 'gutenberg',
                        lang: work.lang,
                        gutenbergId: work.id
                    }];
                }
            } catch (e) {
                console.error('Gutenberg error:', work.title, e);
            }
            return [];
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ÔøΩüìú POETRYDB - Po√©sie anglaise de qualit√© (pas de scories!)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function fetchPoetryDB() {
            const authors = ALT_SOURCES.poetrydb.authors;
            const randomAuthor = authors[Math.floor(Math.random() * authors.length)];
            
            try {
                const res = await fetch(`https://poetrydb.org/author/${encodeURIComponent(randomAuthor)}/title,author,lines`);
                const poems = await res.json();
                
                if (Array.isArray(poems) && poems.length > 0) {
                    // Prendre quelques po√®mes au hasard
                    const shuffled = poems.sort(() => Math.random() - 0.5).slice(0, 5);
                    console.log('üìú PoetryDB:', randomAuthor, '=', shuffled.length, 'po√®mes');
                    
                    return shuffled.map(poem => ({
                        title: poem.title,
                        text: poem.lines.join('\n'),
                        author: poem.author,
                        source: 'poetrydb',
                        lang: 'en'
                    }));
                }
            } catch (e) {
                console.error('PoetryDB error:', e);
            }
            return [];
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üåç ALIMENTER LE POOL - Litt√©rature mondiale
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function fillPool() {
            // === 1. POETRYDB (si anglais actif) - Qualit√© garantie ===
            if (selectedLang === 'all' || selectedLang === 'en') {
                try {
                    const poems = await fetchPoetryDB();
                    for (const poem of poems) {
                        if (!state.shownPages.has('poetrydb:' + poem.title)) {
                            // Ajouter EN PRIORIT√â (pas de scories!)
                            state.textPool.unshift({
                                title: poem.title,
                                text: poem.text,
                                author: poem.author,
                                lang: 'en',
                                source: 'poetrydb',
                                isPreloaded: true // Texte d√©j√† charg√©
                            });
                        }
                    }
                } catch (e) {
                    console.error('PoetryDB fillPool error:', e);
                }
            }
            
            // === 1.5 PROJECT GUTENBERG - Classiques du domaine public ===
            try {
                const gutenbergTexts = await fetchGutenberg();
                for (const item of gutenbergTexts) {
                    state.textPool.unshift({
                        ...item,
                        isPreloaded: true
                    });
                }
            } catch (e) {
                console.error('Gutenberg fillPool error:', e);
            }
            
            // === 2. WIKISOURCE (sources traditionnelles) ===
            const activeSources = getActiveWikisources();
            if (activeSources.length === 0 && state.textPool.length === 0) {
                console.error('Aucune source active');
                return;
            }
            const shuffledSources = [...activeSources].sort(() => Math.random() - 0.5).slice(0, Math.min(3, activeSources.length));
            
            console.log('fillPool: sources =', shuffledSources.map(s => s.lang));
            
            for (const ws of shuffledSources) {
                const terms = [...(SEARCH_TERMS[ws.lang] || SEARCH_TERMS.en)]; // Copier pour ne pas muter
                // Choisir 4-5 termes al√©atoires (plus de vari√©t√©)
                const selectedTerms = terms.sort(() => Math.random() - 0.5).slice(0, 5);
                
                console.log('fillPool: recherche', ws.lang, selectedTerms);
                
                for (const term of selectedTerms) {
                    try {
                        const results = await searchTexts(term, 15, ws); // Plus de r√©sultats
                        console.log('fillPool:', term, '=', results.length, 'r√©sultats');
                        for (const r of results) {
                            if (!state.shownPages.has(r.title) && !state.textPool.some(t => t.title === r.title)) {
                                // Filtrage g√©n√©raliste par structure du titre
                                if (isValidTitle(r.title) && r.snippet?.length > 20) {
                                    // Prioriser les sous-pages (contenu r√©el)
                                    const item = { 
                                        title: r.title, 
                                        snippet: r.snippet, 
                                        lang: ws.lang,
                                        wikisource: ws 
                                    };
                                    if (r.title.includes('/')) {
                                        state.textPool.unshift(item);
                                    } else {
                                        state.textPool.push(item);
                                    }
                                }
                            }
                        }
                    } catch (e) { 
                        console.error('fillPool error:', e);
                    }
                }
            }
            console.log('fillPool: pool final =', state.textPool.length, 'items');
            state.textPool = [...state.textPool].sort(() => Math.random() - 0.5);
        }
        
        // Filtrage g√©n√©raliste du titre (exclut les pages non litt√©raires)
        function isValidTitle(title) {
            if (!title || title.length < 3) return false;
            const t = title.toLowerCase();
            
            // Exclure les namespaces sp√©ciaux (universel)
            if (t.includes('category:') || t.includes('cat√©gorie:') || 
                t.includes('kategorie:') || t.includes('categoria:')) return false;
            
            // Liste √©tendue des namespaces wiki
            if (/^(help|aide|hilfe|aiuto|ayuda|ajuda|manual|project|projet|image|file|fichier|template|mod√®le|module|media|special|sp√©cial):/i.test(t)) return false;

            if (t.includes('author:') || t.includes('auteur:') || 
                t.includes('autor:') || t.includes('autore:')) return false;
            if (t.includes('talk:') || t.includes('discussion:') || 
                t.includes('diskussion:') || t.includes('discussione:')) return false;
            if (t.includes('index:') || t.includes('page:') || t.includes('file:')) return false;
            
            // Exclure les listes (pattern universel)
            if (/^list[ea]?\s+(de|of|di|von)/i.test(t)) return false;
            if (t.startsWith('index ') || t.endsWith(' index')) return false;
            if (t.includes('table des mati√®res') || t.includes('table of contents') || t.includes('inhaltsverzeichnis')) return false;
            if (t.includes('bibliographie') || t.includes('bibliography')) return false;
            
            // Exclure les √©tudes biographiques et critiques (souvent des pages de garde)
            if (t.includes('sa vie et son ≈ìuvre') || t.includes('sa vie et son oeuvre')) return false;
            if (t.includes('his life and work') || t.includes('sein leben')) return false;
            if (t.includes('√©tude biographique') || t.includes('√©tude sur')) return false;
            if (t.includes('biographical study') || t.includes('biography of')) return false;
            if (/\bbiograph/i.test(t) && !t.includes('/')) return false;
            
            // Exclure les ≈ìuvres compl√®tes sans sous-page (ce sont des sommaires)
            if ((t.includes('≈ìuvres compl√®tes') || t.includes('complete works') || 
                 t.includes('gesammelte werke') || t.includes('opere complete')) && !t.includes('/')) return false;
            
            return true;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üïµÔ∏è ANALYSE DE QUALIT√â DU CONTENU (Heuristiques)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function analyzeContentQuality(text, links, title) {
            if (!text) return { isGood: false, reason: 'empty' };
            const len = text.length;
            
            // 1. Trop court = Fragment ou erreur
            if (len < 300) return { isGood: false, reason: 'too_short' };
            
            // 2. Trop long = Livre entier non d√©coup√© (mauvaise UX)
            if (len > 80000) return { isGood: false, reason: 'too_long' };
            
            // 3. Densit√© de liens (Link Density)
            // Si une page est compos√©e √† 20% de liens, c'est un sommaire/hub
            // On estime ~30 chars par lien en moyenne (titre + balise)
            const linkCharsEstimate = links.length * 30;
            const linkDensity = linkCharsEstimate / len;
            
            // Seuil : > 25% de liens = Sommaire
            if (linkDensity > 0.25) return { isGood: false, reason: 'link_density' };
            
            // 4. Structure "Paragraphe" vs "Liste"
            // Un vrai texte a des phrases qui finissent par des points.
            // Une liste a des retours √† la ligne fr√©quents sans ponctuation.
            const lines = text.split('\n').filter(l => l.trim().length > 0);
            const avgLineLength = len / Math.max(1, lines.length);
            
            // Si lignes tr√®s courtes (< 50 chars) ET pas de ponctuation finale
            if (avgLineLength < 60) {
                // Exception pour la po√©sie : lignes courtes mais strophes
                // V√©rifier la ponctuation
                const linesEndingWithPunctuation = lines.filter(l => /[.!?‚Ä¶:;]$/.test(l.trim())).length;
                const punctuationRatio = linesEndingWithPunctuation / lines.length;
                
                // Si peu de ponctuation finale (< 30%), c'est une liste brute
                if (punctuationRatio < 0.3) return { isGood: false, reason: 'listy' };
            }
            
            // 5. Structure Words (Meta-titres)
            const t = title.toLowerCase();
            const badWords = ['sommaire', 'contents', 'inhalt', 'table', 'index', 'chapitres', 'chapters'];
            if (badWords.some(w => t.includes(w))) return { isGood: false, reason: 'title_blacklist' };

            return { isGood: true };
        }

        // Normalise un nom d'auteur (simplifi√© - accepte tout nom valide)
        function normalizeAuthor(rawAuthor) {
            if (!rawAuthor) return null;
            // Nettoyer le nom
            let clean = rawAuthor
                .replace(/_/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();
            
            // V√©rifier que c'est un nom valide (commence par majuscule, longueur raisonnable)
            if (clean.length > 2 && clean.length < 60 && /^[A-Z√Ä-√ú–ê-–Ø„ÅÅ-„Çì„Ç°-„É≥‰∏Ä-ÈæØ\u0600-\u06FF]/.test(clean)) {
                return clean;
            }
            return null;
        }

        function detectAuthor(title, text, metadataAuthor = null) {
            // 1. PRIORIT√â : Auteur des m√©tadonn√©es Wikisource (liens, cat√©gories)
            if (metadataAuthor) {
                const normalized = normalizeAuthor(metadataAuthor);
                if (normalized) return normalized;
            }
            
            // 2. Chercher dans le titre (format "≈íuvre (Auteur)")
            const parenthMatch = title.match(/\(([^)]+)\)$/);
            if (parenthMatch) {
                const potentialAuthor = parenthMatch[1].trim();
                // V√©rifier que √ßa ressemble √† un nom de personne
                if (/^[A-Z√Ä-√ú][a-z√†-√º]+(\s+[A-Z√Ä-√ú][a-z√†-√º]+)*$/.test(potentialAuthor)) {
                    return potentialAuthor;
                }
            }
            
            // 3. Chercher dans le titre - format "Auteur - ≈íuvre" ou "≈íuvre - Auteur"
            const dashMatch = title.match(/^([^‚Äî‚Äì\-]+)[‚Äî‚Äì\-](.+)$/);
            if (dashMatch) {
                const part1 = dashMatch[1].trim();
                const part2 = dashMatch[2].trim();
                // Tester si l'une des parties est un nom de personne
                if (/^[A-Z√Ä-√ú][a-z√†-√º]+(\s+[A-Z√Ä-√ú][a-z√†-√º]+)*$/.test(part1)) return part1;
                if (/^[A-Z√Ä-√ú][a-z√†-√º]+(\s+[A-Z√Ä-√ú][a-z√†-√º]+)*$/.test(part2)) return part2;
            }
            
            return 'Anonyme';
        }

        function detectTag(title, text) {
            const t = (title + ' ' + (text || '').substring(0, 500)).toLowerCase();
            const titleLower = title.toLowerCase();
            
            // Th√©√¢tre (prioritaire - mots tr√®s sp√©cifiques)
            if (t.includes('acte ') || t.includes('sc√®ne ') || titleLower.includes('trag√©die') || 
                titleLower.includes('com√©die') || t.includes('personnages:') || t.includes('le ch≈ìur')) return 'th√©√¢tre';
            
            // Fable (prioritaire)
            if (titleLower.includes('fable') || (t.includes('morale') && t.includes('la fontaine'))) return 'fable';
            
            // Conte
            if (titleLower.includes('conte') || titleLower.includes('il √©tait une fois')) return 'conte';
            
            // Po√©sie (mots sp√©cifiques au genre)
            if (titleLower.includes('sonnet') || titleLower.includes('po√®me') || titleLower.includes('po√©sie') ||
                titleLower.includes('ode ') || titleLower.includes('ballade') || titleLower.includes('√©l√©gie') ||
                titleLower.includes('stances') || titleLower.includes('hymne') || titleLower.includes('rondeau') ||
                titleLower.includes('complainte') || titleLower.includes('chanson')) return 'po√©sie';
            // D√©tection po√©sie par structure (vers courts, rimes)
            const lines = (text || '').split('\n').slice(0, 20);
            const shortLines = lines.filter(l => l.trim().length > 5 && l.trim().length < 60);
            if (shortLines.length > 10) return 'po√©sie';
            
            // Nouvelle
            if (titleLower.includes('nouvelle')) return 'nouvelle';
            
            // Roman
            if (titleLower.includes('chapitre') || titleLower.includes('roman') || 
                titleLower.includes('livre ') || titleLower.includes('partie ')) return 'roman';
            
            // Philosophie (termes sp√©cifiques)
            if (titleLower.includes('pens√©es') || titleLower.includes('maximes') || titleLower.includes('r√©flexions') ||
                titleLower.includes('essai') || titleLower.includes('discours sur') || titleLower.includes('trait√©') ||
                titleLower.includes('lettres √†') || titleLower.includes('entretiens')) return 'philosophie';
            
            // Mystique (termes TR√àS sp√©cifiques seulement)
            if (titleLower.includes('sermon') || titleLower.includes('oraison') || titleLower.includes('pri√®re') ||
                titleLower.includes('m√©ditation') || titleLower.includes('spirituel') || titleLower.includes('mystique') ||
                titleLower.includes('contemplation') || titleLower.includes('extase') || titleLower.includes('ch√¢teau int√©rieur') ||
                titleLower.includes('nuit obscure') || titleLower.includes('imitation de')) return 'mystique';
            
            return 'texte';
        }

        async function init() {
            console.log('init: d√©marrage');
            
            // Initialiser Supabase (social features)
            initSupabase();
            
            loadState();
            
            // Restaurer le choix de langue (avec validation)
            const savedLang = localStorage.getItem('palimpseste_lang') || 'all';
            // V√©rifier que la langue est valide
            const validLangs = ['all', ...WIKISOURCES.map(w => w.lang)];
            selectedLang = validLangs.includes(savedLang) ? savedLang : 'all';
            console.log('init: langue =', selectedLang);
            
            const langSelect = document.getElementById('langSelect');
            if (langSelect) langSelect.value = selectedLang;
            
            updateStats();
            updateConnections();
            renderAchievements();
            renderReadingPath();
            renderFavorites();
            updateFavCount();
            updateFunStat();
            
            document.getElementById('loading').style.display = 'block';
            console.log('init: appel fillPool...');
            await fillPool();
            console.log('init: fillPool termin√©, pool =', state.textPool.length);
            document.getElementById('loading').style.display = 'none';
            console.log('init: appel loadMore...');
            await loadMore();
            console.log('init: termin√©');
            
            // Mise √† jour p√©riodique du fun stat
            setInterval(updateFunStat, 15000);
            
            window.onscroll = () => {
                document.getElementById('progress').style.width = 
                    (scrollY / (document.body.scrollHeight - innerHeight) * 100) + '%';
                if (innerHeight + scrollY >= document.body.scrollHeight - 800 && !state.loading) loadMore();
            };
        }

        function loadState() {
            try {
                const d = JSON.parse(localStorage.getItem('palimpseste') || '{}');
                state.likes = new Set(d.likes || []);
                state.readCount = d.readCount || 0;
                state.authorStats = d.authorStats || {};
                state.genreStats = d.genreStats || {};
                state.likedAuthors = new Set(d.likedAuthors || []);
                state.discoveredConnections = new Set(d.discoveredConnections || []);
                state.achievements = d.achievements || [];
                state.readingPath = d.readingPath || [];
                state.favorites = d.favorites || [];
                // Charger les stats de lecture
                state.readingStats = d.readingStats || {
                    totalWordsRead: 0,
                    totalReadingTime: 0,
                    streak: 0,
                    lastReadDate: null,
                    sessionsToday: 0,
                    bestStreak: 0,
                    dailyWords: {}
                };
                // V√©rifier et mettre √† jour le streak au chargement
                checkAndUpdateStreak();
            } catch(e) {}
        }

        function saveState() {
            localStorage.setItem('palimpseste', JSON.stringify({ 
                likes: [...state.likes], 
                readCount: state.readCount,
                authorStats: state.authorStats,
                genreStats: state.genreStats,
                likedAuthors: [...state.likedAuthors],
                discoveredConnections: [...state.discoveredConnections],
                achievements: state.achievements || [],
                readingPath: state.readingPath || [],
                favorites: state.favorites || [],
                readingStats: state.readingStats
            }));
            updateStats();
        }

        function updateStats() {
            // Mettre √† jour les stats du panneau
            document.getElementById('totalRead').textContent = state.readCount;
            document.getElementById('likeCountPanel').textContent = state.likes.size;
            document.getElementById('authorCount').textContent = Object.keys(state.authorStats).length;
            
            // Titre dynamique selon le contexte
            updateDynamicHeader();
            
            // Mettre √† jour les barres d'auteurs
            renderAuthorBars();
            renderGenreChart();
            
            // Mettre √† jour les statistiques de lecture
            updateReadingStatsUI();
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üìä STATISTIQUES DE LECTURE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        function getTodayKey() {
            return new Date().toISOString().split('T')[0];
        }
        
        function checkAndUpdateStreak() {
            const stats = state.readingStats;
            const today = getTodayKey();
            const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
            
            if (!stats.lastReadDate) {
                stats.streak = 0;
            } else if (stats.lastReadDate === today) {
                // D√©j√† lu aujourd'hui, streak maintenu
            } else if (stats.lastReadDate === yesterday) {
                // A lu hier, streak continue (sera incr√©ment√© quand il lit aujourd'hui)
            } else {
                // Streak cass√©
                stats.streak = 0;
            }
        }
        
        function recordReading(wordCount) {
            const stats = state.readingStats;
            const today = getTodayKey();
            const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
            
            // Ajouter les mots lus
            stats.totalWordsRead = (stats.totalWordsRead || 0) + wordCount;
            
            // Mots par jour
            if (!stats.dailyWords) stats.dailyWords = {};
            stats.dailyWords[today] = (stats.dailyWords[today] || 0) + wordCount;
            
            // G√©rer le streak
            if (stats.lastReadDate !== today) {
                // Premi√®re lecture du jour
                if (stats.lastReadDate === yesterday || !stats.lastReadDate) {
                    stats.streak = (stats.streak || 0) + 1;
                } else {
                    stats.streak = 1; // Recommencer le streak
                }
                stats.lastReadDate = today;
                stats.sessionsToday = 1;
                
                // Meilleur streak
                if (stats.streak > (stats.bestStreak || 0)) {
                    stats.bestStreak = stats.streak;
                    if (stats.streak >= 7) {
                        toast('üî• Streak record : ' + stats.streak + ' jours !');
                    }
                }
            } else {
                stats.sessionsToday = (stats.sessionsToday || 0) + 1;
            }
            
            saveState();
        }
        
        function startReadingTimer() {
            if (!sessionStartTime) {
                sessionStartTime = Date.now();
            }
        }
        
        function stopReadingTimer() {
            if (sessionStartTime) {
                const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
                state.readingStats.totalReadingTime = (state.readingStats.totalReadingTime || 0) + elapsed;
                sessionStartTime = null;
                saveState();
            }
        }
        
        function formatReadingTime(seconds) {
            if (seconds < 60) return seconds + ' sec';
            if (seconds < 3600) return Math.floor(seconds / 60) + ' min';
            const hours = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            return hours + 'h ' + mins + 'min';
        }
        
        function formatWordsCount(words) {
            if (words < 1000) return words.toString();
            if (words < 10000) return (words / 1000).toFixed(1) + 'k';
            return Math.floor(words / 1000) + 'k';
        }
        
        function updateReadingStatsUI() {
            const stats = state.readingStats;
            
            // Temps de lecture
            const timeEl = document.getElementById('totalReadingTime');
            if (timeEl) {
                timeEl.textContent = formatReadingTime(stats.totalReadingTime || 0);
            }
            
            // Mots lus
            const wordsEl = document.getElementById('totalWordsRead');
            if (wordsEl) {
                wordsEl.textContent = formatWordsCount(stats.totalWordsRead || 0);
            }
            
            // Streak
            const streakEl = document.getElementById('currentStreak');
            if (streakEl) {
                streakEl.textContent = stats.streak || 0;
            }
            
            // Barre de progression streak (objectif 7 jours)
            const progressEl = document.getElementById('streakProgress');
            if (progressEl) {
                const progress = Math.min(100, ((stats.streak || 0) / 7) * 100);
                progressEl.style.width = progress + '%';
            }
            
            // Hint streak
            const hintEl = document.getElementById('streakHint');
            if (hintEl) {
                const streak = stats.streak || 0;
                if (streak === 0) {
                    hintEl.textContent = 'Commencez √† lire pour d√©marrer votre streak !';
                } else if (streak < 3) {
                    hintEl.textContent = `${streak} jour${streak > 1 ? 's' : ''} - Continuez demain !`;
                } else if (streak < 7) {
                    hintEl.textContent = `üî• ${streak} jours ! Plus que ${7 - streak} pour la semaine compl√®te !`;
                } else if (streak < 30) {
                    hintEl.textContent = `üî•üî• ${streak} jours ! Vers le mois complet !`;
                } else {
                    hintEl.textContent = `üèÜ ${streak} jours ! Incroyable d√©votion !`;
                }
            }
            
            // Graphique hebdomadaire
            renderWeeklyChart();
        }
        
        function renderWeeklyChart() {
            const container = document.getElementById('weeklyChart');
            if (!container) return;
            
            const stats = state.readingStats;
            const dailyWords = stats.dailyWords || {};
            const days = ['L', 'M', 'M', 'J', 'V', 'S', 'D'];
            const today = new Date();
            
            // Obtenir les 7 derniers jours
            const weekData = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const key = date.toISOString().split('T')[0];
                const dayOfWeek = date.getDay();
                weekData.push({
                    key,
                    dayLabel: days[(dayOfWeek + 6) % 7], // Lundi = 0
                    words: dailyWords[key] || 0,
                    isToday: i === 0
                });
            }
            
            // Trouver le max pour normaliser
            const maxWords = Math.max(100, ...weekData.map(d => d.words));
            
            container.innerHTML = weekData.map(d => {
                const height = Math.max(4, (d.words / maxWords) * 45);
                const classes = ['weekly-bar'];
                if (d.words > 0) classes.push('active');
                if (d.isToday) classes.push('today');
                return `<div class="${classes.join(' ')}" style="height: ${height}px" data-day="${d.dayLabel}" title="${d.words} mots"></div>`;
            }).join('');
        }
        
        // D√©tecter quand l'utilisateur quitte la page
        window.addEventListener('beforeunload', stopReadingTimer);
        window.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopReadingTimer();
            } else {
                startReadingTimer();
            }
        });
        
        // Phrases d'en-t√™te dynamiques selon l'√©tat de l'exploration
        const HEADER_PHRASES = {
            start: [
                "Laissez-vous d√©river...",
                "Un texte vous attend...",
                "La biblioth√®que murmure...",
                "Plongez dans l'inconnu..."
            ],
            exploring: [
                "Le voyage continue...",
                "Vous vous enfoncez...",
                "Les pages tournent...",
                "Le labyrinthe s'ouvre..."
            ],
            deep: [
                "Vous √™tes loin du rivage...",
                "Les profondeurs vous appellent...",
                "Le temps se suspend...",
                "Bienvenue dans l'ab√Æme..."
            ],
            expert: [
                "Vous √™tes un √©rudit...",
                "Les auteurs vous reconnaissent...",
                "Le palimpseste se r√©v√®le...",
                "Ma√Ætre des mots anciens..."
            ]
        };
        
        function updateDynamicHeader() {
            const authorCount = Object.keys(state.authorStats).length;
            const readCount = state.readCount || 0;
            
            let phrases;
            if (readCount < 3) phrases = HEADER_PHRASES.start;
            else if (authorCount < 10) phrases = HEADER_PHRASES.exploring;
            else if (authorCount < 25) phrases = HEADER_PHRASES.deep;
            else phrases = HEADER_PHRASES.expert;
            
            const headerEl = document.getElementById('headerTitle');
            if (headerEl && Math.random() < 0.3) { // 30% de chance de changer
                headerEl.textContent = phrases[Math.floor(Math.random() * phrases.length)];
            }
        }
        
        function renderAuthorBars() {
            const container = document.getElementById('authorBars');
            const sorted = Object.entries(state.authorStats).sort((a, b) => b[1] - a[1]).slice(0, 8);
            const max = sorted[0]?.[1] || 1;
            const colors = ['#ff453a', '#ff9f0a', '#30d158', '#64d2ff', '#bf5af2', '#ff6482', '#ffd60a', '#ac8e68'];
            
            container.innerHTML = sorted.map(([author, count], i) => `
                <div class="author-bar">
                    <span class="author-bar-name">${author.split(' ').pop()}</span>
                    <div class="author-bar-track">
                        <div class="author-bar-fill" style="width: ${(count/max)*100}%; background: ${colors[i % colors.length]}"></div>
                    </div>
                    <span class="author-bar-count">${count}</span>
                </div>
            `).join('');
        }
        
        function renderGenreChart() {
            const container = document.getElementById('genreChart');
            container.innerHTML = Object.entries(state.genreStats).map(([genre, count]) => `
                <div class="genre-pill" onclick="exploreCategory('${genre}')" title="Explorer l'arborescence ${genre}">
                    <span class="genre-dot" style="background: ${GENRE_COLORS[genre] || '#6e6e73'}"></span>
                    ${genre} <strong>${count}</strong>
                </div>
            `).join('');
        }
        
        function trackStats(author, tag) {
            state.authorStats[author] = (state.authorStats[author] || 0) + 1;
            state.genreStats[tag] = (state.genreStats[tag] || 0) + 1;
            saveState();
        }
        
        // Construire dynamiquement les connexions entre auteurs
        // Les auteurs du m√™me genre sont connect√©s entre eux
        function buildAuthorConnections(author, tag) {
            if (!author || author === 'Anonyme') return;
            
            // Trouver les autres auteurs du m√™me genre
            const sameGenreAuthors = Object.keys(state.authorStats).filter(a => {
                // On consid√®re que les auteurs vus r√©cemment dans la m√™me session sont "connect√©s"
                return a !== author && a !== 'Anonyme';
            });
            
            // Ajouter des connexions bidirectionnelles
            if (!authorConnections[author]) authorConnections[author] = [];
            
            // Connecter avec les 5 derniers auteurs diff√©rents d√©couverts
            const recentAuthors = sameGenreAuthors.slice(-5);
            for (const other of recentAuthors) {
                if (!authorConnections[author].includes(other)) {
                    authorConnections[author].push(other);
                }
                if (!authorConnections[other]) authorConnections[other] = [];
                if (!authorConnections[other].includes(author)) {
                    authorConnections[other].push(author);
                }
            }
            
            // Limiter √† 10 connexions par auteur
            if (authorConnections[author].length > 10) {
                authorConnections[author] = authorConnections[author].slice(-10);
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üîç RECHERCHE - Fonctions de recherche avanc√©e
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        let searchResults = {
            wikisource: [],
            poetrydb: [],
            gutenberg: [],
            users: []
        };
        let currentSearchTab = 'all';
        let currentSearchQuery = '';
        
        // G√©rer l'affichage du bouton clear
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('searchInput');
            const searchClear = document.getElementById('searchClear');
            
            if (searchInput && searchClear) {
                searchInput.addEventListener('input', () => {
                    searchClear.classList.toggle('visible', searchInput.value.length > 0);
                });
            }
        });
        
        function clearSearch() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.value = '';
                document.getElementById('searchClear')?.classList.remove('visible');
                searchInput.focus();
            }
        }
        
        // Fonction pour la barre de recherche principale
        function performMainSearch() {
            const input = document.getElementById('mainSearchInput');
            if (!input) return;
            const query = input.value.trim();
            if (!query || query.length < 2) {
                toast('‚ö†Ô∏è Entrez au moins 2 caract√®res');
                return;
            }
            // R√©utiliser la logique de performSearch
            document.getElementById('searchInput').value = query;
            performSearch();
        }
        
        async function performSearch() {
            const mainInput = document.getElementById('mainSearchInput');
            const headerInput = document.getElementById('searchInput');
            const query = (mainInput?.value || headerInput?.value || '').trim();
            
            if (!query || query.length < 2) {
                toast('‚ö†Ô∏è Entrez au moins 2 caract√®res');
                return;
            }
            
            currentSearchQuery = query;
            
            // Afficher l'overlay avec loading
            const overlay = document.getElementById('searchResultsOverlay');
            const grid = document.getElementById('searchResultsGrid');
            const tabs = document.getElementById('searchResultsTabs');
            
            document.getElementById('searchQueryDisplay').textContent = query;
            overlay.classList.add('open');
            
            grid.innerHTML = '<div class="search-loading"><div class="spinner"></div><p>Recherche en cours...</p></div>';
            tabs.innerHTML = '';
            
            // R√©initialiser les r√©sultats
            searchResults = { wikisource: [], poetrydb: [], gutenberg: [], users: [] };
            
            // Lancer les recherches en parall√®le
            toast('üîç Recherche...');
            
            await Promise.all([
                searchWikisource(query),
                searchPoetryDB(query),
                searchGutenberg(query),
                searchUsers(query)
            ]);
            
            // Afficher les r√©sultats
            renderSearchTabs();
            renderSearchResults('all');
        }
        
        // Recherche d'utilisateurs sur Palimpseste
        async function searchUsers(query) {
            if (!supabaseClient) return;
            
            try {
                const { data: users } = await supabaseClient
                    .from('profiles')
                    .select('id, username, created_at')
                    .ilike('username', `%${query}%`)
                    .limit(20);
                
                if (users && users.length > 0) {
                    // Charger qui on suit
                    await loadUserFollowing();
                    
                    // Compter les extraits pour chaque user
                    searchResults.users = await Promise.all(users.map(async (u) => {
                        const { count } = await supabaseClient
                            .from('extraits')
                            .select('*', { count: 'exact', head: true })
                            .eq('user_id', u.id);
                        return {
                            ...u,
                            extraitCount: count || 0,
                            source: 'users'
                        };
                    }));
                }
            } catch (e) {
                console.error('User search error:', e);
            }
        }
        
        async function searchWikisource(query) {
            try {
                const wikisources = getActiveWikisources();
                const promises = wikisources.map(ws => 
                    fetch(`${ws.url}/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(query)}&srlimit=15&srnamespace=0&format=json&origin=*`)
                        .then(res => res.json())
                        .then(data => {
                            return (data.query?.search || []).map(r => ({
                                title: r.title,
                                snippet: r.snippet || '',
                                source: 'wikisource',
                                lang: ws.lang,
                                wikisource: ws
                            }));
                        })
                        .catch(() => [])
                );
                
                const results = await Promise.all(promises);
                searchResults.wikisource = results.flat();
            } catch (e) {
                console.error('Wikisource search error:', e);
            }
        }
        
        async function searchPoetryDB(query) {
            try {
                // Recherche par auteur
                const authorRes = await fetch(`https://poetrydb.org/author/${encodeURIComponent(query)}`);
                let authorData = [];
                if (authorRes.ok) {
                    const data = await authorRes.json();
                    if (Array.isArray(data)) {
                        authorData = data.slice(0, 10).map(p => ({
                            title: p.title,
                            author: p.author,
                            snippet: p.lines?.slice(0, 3).join(' / ') || '',
                            lines: p.lines,
                            source: 'poetrydb',
                            lang: 'en'
                        }));
                    }
                }
                
                // Recherche par titre
                const titleRes = await fetch(`https://poetrydb.org/title/${encodeURIComponent(query)}`);
                let titleData = [];
                if (titleRes.ok) {
                    const data = await titleRes.json();
                    if (Array.isArray(data)) {
                        titleData = data.slice(0, 10).map(p => ({
                            title: p.title,
                            author: p.author,
                            snippet: p.lines?.slice(0, 3).join(' / ') || '',
                            lines: p.lines,
                            source: 'poetrydb',
                            lang: 'en'
                        }));
                    }
                }
                
                // Combiner et d√©dupliquer
                const combined = [...authorData, ...titleData];
                const seen = new Set();
                searchResults.poetrydb = combined.filter(p => {
                    const key = p.title + p.author;
                    if (seen.has(key)) return false;
                    seen.add(key);
                    return true;
                });
            } catch (e) {
                console.error('PoetryDB search error:', e);
            }
        }
        
        async function searchGutenberg(query) {
            try {
                const res = await fetch(`https://gutendex.com/books?search=${encodeURIComponent(query)}`);
                const data = await res.json();
                
                searchResults.gutenberg = (data.results || []).slice(0, 15).map(book => ({
                    title: book.title,
                    author: book.authors?.map(a => a.name).join(', ') || 'Inconnu',
                    snippet: book.subjects?.slice(0, 3).join(' ‚Ä¢ ') || '',
                    id: book.id,
                    source: 'gutenberg',
                    lang: book.languages?.[0] || 'en',
                    formats: book.formats
                }));
            } catch (e) {
                console.error('Gutenberg search error:', e);
            }
        }
        
        function renderSearchTabs() {
            const tabs = document.getElementById('searchResultsTabs');
            const totalAll = searchResults.wikisource.length + searchResults.poetrydb.length + searchResults.gutenberg.length;
            const usersCount = searchResults.users?.length || 0;
            
            tabs.innerHTML = `
                <button class="search-tab ${currentSearchTab === 'users' ? 'active' : ''}" onclick="switchSearchTab('users')">
                    üë• Utilisateurs <span class="count">${usersCount}</span>
                </button>
                <button class="search-tab ${currentSearchTab === 'all' ? 'active' : ''}" onclick="switchSearchTab('all')">
                    üìö Textes <span class="count">${totalAll}</span>
                </button>
                <button class="search-tab ${currentSearchTab === 'wikisource' ? 'active' : ''}" onclick="switchSearchTab('wikisource')">
                    üìú Wikisource <span class="count">${searchResults.wikisource.length}</span>
                </button>
                <button class="search-tab ${currentSearchTab === 'poetrydb' ? 'active' : ''}" onclick="switchSearchTab('poetrydb')">
                    üé≠ Po√©sie <span class="count">${searchResults.poetrydb.length}</span>
                </button>
                <button class="search-tab ${currentSearchTab === 'gutenberg' ? 'active' : ''}" onclick="switchSearchTab('gutenberg')">
                    üìñ Gutenberg <span class="count">${searchResults.gutenberg.length}</span>
                </button>
            `;
        }
        
        function switchSearchTab(tab) {
            currentSearchTab = tab;
            renderSearchTabs();
            renderSearchResults(tab);
        }
        
        function renderSearchResults(tab) {
            const grid = document.getElementById('searchResultsGrid');
            
            // Si onglet utilisateurs
            if (tab === 'users') {
                const users = searchResults.users || [];
                
                if (users.length === 0) {
                    grid.innerHTML = `
                        <div class="search-no-results">
                            <div class="search-no-results-icon">üë§</div>
                            <p>Aucun utilisateur trouv√© pour "${escapeHtml(currentSearchQuery)}"</p>
                            <p style="font-size: 0.8rem; margin-top: 0.5rem;">V√©rifiez l'orthographe du pseudo</p>
                        </div>
                    `;
                    return;
                }
                
                grid.innerHTML = `
                    <div class="discover-grid" style="padding: 0.5rem;">
                        ${users.map(u => {
                            const initial = (u.username || '?').charAt(0).toUpperCase();
                            const isFollowing = userFollowing.has(u.id);
                            const isMe = currentUser && u.id === currentUser.id;
                            return `
                                <div class="discover-card">
                                    <div class="discover-avatar" onclick="openUserProfile('${u.id}', '${u.username}')">${initial}</div>
                                    <div class="discover-info" onclick="openUserProfile('${u.id}', '${u.username}')">
                                        <div class="discover-name">${escapeHtml(u.username || 'Anonyme')}</div>
                                        <div class="discover-stats">${u.extraitCount} extrait${u.extraitCount > 1 ? 's' : ''}</div>
                                    </div>
                                    ${!isMe ? `
                                        <button class="btn-follow-small ${isFollowing ? 'following' : ''}" onclick="toggleFollowFromSearch('${u.id}', event)">
                                            ${isFollowing ? '‚úì Suivi' : '+ Suivre'}
                                        </button>
                                    ` : '<span style="color:var(--muted);font-size:0.8rem;">C\'est vous</span>'}
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                return;
            }
            
            let results = [];
            if (tab === 'all') {
                results = [
                    ...searchResults.wikisource,
                    ...searchResults.poetrydb,
                    ...searchResults.gutenberg
                ];
            } else {
                results = searchResults[tab] || [];
            }
            
            if (results.length === 0) {
                grid.innerHTML = `
                    <div class="search-no-results">
                        <div class="search-no-results-icon">üì≠</div>
                        <p>Aucun r√©sultat pour "${escapeHtml(currentSearchQuery)}"</p>
                        <p style="font-size: 0.8rem; margin-top: 0.5rem;">Essayez avec d'autres mots-cl√©s ou un nom d'auteur</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = results.map((r, idx) => {
                const sourceIcon = r.source === 'wikisource' ? 'üìú' : r.source === 'poetrydb' ? 'üé≠' : 'üìñ';
                const sourceName = r.source === 'wikisource' ? 'Wikisource' : r.source === 'poetrydb' ? 'PoetryDB' : 'Gutenberg';
                const author = r.author || extractAuthorFromTitle(r.title) || '';
                
                // Nettoyer le snippet HTML
                let snippet = r.snippet || '';
                snippet = snippet.replace(/<[^>]*>/g, '').replace(/&quot;/g, '"').replace(/&amp;/g, '&');
                
                // Highlight query dans le snippet
                const queryRegex = new RegExp(`(${escapeRegex(currentSearchQuery)})`, 'gi');
                snippet = snippet.replace(queryRegex, '<mark>$1</mark>');
                
                return `
                    <div class="search-result-card" onclick="openSearchResult(${idx}, '${r.source}')">
                        <div class="search-result-title">${escapeHtml(r.title)}</div>
                        ${author ? `<div class="search-result-author">${escapeHtml(author)}</div>` : ''}
                        <div class="search-result-snippet">${snippet}</div>
                        <div class="search-result-meta">
                            <span class="search-result-source">${sourceIcon} ${sourceName}</span>
                            ${r.lang ? `<span>üåê ${r.lang.toUpperCase()}</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Follow depuis la recherche
        async function toggleFollowFromSearch(userId, event) {
            event.stopPropagation();
            await toggleFollow(userId);
            // Re-render les r√©sultats pour mettre √† jour les boutons
            renderSearchResults(currentSearchTab);
        }
        
        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        function extractAuthorFromTitle(title) {
            // Essayer d'extraire l'auteur depuis des patterns courants
            const patterns = [
                /^(.+?)\s*[-‚Äì‚Äî]\s*(.+)$/,  // "Titre - Auteur" ou "Auteur - Titre"
                /\(([^)]+)\)$/,             // "Titre (Auteur)"
                /by\s+(.+)$/i               // "Title by Author"
            ];
            
            for (const pattern of patterns) {
                const match = title.match(pattern);
                if (match) {
                    const candidate = match[1] || match[2];
                    // V√©rifier si √ßa ressemble √† un nom d'auteur
                    if (candidate && candidate.length < 50 && /^[A-Za-z√Ä-√ø\s.'-]+$/.test(candidate)) {
                        return candidate.trim();
                    }
                }
            }
            return null;
        }
        
        async function openSearchResult(idx, source) {
            let result;
            if (currentSearchTab === 'all') {
                const allResults = [
                    ...searchResults.wikisource,
                    ...searchResults.poetrydb,
                    ...searchResults.gutenberg
                ];
                result = allResults[idx];
            } else {
                result = searchResults[currentSearchTab]?.[idx];
            }
            
            if (!result) return;
            
            closeSearchResults();
            toast('üìñ Chargement...');
            
            if (result.source === 'wikisource') {
                // Charger le texte depuis Wikisource
                const text = await fetchText(result.title, 0, result.wikisource);
                if (text) {
                    document.getElementById('feed').innerHTML = '';
                    state.cardIdx = 0;
                    renderCard(text, result.title, result.wikisource);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    toast('‚ùå Impossible de charger ce texte');
                }
            } else if (result.source === 'poetrydb') {
                // Afficher directement le po√®me
                document.getElementById('feed').innerHTML = '';
                state.cardIdx = 0;
                renderCard({
                    title: result.title,
                    text: result.lines?.join('\n') || result.snippet,
                    author: result.author,
                    source: 'poetrydb'
                }, result.title, { lang: 'en', url: 'https://poetrydb.org', name: 'PoetryDB' });
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else if (result.source === 'gutenberg') {
                // Ouvrir le livre sur Gutenberg
                const readUrl = `https://www.gutenberg.org/ebooks/${result.id}`;
                window.open(readUrl, '_blank');
                toast('üìñ Ouverture sur Project Gutenberg');
            }
        }
        
        function closeSearchResults() {
            document.getElementById('searchResultsOverlay').classList.remove('open');
        }
        
        async function shuffleFeed() {
            document.getElementById('feed').innerHTML = '';
            state.textPool = [];
            state.shownPages.clear();
            state.cardIdx = 0;
            toast('Nouveaux textes...');
            await fillPool();
            await loadMore();
        }

        function toast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }

        async function loadMore() {
            if (state.loading) return;
            state.loading = true;
            document.getElementById('loading').style.display = 'block';
            
            console.log('loadMore: d√©marrage, pool =', state.textPool.length);

            let loaded = 0, attempts = 0;
            while (loaded < 3 && attempts < 15) {
                attempts++;
                // Ne pas refill en mode exploration de cat√©gorie!
                const isExploringCategory = currentCategoryPath.length > 0;
                if (state.textPool.length < 3 && !isExploringCategory) {
                    console.log('loadMore: refill pool...');
                    await fillPool();
                }
                if (state.textPool.length === 0) {
                    console.log('loadMore: pool vide apr√®s fillPool');
                    break;
                }
                
                const item = state.textPool.shift();
                const itemKey = (item.source === 'poetrydb' ? 'poetrydb:' : '') + item.title;
                console.log('loadMore: tentative', item.title, item.source || 'wikisource');
                if (state.shownPages.has(itemKey)) continue;
                
                // Si c'est un item pr√©-charg√© (PoetryDB), on l'affiche directement
                if (item.isPreloaded && item.text) {
                    state.shownPages.add(itemKey);
                    renderCard({
                        title: item.title,
                        text: item.text,
                        author: item.author,
                        source: item.source
                    }, item.title, { lang: item.lang, url: 'https://poetrydb.org', name: 'PoetryDB' });
                    loaded++;
                    console.log('üìú PoetryDB carte rendue:', item.title);
                    continue;
                }
                
                // Sinon, r√©cup√©rer depuis Wikisource
                const ws = item.wikisource || currentWikisource;
                const result = await fetchText(item.title, 0, ws);
                if (result?.text?.length > 150) {
                    state.shownPages.add(itemKey);
                    renderCard(result, item.title, ws);
                    loaded++;
                    console.log('loadMore: carte rendue', item.title);
                } else {
                    console.log('loadMore: texte trop court ou null', result?.text?.length);
                }
            }
            
            console.log('loadMore: fin, loaded =', loaded);

            document.getElementById('loading').style.display = 'none';
            state.loading = false;
        }

        function renderCard(result, origTitle, wikisource = currentWikisource) {
            let title = result.title || origTitle;
            // Nettoyage agressif du titre
            title = title
                .replace(/<[^>]+>/g, '')  // Supprimer tout HTML
                .replace(/mw-page-title[^\s]*/gi, '')  // Supprimer classes MW
                .replace(/Liste des [^\/]*/gi, '')  // Supprimer "Liste des..."
                .replace(/par ordre alphab√©tique/gi, '')
                .replace(/span class/gi, '')
                .replace(/\s+/g, ' ')
                .trim();
            
            // Si le titre est invalide, ne pas afficher cette carte
            if (!isValidTitle(title)) return;
            
            const text = result.text;
            const lang = wikisource?.lang || 'fr';
            // Utiliser l'auteur des m√©tadonn√©es en priorit√©
            const author = detectAuthor(title, text, result.author);
            const tag = detectTag(title, text);
            const url = `${wikisource?.url || 'https://fr.wikisource.org'}/wiki/${encodeURIComponent(origTitle)}`;
            const cardId = 'card-' + (state.cardIdx++);
            
            // Extraire un titre propre pour l'affichage
            let displayTitle = title.split('/').pop() || title.split('/')[0];
            // Si c'est un titre g√©n√©rique, prendre la premi√®re partie
            if (displayTitle.length < 3) displayTitle = title.split('/')[0];
            // Supprimer les parenth√®ses avec l'auteur si redondant
            displayTitle = displayTitle.replace(/\s*\([^)]*\)\s*$/, '').trim();
            // Si displayTitle est vide ou trop court apr√®s nettoyage, utiliser le titre original
            if (displayTitle.length < 3) displayTitle = title.split('/')[0] || 'Texte sans titre';
            
            // Badge de langue
            const langBadge = lang !== 'fr' ? `<span class="lang-badge">${lang.toUpperCase()}</span>` : '';
            
            // Tracker les stats et construire les connexions
            trackStats(author, tag);
            buildAuthorConnections(author, tag);

            // D√©couper le texte en teaser + suite
            const TEASER_LENGTH = 350;
            const CHUNK_LENGTH = 600;
            let teaser = text;
            let remaining = '';
            
            if (text.length > TEASER_LENGTH) {
                // Couper proprement sur une phrase ou un retour √† la ligne
                let cutPoint = text.lastIndexOf('. ', TEASER_LENGTH);
                if (cutPoint < TEASER_LENGTH * 0.5) cutPoint = text.lastIndexOf('\n', TEASER_LENGTH);
                if (cutPoint < TEASER_LENGTH * 0.5) cutPoint = text.lastIndexOf(' ', TEASER_LENGTH);
                if (cutPoint < TEASER_LENGTH * 0.5) cutPoint = TEASER_LENGTH;
                teaser = text.substring(0, cutPoint + 1).trim();
                remaining = text.substring(cutPoint + 1).trim();
            }
            
            const card = document.createElement('div');
            card.className = 'card';
            card.id = cardId;
            card.innerHTML = `
                <div class="card-head" onclick="showRelatedAuthors('${cardId}')" style="cursor:pointer;" title="Cliquer pour d√©couvrir des auteurs proches">
                    <div>
                        <div class="author">${esc(author)} ${langBadge} <span class="explore-hint">üï∏Ô∏è</span></div>
                        <div class="work">${esc(displayTitle)}</div>
                    </div>
                    <span class="tag ${tag}" onclick="event.stopPropagation(); exploreCategory('${tag}')" title="Explorer ce genre">${tag}</span>
                </div>
                <div class="card-body">
                    <div class="text-teaser">${esc(teaser)}</div>
                    <div class="text-full" id="full-${cardId}"></div>
                    ${remaining ? `<button class="btn-suite" onclick="showMore('${cardId}')" id="suite-${cardId}">Lire la suite<span class="arrow">‚Üí</span></button>` : ''}
                </div>
                <div class="related-authors" id="related-${cardId}" style="display:none;"></div>
                <div class="card-foot">
                    <div class="actions">
                        <button class="btn" onclick="toggleLike('${cardId}',this)">‚ô•</button>
                        <button class="btn btn-share" onclick="shareCardExtrait('${cardId}')" title="Partager cet extrait">üê¶ Partager</button>
                        <button class="btn" onclick="showRelatedAuthors('${cardId}')" title="Explorer auteurs proches">üîó</button>
                        <a class="btn" href="${url}" target="_blank">‚Üó Wikisource</a>
                    </div>
                </div>
            `;
            card.dataset.title = title;
            card.dataset.author = author;
            card.dataset.text = text;
            card.dataset.remaining = remaining;
            card.dataset.shown = '0';
            card.dataset.tag = tag;
            card.dataset.lang = lang;
            card.dataset.chunkSize = CHUNK_LENGTH;
            document.getElementById('feed').appendChild(card);
            setTimeout(() => card.classList.add('show'), 50);
            
            // Tracker les mots du teaser comme lus
            const teaserWords = teaser.split(/\s+/).filter(w => w.length > 0).length;
            recordReading(teaserWords);
            startReadingTimer();
        }

        function esc(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>'); }
        
        // Afficher la suite du texte - tout d'un coup au premier clic
        function showMore(cardId) {
            const card = document.getElementById(cardId);
            if (!card) return;
            
            const fullEl = document.getElementById('full-' + cardId);
            const btnEl = document.getElementById('suite-' + cardId);
            if (!fullEl || !btnEl) return;
            
            let remaining = card.dataset.remaining || '';
            
            if (!remaining) {
                btnEl.innerHTML = '‚úì Texte complet';
                btnEl.classList.add('exhausted');
                btnEl.onclick = null;
                return;
            }
            
            // Afficher TOUT le texte restant d'un coup
            const chunkEl = document.createElement('div');
            chunkEl.className = 'text-chunk';
            chunkEl.style.animation = 'fadeIn 0.4s ease';
            chunkEl.innerHTML = esc(remaining);
            fullEl.appendChild(chunkEl);
            fullEl.classList.add('visible');
            
            // Tracker les mots lus
            const wordCount = remaining.split(/\s+/).filter(w => w.length > 0).length;
            recordReading(wordCount);
            startReadingTimer();
            
            // Marquer comme complet
            card.dataset.remaining = '';
            
            // Mettre √† jour le bouton
            btnEl.innerHTML = '‚úì Texte complet';
            btnEl.classList.add('exhausted');
            btnEl.onclick = null;
            
            // Scroll doux vers le nouveau contenu
            setTimeout(() => chunkEl.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
        }
        
        function toggleLike(id, btn) {
            const card = document.getElementById(id);
            const author = card?.dataset?.author;
            const title = card?.dataset?.title;
            const text = card?.dataset?.text;
            
            if (state.likes.has(id)) { 
                state.likes.delete(id); 
                // Supprimer des favoris stock√©s
                state.favorites = (state.favorites || []).filter(f => f.id !== id);
                btn.classList.remove('active');
                // Retirer l'auteur des likedAuthors si plus aucune carte lik√©e
                if (author && author !== 'Anonyme') {
                    const hasOtherLikes = [...state.likes].some(likeId => {
                        const c = document.getElementById(likeId);
                        return c?.dataset?.author === author;
                    });
                    if (!hasOtherLikes) state.likedAuthors.delete(author);
                }
            } else { 
                state.likes.add(id); 
                // Ajouter aux favoris stock√©s
                if (!state.favorites) state.favorites = [];
                state.favorites.push({
                    id: id,
                    title: title,
                    author: author,
                    text: text?.substring(0, 200) || '',
                    timestamp: Date.now()
                });
                btn.classList.add('active'); 
                toast('üíé Ajout√© aux favoris');
                // Ajouter l'auteur aux likedAuthors
                if (author && author !== 'Anonyme') {
                    state.likedAuthors.add(author);
                }
            }
            saveState();
            updateConnections();
            renderFavorites();
            updateFavCount();
        }
        
        // Afficher la liste des favoris dans le panneau
        function renderFavorites() {
            const container = document.getElementById('favoritesList');
            if (!container) return;
            
            const favorites = state.favorites || [];
            
            if (favorites.length === 0) {
                container.innerHTML = '<div class="favorites-empty">Cliquez ‚ô• pour sauvegarder</div>';
                return;
            }
            
            // Trier par date (plus r√©cent d'abord)
            const sorted = [...favorites].sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            
            container.innerHTML = sorted.map(fav => `
                <div class="favorite-item" onclick="scrollToCard('${fav.id}')">
                    <div class="favorite-content">
                        <div class="favorite-title">${esc(fav.title?.split('/').pop() || fav.title || 'Sans titre')}</div>
                        <div class="favorite-author">${esc(fav.author || 'Anonyme')}</div>
                        <div class="favorite-preview">${esc(fav.text || '')}</div>
                    </div>
                    <button class="favorite-remove" onclick="event.stopPropagation(); removeFavorite('${fav.id}')" title="Retirer">‚úï</button>
                </div>
            `).join('');
        }
        
        function scrollToCard(cardId) {
            const card = document.getElementById(cardId);
            if (card) {
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                card.style.boxShadow = '0 0 30px rgba(255,69,58,0.5)';
                setTimeout(() => card.style.boxShadow = '', 2000);
            }
        }
        
        function removeFavorite(id) {
            state.likes.delete(id);
            state.favorites = (state.favorites || []).filter(f => f.id !== id);
            const btn = document.querySelector(`#${id} .btn.active`);
            if (btn) btn.classList.remove('active');
            saveState();
            renderFavorites();
            updateFavCount();
            toast('Retir√© des favoris');
        }
        
        // === VUE FAVORIS COMPL√àTE ===
        function openFavoritesView() {
            const overlay = document.getElementById('favoritesOverlay');
            const grid = document.getElementById('favoritesGrid');
            if (!overlay || !grid) return;
            
            const favorites = state.favorites || [];
            
            if (favorites.length === 0) {
                grid.innerHTML = `
                    <div class="fav-empty">
                        <div class="fav-empty-icon">‚ô•</div>
                        <div class="fav-empty-text">Aucun favori pour l'instant</div>
                        <p style="margin-top: 1rem; color: var(--muted); font-size: 0.9rem;">
                            Cliquez sur le c≈ìur ‚ô• d'un texte pour le sauvegarder ici
                        </p>
                    </div>
                `;
            } else {
                const sorted = [...favorites].sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                
                grid.innerHTML = sorted.map(fav => `
                    <div class="fav-card">
                        <div class="fav-card-head">
                            <div>
                                <div class="fav-card-author">${esc(fav.author || 'Anonyme')}</div>
                                <div class="fav-card-title">${esc(fav.title?.split('/').pop() || fav.title || 'Sans titre')}</div>
                            </div>
                        </div>
                        <div class="fav-card-text">${esc(fav.text || '').substring(0, 500)}${(fav.text?.length || 0) > 500 ? '...' : ''}</div>
                        <div class="fav-card-actions">
                            <button class="btn" onclick="openFavInReader('${fav.id}')">Lire</button>
                            <button class="btn" onclick="removeFavoriteFromView('${fav.id}')">Retirer</button>
                        </div>
                    </div>
                `).join('');
            }
            
            overlay.classList.add('open');
            document.body.style.overflow = 'hidden';
        }
        
        function closeFavoritesView() {
            const overlay = document.getElementById('favoritesOverlay');
            if (overlay) {
                overlay.classList.remove('open');
                document.body.style.overflow = '';
            }
        }
        
        function openFavInReader(id) {
            const fav = (state.favorites || []).find(f => f.id === id);
            if (fav) {
                closeFavoritesView();
                // Chercher la carte dans le feed ou cr√©er une vue reader
                const card = document.getElementById(id);
                if (card) {
                    const btn = card.querySelector('.read-more-btn');
                    if (btn) btn.click();
                    else {
                        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                } else {
                    // Ouvrir directement dans le reader avec le texte sauvegard√©
                    openReaderWithFav(fav);
                }
            }
        }
        
        function openReaderWithFav(fav) {
            const overlay = document.getElementById('readerOverlay');
            const content = document.getElementById('readerContent');
            if (!overlay || !content) return;
            
            content.innerHTML = `
                <div style="text-align:center; margin-bottom: 3rem;">
                    <div style="font-family: 'Playfair Display', serif; font-size: 1.5rem; font-weight: 600;">${esc(fav.author || 'Anonyme')}</div>
                    <div style="color: var(--muted); font-style: italic; margin-top: 0.5rem;">${esc(fav.title?.split('/').pop() || fav.title || '')}</div>
                </div>
                <div style="white-space: pre-wrap; text-align: justify;">${esc(fav.text || 'Texte non disponible')}</div>
            `;
            
            overlay.classList.add('open');
            document.body.style.overflow = 'hidden';
        }
        
        function removeFavoriteFromView(id) {
            removeFavorite(id);
            // Re-render la vue favoris
            openFavoritesView();
        }
        
        function updateFavCount() {
            const countEl = document.getElementById('favCount');
            if (countEl) {
                const count = (state.favorites || []).length;
                countEl.textContent = count;
            }
        }
        
        // Trouver les auteurs connexes bas√©s sur les favoris et les d√©couvertes
        function getConnectedAuthors() {
            const connected = new Map(); // auteur -> source(s)
            
            // Utiliser les auteurs d√©couverts comme base de recommandation
            // Un auteur "similaire" est un auteur lu dans la m√™me session mais pas encore lik√©
            for (const likedAuthor of state.likedAuthors) {
                // Chercher des auteurs d√©couverts r√©cemment (dans authorConnections dynamique)
                const connections = authorConnections[likedAuthor] || [];
                for (const connectedAuthor of connections) {
                    // Ne pas recommander un auteur d√©j√† lu/lik√©
                    if (state.likedAuthors.has(connectedAuthor)) continue;
                    if (state.discoveredConnections.has(connectedAuthor)) continue;
                    
                    if (!connected.has(connectedAuthor)) {
                        connected.set(connectedAuthor, []);
                    }
                    connected.get(connectedAuthor).push(likedAuthor);
                }
            }
            
            // Trier par nombre de connexions (auteurs recommand√©s par plusieurs sources d'abord)
            return [...connected.entries()]
                .sort((a, b) => b[1].length - a[1].length)
                .slice(0, 6);
        }
        
        // Mettre √† jour l'affichage des connexions
        function updateConnections() {
            const connected = getConnectedAuthors();
            const section = document.getElementById('connectionsSection');
            const graph = document.getElementById('connectionGraph');
            const recoBanner = document.getElementById('recoBanner');
            const recoAuthors = document.getElementById('recoAuthors');
            
            if (connected.length === 0) {
                section.style.display = 'none';
                recoBanner.style.display = 'none';
                return;
            }
            
            // Afficher la section dans le panneau
            section.style.display = 'block';
            graph.innerHTML = connected.map(([author, sources]) => {
                const isDiscovered = state.discoveredConnections.has(author);
                const sourceList = sources.join(', ');
                return `
                    <div class="connection-node ${isDiscovered ? 'discovered' : ''}" 
                         onclick="exploreAuthor('${author.replace(/'/g, "\\'")}')">
                        <span class="connection-dot"></span>
                        <span>${author}</span>
                    </div>
                    <div class="connection-label">via ${sourceList}</div>
                `;
            }).join('');
            
            // Afficher la banni√®re de recommandation
            recoBanner.style.display = 'block';
            recoAuthors.innerHTML = connected.slice(0, 4).map(([author]) => `
                <span class="reco-author" onclick="exploreAuthor('${author.replace(/'/g, "\\'")}')">${author}</span>
            `).join('');
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üï∏Ô∏è AFFICHER LES AUTEURS LI√âS √Ä UN TEXTE (clic sur carte)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function showRelatedAuthors(cardId) {
            const card = document.getElementById(cardId);
            if (!card) return;
            
            const author = card.dataset.author;
            const container = document.getElementById('related-' + cardId);
            
            // Toggle : si d√©j√† visible, cacher
            if (container.style.display !== 'none') {
                container.style.display = 'none';
                return;
            }
            
            // Trouver les auteurs connect√©s (dynamiquement d√©couverts)
            const connected = authorConnections[author] || [];
            
            // Ajouter des suggestions bas√©es sur le genre
            const tag = card.dataset.tag;
            const genreAuthors = getAuthorsForGenre(tag, author);
            
            // Combiner et d√©dupliquer
            const allRelated = [...new Set([...connected, ...genreAuthors])].slice(0, 6);
            
            if (allRelated.length === 0) {
                container.innerHTML = `<div class="no-related">Aucune connexion connue. <button class="btn btn-small" onclick="randomJump()">üé≤ Hasard</button></div>`;
            } else {
                container.innerHTML = `
                    <div class="related-title">üï∏Ô∏è Auteurs proches de ${author.split(' ').pop()}</div>
                    <div class="related-list">
                        ${allRelated.map(a => `
                            <button class="related-btn" onclick="exploreAuthor('${a.replace(/'/g, "\\'")}')">
                                ${a.split(' ').pop()}
                            </button>
                        `).join('')}
                    </div>
                `;
            }
            
            container.style.display = 'block';
            toast(`${allRelated.length} auteur(s) √† explorer`);
        }
        
        // Trouver des auteurs du m√™me genre (classiques mondiaux + dynamique)
        function getAuthorsForGenre(genre, excludeAuthor) {
            // Auteurs classiques par genre (mix mondial)
            const genreMap = {
                'po√©sie': ['Baudelaire', 'Rimbaud', 'Shakespeare', 'Goethe', 'Dante', 'Petrarca', 'Pushkin', 'Neruda'],
                'poetry': ['Shakespeare', 'Keats', 'Byron', 'Wordsworth', 'Dickinson', 'Whitman', 'Poe'],
                'th√©√¢tre': ['Moli√®re', 'Shakespeare', 'Goethe', 'Calder√≥n', 'Goldoni', 'Chekhov'],
                'drama': ['Shakespeare', 'Marlowe', 'Ibsen', 'Chekhov', 'Wilde'],
                'roman': ['Balzac', 'Dickens', 'Dostoevsky', 'Tolstoy', 'Cervantes', 'Mann'],
                'novel': ['Dickens', 'Austen', 'Bront√´', 'Twain', 'Melville', 'James'],
                'conte': ['Perrault', 'Grimm', 'Andersen', 'Maupassant'],
                'tale': ['Grimm', 'Andersen', 'Wilde', 'Poe'],
                'fable': ['La Fontaine', '√âsope', 'Aesop', 'Krylov'],
                'texte': ['Hugo', 'Goethe', 'Dante', 'Cervantes'],
                'text': ['Milton', 'Bunyan', 'Swift', 'Defoe']
            };
            
            // Ajouter les auteurs d√©couverts dynamiquement pour ce genre
            const discovered = Object.keys(state.authorStats);
            const baseList = genreMap[genre?.toLowerCase()] || [];
            const combined = [...baseList, ...discovered];
            
            return [...new Set(combined)]
                .filter(a => a !== excludeAuthor && a !== 'Anonyme')
                .sort(() => Math.random() - 0.5)
                .slice(0, 4);
        }
        
        // Explorer un auteur sp√©cifique (recherche cibl√©e)
        async function exploreAuthor(author) {
            toast(`Exploration de ${author}...`);
            state.discoveredConnections.add(author);
            saveState();
            
            // Recherches sp√©cifiques pour cet auteur
            const searches = [`${author} poem`, `${author} text`, `${author} sonnet`];
            
            // Utiliser les wikisources actives selon le filtre
            const activeSources = getActiveWikisources();
            const shuffledWS = [...activeSources].sort(() => Math.random() - 0.5).slice(0, Math.min(3, activeSources.length));
            
            for (const ws of shuffledWS) {
                for (const query of searches) {
                    const results = await searchTexts(query, 3, ws);
                    for (const r of results) {
                        if (!state.shownPages.has(r.title) && isValidTitle(r.title)) {
                            state.textPool.unshift({ ...r, wikisource: ws }); // Ajouter en priorit√©
                        }
                    }
                }
            }
            
            // Charger imm√©diatement
            await loadMore();
            updateConnections();
            
            // Scroll vers le nouveau contenu
            window.scrollTo({ top: document.body.scrollHeight - window.innerHeight - 400, behavior: 'smooth' });
        }

        function openReader(id) {
            const card = document.getElementById(id);
            if (!card) return;
            const author = card.dataset.author;
            const title = card.dataset.title;
            const text = card.dataset.text || '';
            document.getElementById('readerTitle').textContent = `${author} ‚Äî ${title.split('/')[0]}`;
            document.getElementById('readerContent').innerHTML = esc(text);
            document.getElementById('reader').classList.add('open');
            document.body.style.overflow = 'hidden';
            state.readCount++;
            
            // Tracker les mots lus
            const wordCount = text.split(/\s+/).filter(w => w.length > 0).length;
            recordReading(wordCount);
            startReadingTimer();
            
            saveState();
            
            // Fonctionnalit√©s fun
            addToReadingPath(author, title);
            checkAchievements();
            updateFunStat();
            updateStats();
        }

        function closeReader() {
            document.getElementById('reader').classList.remove('open');
            document.body.style.overflow = '';
            stopReadingTimer();
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üé≤ FONCTIONNALIT√âS FUN - Le g√©nie des graphes
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        // Auteurs "secrets" - p√©pites cach√©es mondiales √† d√©couvrir
        const HIDDEN_GEMS = [
            // Fran√ßais
            'Lautr√©amont', 'Aloysius Bertrand', 'Tristan Corbi√®re', 'Jules Laforgue',
            // Anglais
            'John Donne', 'George Herbert', 'Thomas Traherne', 'Christopher Smart',
            // Allemand
            'Novalis', 'H√∂lderlin', 'Rilke', 'Trakl',
            // Italien
            'Leopardi', 'Ungaretti', 'Montale',
            // Espagnol
            'G√≥ngora', 'Quevedo', 'San Juan de la Cruz',
            // Russe
            'Tyutchev', 'Mandelstam', 'Akhmatova',
            // Latin
            'Catullus', 'Propertius', 'Tibullus'
        ];
        
        // Messages fun al√©atoires
        const FUN_MESSAGES = [
            "ü¶á Vous vous enfoncez dans les t√©n√®bres litt√©raires...",
            "üåÄ La spirale des mots vous aspire...",
            "üìö Les livres murmurent votre nom...",
            "üïØÔ∏è Une bougie vacille dans la biblioth√®que...",
            "üóùÔ∏è Vous avez trouv√© une porte secr√®te...",
            "ü¶â Un hibou vous observe depuis les √©tag√®res...",
            "üåô La lune √©claire un passage inconnu...",
            "üé≠ Les personnages vous guettent...",
            "‚öóÔ∏è L'encre des si√®cles vous enivre...",
            "üèöÔ∏è Vous errez dans le grenier des √¢mes...",
            "üåä Les vers d√©ferlent comme des vagues...",
            "üîÆ Le cristal r√©v√®le un auteur oubli√©...",
            "üï∏Ô∏è La toile litt√©raire se tisse autour de vous...",
            "‚òÑÔ∏è Un m√©t√©ore de mots traverse votre esprit...",
            "üé™ Bienvenue dans le cirque des po√®tes maudits..."
        ];
        
        // Badges/Achievements
        const ACHIEVEMENTS = {
            first_read: { icon: 'üìñ', name: 'Premier pas', desc: 'Lire votre premier texte' },
            explorer_5: { icon: 'üó∫Ô∏è', name: 'Explorateur', desc: 'D√©couvrir 5 auteurs' },
            explorer_15: { icon: 'üß≠', name: 'Aventurier', desc: 'D√©couvrir 15 auteurs' },
            explorer_30: { icon: 'üè¥‚Äç‚ò†Ô∏è', name: 'Corsaire litt√©raire', desc: 'D√©couvrir 30 auteurs' },
            night_owl: { icon: 'ü¶â', name: 'Noctambule', desc: 'Lire apr√®s minuit' },
            century_jump: { icon: '‚è≥', name: 'Voyageur temporel', desc: 'Passer du XIXe au XVIe si√®cle' },
            hidden_gem: { icon: 'üíé', name: 'D√©nicheur', desc: 'Trouver un auteur secret' },
            love_10: { icon: '‚ù§Ô∏è‚Äçüî•', name: 'Passionn√©', desc: 'Aimer 10 textes' },
            marathon: { icon: 'üèÉ', name: 'Marathonien', desc: 'Lire 25 textes d\'affil√©e' },
            mystique: { icon: '‚ú®', name: 'Mystique', desc: 'Explorer 5 textes mystiques' },
            poete_maudit: { icon: 'üñ§', name: 'Po√®te maudit', desc: 'D√©couvrir Lautr√©amont' },
            renaissance: { icon: 'üèõÔ∏è', name: 'Renaissance', desc: 'Lire 3 auteurs du XVIe' },
            symbolist: { icon: 'ü¶¢', name: 'Symboliste', desc: 'Explorer Mallarm√© et Verlaine' }
        };
        
        // Saut al√©atoire vers un auteur ou terme de recherche al√©atoire
        async function randomJump() {
            // Combiner les auteurs d√©couverts, les hidden gems, et quelques termes de recherche g√©n√©riques
            const discoveredAuthors = Object.keys(state.authorStats);
            const universalTerms = ['sonnet', 'elegy', 'ode', 'ballade', 'fable', 'hymn', 'nocturne'];
            const allOptions = [...discoveredAuthors, ...HIDDEN_GEMS, ...universalTerms];
            const unvisited = allOptions.filter(a => !state.authorStats[a] && !HIDDEN_GEMS.includes(a) || HIDDEN_GEMS.includes(a));
            const pool = unvisited.length > 3 ? unvisited : allOptions;
            const chosen = pool[Math.floor(Math.random() * pool.length)];
            
            toast(FUN_MESSAGES[Math.floor(Math.random() * FUN_MESSAGES.length)]);
            
            setTimeout(async () => {
                await exploreAuthor(chosen);
                checkAchievements();
                updateFunStat();
            }, 1500);
        }
        
        // Mise √† jour du message fun
        function updateFunStat() {
            const el = document.getElementById('funStat');
            if (!el) return;
            
            const authorCount = Object.keys(state.authorStats).length;
            const readCount = state.readCount || 0;
            const likeCount = state.likes?.size || 0;
            
            const funStats = [
                `üå°Ô∏è Temp√©rature litt√©raire : ${Math.min(100, readCount * 3)}¬∞`,
                `üß¨ ${authorCount} ADN d'auteurs dans votre sang`,
                `üí´ ${likeCount} √©tincelles dans votre biblioth√®que int√©rieure`,
                `üåÄ Profondeur de d√©rive : niveau ${Math.floor(readCount / 5)}`,
                `üî• Combo actuel : ${readCount} textes sans pause`,
                `üé≤ Prochain saut al√©atoire dans ${Math.max(1, 5 - (readCount % 5))} textes`,
                `üì° Signal litt√©raire : ${Math.min(100, authorCount * 5)}% de couverture`,
                `üß™ Dose de po√©sie : ${Math.floor(readCount * 2.7)}mg`,
            ];
            
            el.textContent = funStats[Math.floor(Math.random() * funStats.length)];
            el.style.opacity = '0';
            setTimeout(() => el.style.opacity = '1', 100);
        }
        
        // V√©rification et d√©blocage des achievements
        function checkAchievements() {
            const authorCount = Object.keys(state.authorStats).length;
            const readCount = state.readCount || 0;
            const likeCount = state.likes?.size || 0;
            const hour = new Date().getHours();
            
            const checks = [
                ['first_read', readCount >= 1],
                ['explorer_5', authorCount >= 5],
                ['explorer_15', authorCount >= 15],
                ['explorer_30', authorCount >= 30],
                ['night_owl', hour >= 0 && hour < 5],
                ['love_10', likeCount >= 10],
                ['marathon', readCount >= 25],
                ['mystique', (state.genreStats?.mystique || 0) >= 5],
                ['hidden_gem', HIDDEN_GEMS.some(a => state.authorStats[a])],
                ['poete_maudit', !!state.authorStats['Comte de Lautr√©amont']],
                ['symbolist', state.authorStats['St√©phane Mallarm√©'] && state.authorStats['Paul Verlaine']]
            ];
            
            for (const [id, condition] of checks) {
                if (condition && !state.achievements.includes(id)) {
                    unlockAchievement(id);
                }
            }
        }
        
        // Animation de d√©blocage d'achievement
        function unlockAchievement(id) {
            const ach = ACHIEVEMENTS[id];
            if (!ach) return;
            
            state.achievements.push(id);
            saveState();
            
            // Notification sp√©ciale
            const notif = document.createElement('div');
            notif.className = 'achievement-popup';
            notif.innerHTML = `
                <div class="achievement-icon">${ach.icon}</div>
                <div class="achievement-info">
                    <div class="achievement-title">üèÜ Badge d√©bloqu√© !</div>
                    <div class="achievement-name">${ach.name}</div>
                    <div class="achievement-desc">${ach.desc}</div>
                </div>
            `;
            document.body.appendChild(notif);
            
            setTimeout(() => notif.classList.add('show'), 100);
            setTimeout(() => {
                notif.classList.remove('show');
                setTimeout(() => notif.remove(), 500);
            }, 4000);
            
            renderAchievements();
        }
        
        // Affichage des badges
        function renderAchievements() {
            const container = document.getElementById('achievementList');
            if (!container) return;
            
            container.innerHTML = Object.entries(ACHIEVEMENTS).map(([id, ach]) => {
                const unlocked = state.achievements.includes(id);
                return `
                    <div class="achievement ${unlocked ? 'unlocked' : ''}" title="${ach.desc}">
                        ${ach.icon}
                    </div>
                `;
            }).join('');
        }
        
        // Chemin de lecture (breadcrumb visuel)
        function addToReadingPath(author, title) {
            if (!state.readingPath) state.readingPath = [];
            
            // Garder les 8 derniers
            state.readingPath.push({ author, title: title?.split('/')[0] || '?', time: Date.now() });
            if (state.readingPath.length > 8) state.readingPath.shift();
            
            renderReadingPath();
            saveState();
        }
        
        function renderReadingPath() {
            const container = document.getElementById('readingPath');
            if (!container || !state.readingPath?.length) return;
            
            container.innerHTML = state.readingPath.map((node, i) => `
                <span class="path-node" title="${node.title}">
                    ${node.author.split(' ').pop()}
                </span>
                ${i < state.readingPath.length - 1 ? '<span class="path-arrow">‚Üí</span>' : ''}
            `).join('');
        }

        document.onkeydown = e => { if (e.key === 'Escape') closeReader(); };
        
        init();
    </script>
</body>
</html>