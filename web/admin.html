<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palimpseste - Admin Dashboard</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link rel="icon" href="icons/icon-192.svg" type="image/svg+xml" sizes="192x192">
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/base.css">
    <!-- Supabase SDK (local) -->
    <script src="js/vendor/supabase.min.js"></script>
    <!-- Config centralis√©e -->
    <script src="js/config.js"></script>
    <style>
        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Crimson Pro', Georgia, serif;
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border);
        }
        
        .dashboard-header h1 {
            color: var(--accent);
            margin: 0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
        }
        
        .stat-card .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--accent);
            margin-bottom: 0.5rem;
        }
        
        .stat-card .stat-label {
            color: var(--text-muted);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .section {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .section h2 {
            color: var(--accent);
            margin-top: 0;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        th {
            color: var(--accent);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 1px;
        }
        
        tr:hover {
            background: rgba(212, 165, 116, 0.05);
        }
        
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-login { background: #2ecc7133; color: #2ecc71; }
        .badge-logout { background: #e74c3c33; color: #e74c3c; }
        .badge-signup { background: #1abc9c33; color: #1abc9c; }
        .badge-search { background: #3498db33; color: #3498db; }
        .badge-share { background: #9b59b633; color: #9b59b6; }
        .badge-other { background: #95a5a633; color: #95a5a6; }
        .badge-me { background: #f39c1233; color: #f39c12; }
        .badge-anon { background: #9b59b633; color: #9b59b6; }
        
        /* Badges d'activit√© */
        .activity-badges { display: flex; flex-wrap: wrap; gap: 4px; }
        .activity-badge {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 500;
        }
        .activity-badge .count { font-weight: 700; }
        .act-start { background: #1abc9c22; color: #1abc9c; }
        .act-search { background: #3498db33; color: #3498db; }
        .act-page { background: #9b59b633; color: #9b59b6; }
        .act-explore { background: #e67e2233; color: #e67e22; }
        .act-share { background: #e91e6333; color: #e91e63; }
        .act-social { background: #00bcd433; color: #00bcd4; }
        
        /* L√©gende */
        .activity-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 10px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            margin-top: 1rem;
        }
        .activity-legend .activity-badge { cursor: help; }
        
        .session-row-me {
            background: rgba(243, 156, 18, 0.1) !important;
            border-left: 3px solid #f39c12;
        }
        
        .session-fingerprint {
            font-family: monospace;
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .device-info {
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        
        .online-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        
        .online { background: #2ecc71; }
        .offline { background: #95a5a6; }
        
        .refresh-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-size: 1rem;
        }
        
        .refresh-btn:hover {
            background: var(--accent-hover);
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }
        
        .error-message {
            background: #e74c3c22;
            border: 1px solid #e74c3c;
            color: #e74c3c;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .back-link {
            color: var(--accent);
            text-decoration: none;
        }
        
        .back-link:hover {
            text-decoration: underline;
        }
        
        .time-filter {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .time-filter button {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text);
            border-radius: 4px;
            cursor: pointer;
        }
        
        .time-filter button.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }
        
        .chart-placeholder {
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.02);
            border-radius: 8px;
            color: var(--text-muted);
        }

        .mask-indicator {
            background: rgba(26, 188, 156, 0.12);
            border-left: 3px solid #1abc9c;
            padding: 8px 12px;
            margin-bottom: 1rem;
            border-radius: 0 8px 8px 0;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div>
            <h1>üìä Dashboard Admin</h1>
            <a href="index.html" class="back-link">‚Üê Retour √† Palimpseste</a>
        </div>
        <button class="refresh-btn" onclick="loadDashboard()">üîÑ Actualiser</button>
    </div>
    
    <div id="errorContainer"></div>

    <!-- Formulaire de connexion (affich√© si pas de session) -->
    <div id="loginForm" style="display:none; max-width:360px; margin: 4rem auto; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 2rem;">
        <h2 style="margin-top:0; color:var(--accent);">üîê Connexion Admin</h2>
        <div id="loginError" style="display:none; background:#e74c3c22; border:1px solid #e74c3c; color:#e74c3c; padding:0.75rem; border-radius:8px; margin-bottom:1rem; font-size:0.9rem;"></div>
        <div style="margin-bottom:1rem;">
            <label style="display:block; margin-bottom:0.4rem; font-size:0.85rem; color:var(--text-muted);">Email</label>
            <input type="email" id="adminEmail" placeholder="admin@example.com"
                style="width:100%; padding:0.6rem 0.8rem; background:var(--bg); border:1px solid var(--border); color:var(--text); border-radius:6px; font-size:1rem; box-sizing:border-box;">
        </div>
        <div style="margin-bottom:1.5rem;">
            <label style="display:block; margin-bottom:0.4rem; font-size:0.85rem; color:var(--text-muted);">Mot de passe</label>
            <input type="password" id="adminPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                style="width:100%; padding:0.6rem 0.8rem; background:var(--bg); border:1px solid var(--border); color:var(--text); border-radius:6px; font-size:1rem; box-sizing:border-box;"
                onkeydown="if(event.key==='Enter') adminLogin()">
        </div>
        <button onclick="adminLogin()" id="loginBtn"
            style="width:100%; padding:0.75rem; background:var(--accent); color:white; border:none; border-radius:8px; font-size:1rem; cursor:pointer; font-family:inherit;">
            Se connecter
        </button>
    </div>
    
    <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
            <div class="stat-value" id="totalUsers">-</div>
            <div class="stat-label">Utilisateurs inscrits</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="activeToday">-</div>
            <div class="stat-label">Actifs aujourd'hui</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="activeWeek">-</div>
            <div class="stat-label">Actifs cette semaine</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="loginsToday">-</div>
            <div class="stat-label">Connexions aujourd'hui</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="searchesToday">-</div>
            <div class="stat-label">Recherches aujourd'hui</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="sharesToday">-</div>
            <div class="stat-label">Partages aujourd'hui</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="signupsToday">-</div>
            <div class="stat-label">Inscriptions aujourd'hui</div>
            <div id="signupsWeek" style="font-size: 0.7rem; color: var(--text-muted); margin-top: 5px;"></div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="anonSessionsToday">-</div>
            <div class="stat-label">Sessions anonymes (24h)</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="loggedSessionsToday">-</div>
            <div class="stat-label">Sessions connect√©es (24h)</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="uniqueVisitors">-</div>
            <div class="stat-label">üë§ Visiteurs uniques (24h)</div>
            <div id="visitorBreakdown" style="font-size: 0.7rem; color: var(--text-muted); margin-top: 5px;"></div>
        </div>
    </div>
    
    <div class="section">
        <h2>üëª Visiteurs anonymes (50 derni√®res activit√©s)</h2>
        <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem;">
            <strong>visitor_id</strong> = m√™me navigateur (persiste)<br>
            <strong>session_id</strong> = m√™me onglet (temporaire)<br>
            <span id="mySessionIndicator" style="color: var(--accent);"></span>
        </p>
        <div id="anonymousVisitorsContainer">
            <div class="loading">Chargement...</div>
        </div>
    </div>
    
    <div class="section">
        <h2>üë• Utilisateurs connect√©s en temps r√©el</h2>
        <div id="activeUsersContainer">
            <div class="loading">Chargement...</div>
        </div>
    </div>
    
    <div class="section">
        <h2>üÜï Nouveaux inscrits</h2>
        <div id="newUsersContainer">
            <div class="loading">Chargement...</div>
        </div>
    </div>
    
    <div class="section">
        <h2>üìú √âv√©nements r√©cents</h2>
        <div id="myActivitySummary" style="background: rgba(243, 156, 18, 0.1); border-left: 3px solid #f39c12; padding: 10px 15px; margin-bottom: 1rem; border-radius: 0 8px 8px 0; display: none;">
            <!-- R√©sum√© de mon activit√© -->
        </div>
        <div id="maskIndicator" class="mask-indicator" style="display: none;">
            üôà Vos √©v√©nements sont masqu√©s. Les autres restent visibles.
        </div>
        <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem; flex-wrap: wrap;">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="hideMyEvents" checked onchange="applyFilters()">
                <span>Masquer mes √©v√©nements</span>
            </label>
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="aggregateMode" checked onchange="applyFilters()">
                <span>üìä Mode agr√©g√© (r√©sum√©)</span>
            </label>
        </div>
        <div class="time-filter">
            <button class="active" onclick="filterEvents('all')">Tous</button>
            <button onclick="filterEvents('search')">Recherches</button>
            <button onclick="filterEvents('share')">Partages</button>
            <button onclick="filterEvents('others')">üë• Autres utilisateurs</button>
        </div>
        <div id="eventsContainer">
            <div class="loading">Chargement...</div>
        </div>
    </div>
    
    <div class="section">
        <h2>üìà Statistiques par type d'√©v√©nement</h2>
        <div id="eventTypesContainer">
            <div class="loading">Chargement...</div>
        </div>
    </div>

    <script>
        // Configuration Supabase centralis√©e dans config.js
        const SUPABASE_URL = CONFIG.SUPABASE_URL;
        const SUPABASE_ANON_KEY = CONFIG.SUPABASE_ANON_KEY;
        
        let supabaseClient = null;
        let currentUser = null;
        let allEvents = [];
        let adminSessionId = null; // Pour identifier "ma" session
        let adminVisitorId = null; // Pour identifier "mon" visitor_id (navigateur)
        let currentFilter = 'all'; // Filtre actuel
        
        // G√©n√©rer/r√©cup√©rer l'ID de session admin
        function getAdminSessionId() {
            let sessionId = sessionStorage.getItem('palimpseste_session_id') ||
                sessionStorage.getItem('admin_session_id');
            if (!sessionId) {
                sessionId = crypto.randomUUID ? crypto.randomUUID() : 
                    'admin-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                sessionStorage.setItem('admin_session_id', sessionId);
            }
            return sessionId;
        }
        
        // R√©cup√©rer le visitor_id du navigateur actuel (m√™me que dans monitoring.js)
        function getAdminVisitorId() {
            return localStorage.getItem('palimpseste_visitor_id');
        }
        
        // Initialisation
        async function init() {
            try {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                // V√©rifier l'authentification (getSession peut √©chouer sur mobile avec Tracking Prevention)
                let session = null;
                try {
                    const { data } = await supabaseClient.auth.getSession();
                    session = data.session;
                } catch(e) {
                    console.warn('getSession failed:', e);
                }

                if (!session) {
                    // Afficher le formulaire de connexion
                    document.getElementById('loginForm').style.display = 'block';
                    return;
                }
                
                await proceedWithSession(session);
                
            } catch (e) {
                console.error('Init error:', e);
                showError('Erreur d\'initialisation: ' + e.message);
            }
        }

        async function adminLogin() {
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value;
            const btn = document.getElementById('loginBtn');
            const errDiv = document.getElementById('loginError');

            errDiv.style.display = 'none';
            btn.disabled = true;
            btn.textContent = 'Connexion...';

            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) throw error;
                document.getElementById('loginForm').style.display = 'none';
                await proceedWithSession(data.session);
            } catch(e) {
                errDiv.textContent = e.message || 'Erreur de connexion';
                errDiv.style.display = 'block';
                btn.disabled = false;
                btn.textContent = 'Se connecter';
            }
        }

        async function proceedWithSession(session) {
            currentUser = session.user;

            // üîê V√©rifier que l'utilisateur est bien l'admin
            if (currentUser.email !== CONFIG.ADMIN_EMAIL) {
                document.body.innerHTML = `
                    <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;gap:1rem;font-family:Georgia,serif;">
                        <div style="font-size:3rem;">üö´</div>
                        <h2 style="color:#e74c3c;">Acc√®s refus√©</h2>
                        <p style="color:#aaa;">Vous n'√™tes pas autoris√© √† acc√©der au dashboard admin.</p>
                        <a href="index.html" style="color:#5a7a8a;">‚Üê Retour √† Palimpseste</a>
                    </div>`;
                return;
            }

            adminSessionId = getAdminSessionId();
            adminVisitorId = getAdminVisitorId();
            
            // Afficher l'indicateur de session et visitor_id
            document.getElementById('mySessionIndicator').innerHTML = 
                `üîç Mon visitor_id: <code style="font-size: 0.7rem;">${adminVisitorId || 'aucun'}</code><br>
                 üîç Ma session: <code style="font-size: 0.7rem;">${adminSessionId.substring(0, 8)}...</code>`;
            
            await loadDashboard();
        }
        
        function showError(message) {
            document.getElementById('errorContainer').innerHTML = `
                <div class="error-message">${message}</div>
            `;
        }
        
        async function loadDashboard() {
            // Charger les profils d'abord pour pouvoir afficher les noms
            await loadAllProfiles();
            await Promise.all([
                loadStats(),
                loadSessionStats(),
                loadActiveUsers(),
                loadAnonymousVisitors(),
                loadNewUsers(),
                loadRecentEvents(),
                loadEventTypes()
            ]);
        }
        
        // Cache des profils pour afficher les noms d'utilisateurs
        let profilesCache = new Map();
        
        async function loadAllProfiles() {
            try {
                const { data: profiles } = await supabaseClient
                    .from('profiles')
                    .select('id, username, created_at');
                
                profilesCache = new Map((profiles || []).map(p => [p.id, p]));
            } catch (e) {
                console.error('Error loading profiles:', e);
            }
        }
        
        function getUserName(userId) {
            if (!userId) return 'Anonyme';
            const profile = profilesCache.get(userId);
            return profile?.username || userId.substring(0, 8) + '...';
        }
        
        // Charger les statistiques de sessions
        async function loadSessionStats() {
            try {
                const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();
                
                const { data: events, error } = await supabaseClient
                    .from('analytics_events')
                    .select('session_id, user_id')
                    .gte('created_at', oneDayAgo);
                
                if (error) throw error;
                
                // Compter les sessions uniques anonymes vs connect√©es
                const sessionMap = new Map();
                (events || []).forEach(e => {
                    if (e.session_id && !sessionMap.has(e.session_id)) {
                        sessionMap.set(e.session_id, e.user_id);
                    }
                });
                
                let anonCount = 0;
                let loggedCount = 0;
                sessionMap.forEach((userId) => {
                    if (userId) loggedCount++;
                    else anonCount++;
                });
                
                document.getElementById('anonSessionsToday').textContent = anonCount;
                document.getElementById('loggedSessionsToday').textContent = loggedCount;
                
                // Compter les visiteurs uniques (par visitor_id dans event_data)
                // On doit r√©cup√©rer event_data pour avoir le visitor_id
                const { data: eventsWithData, error: err2 } = await supabaseClient
                    .from('analytics_events')
                    .select('session_id, user_id, event_data')
                    .gte('created_at', oneDayAgo);
                
                if (err2) throw err2;
                
                const realVisitors = new Set();      // Vrais visitor_id (nouveau syst√®me)
                const fallbackSessions = new Set();  // Anciennes sessions sans visitor_id
                const loggedUsers = new Set();       // Utilisateurs connect√©s
                
                (eventsWithData || []).forEach(e => {
                    // Utilisateurs connect√©s = toujours fiables
                    if (e.user_id) {
                        loggedUsers.add(e.user_id);
                        return;
                    }
                    
                    // Anonymes : v√©rifier si on a un visitor_id
                    const visitorId = e.event_data?.visitor_id;
                    if (visitorId) {
                        realVisitors.add(visitorId);
                    } else if (e.session_id) {
                        fallbackSessions.add(e.session_id);
                    }
                });
                
                // Total fiable = utilisateurs connect√©s + vrais visitor_id
                const reliableCount = loggedUsers.size + realVisitors.size;
                const totalWithFallback = reliableCount + fallbackSessions.size;
                
                // Affichage
                if (fallbackSessions.size > 0) {
                    // On a des anciennes donn√©es ‚Üí afficher avec avertissement
                    document.getElementById('uniqueVisitors').innerHTML = 
                        `${reliableCount} <span style="font-size: 0.6em; color: var(--text-muted);">(+${fallbackSessions.size}?)</span>`;
                    document.getElementById('visitorBreakdown').innerHTML = 
                        `‚úÖ ${loggedUsers.size} connect√©(s) + ${realVisitors.size} anonyme(s) identifi√©(s)<br>` +
                        `‚ö†Ô∏è +${fallbackSessions.size} session(s) non tra√ßable(s) <small>(anciennes donn√©es)</small>`;
                } else {
                    document.getElementById('uniqueVisitors').textContent = reliableCount;
                    document.getElementById('visitorBreakdown').innerHTML = 
                        `‚úÖ ${loggedUsers.size} connect√©(s) + ${realVisitors.size} anonyme(s)`;
                }
                
            } catch (e) {
                console.error('Session stats error:', e);
                document.getElementById('anonSessionsToday').textContent = '-';
                document.getElementById('loggedSessionsToday').textContent = '-';
                document.getElementById('uniqueVisitors').textContent = '-';
                document.getElementById('visitorBreakdown').textContent = '';
            }
        }
        
        // Charger les visiteurs anonymes
        async function loadAnonymousVisitors() {
            const container = document.getElementById('anonymousVisitorsContainer');
            
            try {
                const { data: events, error } = await supabaseClient
                    .from('analytics_events')
                    .select('session_id, user_agent, created_at, event_type, event_data')
                    .is('user_id', null)
                    .order('created_at', { ascending: false })
                    .limit(50);
                
                if (error) throw error;
                
                // Grouper par session_id puis agr√©ger par visitor_id
                const sessionMap = new Map();
                
                (events || []).forEach(e => {
                    if (!e.session_id) return;
                    
                    const visitorId = e.event_data?.visitor_id || null;
                    
                    if (!sessionMap.has(e.session_id)) {
                        sessionMap.set(e.session_id, {
                            session_id: e.session_id,
                            visitor_id: visitorId,
                            user_agent: e.user_agent,
                            first_seen: e.created_at,
                            last_seen: e.created_at,
                            event_count: 0,
                            events: []
                        });
                    }
                    
                    const session = sessionMap.get(e.session_id);
                    if (!session.visitor_id && visitorId) session.visitor_id = visitorId;
                    session.event_count++;
                    if (new Date(e.created_at) < new Date(session.first_seen)) {
                        session.first_seen = e.created_at;
                    }
                    if (new Date(e.created_at) > new Date(session.last_seen)) {
                        session.last_seen = e.created_at;
                    }
                    session.events.push({ type: e.event_type, data: e.event_data });
                });
                
                const visitorMap = new Map();
                const fallbackSessions = [];
                
                sessionMap.forEach(session => {
                    if (!session.visitor_id) {
                        fallbackSessions.push(session);
                        return;
                    }
                    
                    if (!visitorMap.has(session.visitor_id)) {
                        visitorMap.set(session.visitor_id, {
                            visitor_id: session.visitor_id,
                            sessions: [],
                            event_count: 0,
                            events: [],
                            first_seen: session.first_seen,
                            last_seen: session.last_seen,
                            user_agent: session.user_agent,
                            is_me: false
                        });
                    }
                    
                    const visitor = visitorMap.get(session.visitor_id);
                    visitor.sessions.push(session);
                    visitor.event_count += session.event_count;
                    visitor.events = visitor.events.concat(session.events);
                    if (new Date(session.first_seen) < new Date(visitor.first_seen)) {
                        visitor.first_seen = session.first_seen;
                    }
                    if (new Date(session.last_seen) > new Date(visitor.last_seen)) {
                        visitor.last_seen = session.last_seen;
                        visitor.user_agent = session.user_agent;
                    }
                    if (session.session_id === adminSessionId) {
                        visitor.is_me = true;
                    }
                });
                
                const visitors = Array.from(visitorMap.values())
                    .sort((a, b) => new Date(b.last_seen) - new Date(a.last_seen));
                const sessions = fallbackSessions
                    .sort((a, b) => new Date(b.last_seen) - new Date(a.last_seen));
                
                if (visitors.length === 0 && sessions.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-muted)">Aucun visiteur anonyme r√©cent</p>';
                    return;
                }
                
                let html = `<table><thead><tr>
                    <th>Visiteur</th>
                    <th>Session</th>
                    <th>Appareil</th>
                    <th>Actions</th>
                    <th>Derni√®re activit√©</th>
                    <th>Activit√©</th>
                </tr></thead><tbody>`;
                
                visitors.forEach(visitor => {
                    const lastSeenDate = new Date(visitor.last_seen).toLocaleString('fr-FR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    const deviceInfo = parseUserAgent(visitor.user_agent);
                    const visitorShort = visitor.visitor_id.substring(0, 10);
                    const sessionsCount = visitor.sessions.length;
                    const sessionList = visitor.sessions
                        .map(s => `<span class="session-fingerprint" title="Session (cet onglet)">${s.session_id.substring(0, 8)}...</span>`)
                        .join(' ');
                    
                    // R√©sum√© des activit√©s (agr√©g√©)
                    const activitySummary = summarizeActivity(visitor.events);
                    
                    html += `<tr class="${visitor.is_me ? 'session-row-me' : ''}">
                        <td>
                            <span class="session-fingerprint" title="Visiteur unique (m√™me navigateur)">${visitorShort}...</span>
                            ${sessionsCount > 1 ? `<small style="color: var(--accent);">(${sessionsCount} sessions)</small>` : ''}
                        </td>
                        <td>
                            <div>${sessionList}</div>
                            ${visitor.is_me ? '<span class="badge badge-me">üë§ MOI</span>' : ''}
                        </td>
                        <td class="device-info">${deviceInfo}</td>
                        <td>${visitor.event_count} events</td>
                        <td>${lastSeenDate}</td>
                        <td>${activitySummary}</td>
                    </tr>`;
                });
                
                sessions.forEach(session => {
                    const isMe = session.session_id === adminSessionId;
                    const lastSeenDate = new Date(session.last_seen).toLocaleString('fr-FR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    const deviceInfo = parseUserAgent(session.user_agent);
                    const sessionShort = session.session_id.substring(0, 8);
                    
                    const activitySummary = summarizeActivity(session.events);
                    
                    html += `<tr class="${isMe ? 'session-row-me' : ''}">
                        <td>
                            <span class="badge badge-anon" style="background: #95a5a633; color: #95a5a6;">Session seule</span>
                        </td>
                        <td>
                            <span class="session-fingerprint" title="Session (cet onglet)">${sessionShort}...</span>
                            ${isMe ? '<span class="badge badge-me">üë§ MOI</span>' : ''}
                        </td>
                        <td class="device-info">${deviceInfo}</td>
                        <td>${session.event_count} events</td>
                        <td>${lastSeenDate}</td>
                        <td>${activitySummary}</td>
                    </tr>`;
                });
                
                const totalSessions = sessionMap.size;
                const uniqueVisitorCount = visitors.length + sessions.length;
                
                html += '</tbody></table>';
                html += `<p style="margin-top: 1rem; font-size: 0.9rem; color: var(--text);">
                    üìä <strong>${totalSessions}</strong> session(s) r√©centes ‚Ä¢ 
                    üë§ <strong>${uniqueVisitorCount}</strong> visiteur(s) unique(s)
                </p>`;
                html += `<div class="activity-legend">
                    <span style="font-size: 0.8rem; color: var(--text-muted); margin-right: 8px;">L√©gende :</span>
                    <span class="activity-badge act-start" title="L'utilisateur vient d'arriver sur le site">üöÄ Arriv√©e</span>
                    <span class="activity-badge act-page" title="Pages ou sections consult√©es">üìÑ Pages vues</span>
                    <span class="activity-badge act-search" title="Recherches dans Wikisource, Gutenberg...">üîç Recherches</span>
                    <span class="activity-badge act-explore" title="Explorations / d√©rives litt√©raires">üß≠ Explorations</span>
                    <span class="activity-badge act-share" title="Extraits partag√©s">üì§ Partages</span>
                    <span class="activity-badge act-social" title="Likes, commentaires, follows...">üí¨ Social</span>
                </div>`;
                container.innerHTML = html;
                
            } catch (e) {
                console.error('Anonymous visitors error:', e);
                container.innerHTML = '<p style="color: var(--text-muted)">Erreur lors du chargement des visiteurs anonymes</p>';
            }
        }
        
        // Parser le user agent pour obtenir des infos lisibles
        function parseUserAgent(ua) {
            if (!ua) return 'Inconnu';
            
            let device = 'üíª';
            let browser = '';
            let os = '';
            
            // D√©tecter mobile
            if (/Mobile|Android|iPhone|iPad/i.test(ua)) {
                device = 'üì±';
            }
            
            // D√©tecter le navigateur
            if (/Chrome/i.test(ua) && !/Edg/i.test(ua)) browser = 'Chrome';
            else if (/Firefox/i.test(ua)) browser = 'Firefox';
            else if (/Safari/i.test(ua) && !/Chrome/i.test(ua)) browser = 'Safari';
            else if (/Edg/i.test(ua)) browser = 'Edge';
            else browser = 'Autre';
            
            // D√©tecter l'OS
            if (/Windows/i.test(ua)) os = 'Win';
            else if (/Mac/i.test(ua)) os = 'Mac';
            else if (/Linux/i.test(ua)) os = 'Linux';
            else if (/Android/i.test(ua)) os = 'Android';
            else if (/iPhone|iPad/i.test(ua)) os = 'iOS';
            
            return `${device} ${browser} (${os})`;
        }
        
        // R√©sumer l'activit√© d'une session avec des badges color√©s
        function summarizeActivity(events) {
            const counts = {};
            events.forEach(e => {
                counts[e.type] = (counts[e.type] || 0) + 1;
            });
            
            const badges = [];
            
            // Ordre logique: d√©marrage, navigation, actions
            if (counts.session_start) {
                badges.push(`<span class="activity-badge act-start" title="D√©but de visite">üöÄ Arriv√©e</span>`);
            }
            if (counts.page_view) {
                badges.push(`<span class="activity-badge act-page" title="${counts.page_view} page(s) consult√©e(s)">üìÑ <span class="count">${counts.page_view}</span> page${counts.page_view > 1 ? 's' : ''}</span>`);
            }
            if (counts.search) {
                badges.push(`<span class="activity-badge act-search" title="${counts.search} recherche(s) effectu√©e(s)">üîç <span class="count">${counts.search}</span> recherche${counts.search > 1 ? 's' : ''}</span>`);
            }
            if (counts.exploration) {
                badges.push(`<span class="activity-badge act-explore" title="${counts.exploration} exploration(s) / d√©rive(s)">üß≠ <span class="count">${counts.exploration}</span> exploration${counts.exploration > 1 ? 's' : ''}</span>`);
            }
            if (counts.share) {
                badges.push(`<span class="activity-badge act-share" title="${counts.share} partage(s)">üì§ <span class="count">${counts.share}</span> partage${counts.share > 1 ? 's' : ''}</span>`);
            }
            if (counts.social) {
                badges.push(`<span class="activity-badge act-social" title="Interactions sociales (likes, commentaires...)">üí¨ Social</span>`);
            }
            
            return badges.length > 0 
                ? `<div class="activity-badges">${badges.join('')}</div>` 
                : '<span style="color: var(--text-muted)">‚Äî</span>';
        }
        
        async function loadStats() {
            try {
                const { data, error } = await supabaseClient.rpc('get_analytics_stats');
                
                if (error) {
                    console.error('Stats error:', error);
                    // Fallback: compter manuellement
                    await loadStatsFallback();
                    return;
                }
                
                document.getElementById('totalUsers').textContent = data.total_users || 0;
                document.getElementById('activeToday').textContent = data.active_users_today || 0;
                document.getElementById('activeWeek').textContent = data.active_users_week || 0;
                document.getElementById('loginsToday').textContent = data.total_logins_today || 0;
                document.getElementById('searchesToday').textContent = data.total_searches_today || 0;
                document.getElementById('sharesToday').textContent = data.total_shares_today || 0;
                document.getElementById('signupsToday').textContent = data.total_signups_today || 0;
                const signupsWeek = data.total_signups_week || 0;
                document.getElementById('signupsWeek').textContent = signupsWeek > 0 ? `(${signupsWeek} cette semaine)` : '';
                
            } catch (e) {
                console.error('Exception loading stats:', e);
                await loadStatsFallback();
            }
        }
        
        async function loadStatsFallback() {
            // Compter les utilisateurs depuis la table profiles
            const { count: userCount } = await supabaseClient
                .from('profiles')
                .select('*', { count: 'exact', head: true });
            
            document.getElementById('totalUsers').textContent = userCount || 0;
            document.getElementById('activeToday').textContent = '-';
            document.getElementById('activeWeek').textContent = '-';
            document.getElementById('loginsToday').textContent = '-';
            document.getElementById('searchesToday').textContent = '-';
            document.getElementById('sharesToday').textContent = '-';
            document.getElementById('signupsToday').textContent = '-';
            document.getElementById('signupsWeek').textContent = '';
        }
        
        async function loadActiveUsers() {
            const container = document.getElementById('activeUsersContainer');
            
            try {
                // R√©cup√©rer les utilisateurs actifs dans la derni√®re heure
                const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000).toISOString();
                
                const { data: events, error } = await supabaseClient
                    .from('analytics_events')
                    .select('user_id, created_at')
                    .gte('created_at', oneHourAgo)
                    .not('user_id', 'is', null)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                // D√©dupliquer par user_id
                const userMap = new Map();
                (events || []).forEach(e => {
                    if (!userMap.has(e.user_id)) {
                        userMap.set(e.user_id, e.created_at);
                    }
                });
                
                if (userMap.size === 0) {
                    container.innerHTML = '<p style="color: var(--text-muted)">Aucun utilisateur actif dans la derni√®re heure</p>';
                    return;
                }
                
                // R√©cup√©rer les profils
                const userIds = Array.from(userMap.keys());
                const { data: profiles } = await supabaseClient
                    .from('profiles')
                    .select('id, username')
                    .in('id', userIds);
                
                const profileMap = new Map((profiles || []).map(p => [p.id, p]));
                
                let html = '<table><thead><tr><th>Statut</th><th>Utilisateur</th><th>Derni√®re activit√©</th></tr></thead><tbody>';
                
                userMap.forEach((lastSeen, userId) => {
                    const profile = profileMap.get(userId);
                    const username = profile?.username || 'Utilisateur inconnu';
                    const minutesAgo = Math.round((Date.now() - new Date(lastSeen)) / 60000);
                    const isOnline = minutesAgo < 5;
                    
                    html += `<tr>
                        <td><span class="online-indicator ${isOnline ? 'online' : 'offline'}"></span>${isOnline ? 'En ligne' : 'R√©cemment'}</td>
                        <td>${escapeHtml(username)}</td>
                        <td>Il y a ${minutesAgo} min</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
                
            } catch (e) {
                console.error('Active users error:', e);
                container.innerHTML = '<p style="color: var(--text-muted)">Table analytics_events non disponible. Ex√©cutez monitoring_setup.sql dans Supabase.</p>';
            }
        }
        
        async function loadNewUsers() {
            const container = document.getElementById('newUsersContainer');
            
            try {
                let users = null;
                let useAuth = false;

                // R√©cup√©rer les utilisateurs depuis auth.users (RPC admin)
                try {
                    const { data: authUsers, error: authError } = await supabaseClient
                        .rpc('get_admin_users', { limit_count: 20 });
                    if (!authError && authUsers && authUsers.length > 0) {
                        users = authUsers;
                        useAuth = true;
                    }
                } catch (rpcError) {
                    console.warn('RPC get_admin_users indisponible:', rpcError);
                }

                // Fallback : profils
                if (!users) {
                    const { data: profiles, error } = await supabaseClient
                        .from('profiles')
                        .select('id, username, created_at')
                        .order('created_at', { ascending: false })
                        .limit(20);
                    if (error) throw error;
                    users = profiles || [];
                }

                if (!users || users.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-muted)">Aucun utilisateur inscrit</p>';
                    return;
                }

                let html = '<table><thead><tr><th>Utilisateur</th><th>Date d\'inscription</th><th>Anciennet√©</th><th>Derni√®re connexion</th></tr></thead><tbody>';

                users.forEach(user => {
                    const createdAt = new Date(user.created_at);
                    const dateStr = createdAt.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                    const daysAgo = Math.floor((Date.now() - createdAt) / (1000 * 60 * 60 * 24));
                    let anciennete = '';
                    if (daysAgo === 0) {
                        anciennete = 'üÜï Aujourd\'hui';
                    } else if (daysAgo === 1) {
                        anciennete = 'Hier';
                    } else if (daysAgo < 7) {
                        anciennete = `Il y a ${daysAgo} jours`;
                    } else if (daysAgo < 30) {
                        anciennete = `Il y a ${Math.floor(daysAgo / 7)} semaine(s)`;
                    } else {
                        anciennete = `Il y a ${Math.floor(daysAgo / 30)} mois`;
                    }

                    const username = user.username || (user.email ? user.email.split('@')[0] : 'Utilisateur');
                    const lastSignIn = useAuth && user.last_sign_in_at
                        ? new Date(user.last_sign_in_at).toLocaleString('fr-FR')
                        : (useAuth ? 'Jamais' : '-');

                    html += `<tr>
                        <td><strong>${escapeHtml(username)}</strong></td>
                        <td>${dateStr}</td>
                        <td>${anciennete}</td>
                        <td>${lastSignIn}</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
                
            } catch (e) {
                console.error('New users error:', e);
                container.innerHTML = '<p style="color: var(--text-muted)">Erreur lors du chargement des utilisateurs.</p>';
            }
        }
        
        async function loadRecentEvents() {
            const container = document.getElementById('eventsContainer');
            
            try {
                const { data: events, error } = await supabaseClient
                    .from('analytics_events')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(500);
                
                if (error) throw error;
                
                allEvents = events || [];
                updateMyActivitySummary(); // Afficher mon r√©sum√©
                applyFilters(); // Appliquer les filtres (checkbox coch√©es par d√©faut)
                
            } catch (e) {
                console.error('Events error:', e);
                container.innerHTML = '<p style="color: var(--text-muted)">Table analytics_events non disponible. Ex√©cutez monitoring_setup.sql dans Supabase.</p>';
            }
        }
        
        function renderEvents(events) {
            const container = document.getElementById('eventsContainer');
            const aggregateMode = document.getElementById('aggregateMode')?.checked;
            const hideMyEvents = document.getElementById('hideMyEvents')?.checked;
            
            // Afficher/masquer le r√©sum√© de mon activit√©
            const summaryDiv = document.getElementById('myActivitySummary');
            if (summaryDiv) {
                summaryDiv.style.display = hideMyEvents ? 'block' : 'none';
            }

            const maskIndicator = document.getElementById('maskIndicator');
            if (maskIndicator) {
                maskIndicator.style.display = hideMyEvents ? 'block' : 'none';
            }
            
            if (events.length === 0) {
                const emptyText = hideMyEvents
                    ? 'Aucun √©v√©nement (hors les v√¥tres)'
                    : 'Aucun √©v√©nement';
                container.innerHTML = `<p style="color: var(--text-muted)">${emptyText}</p>`;
                return;
            }
            
            if (aggregateMode) {
                renderAggregatedEvents(events, container);
            } else {
                renderDetailedEvents(events, container);
            }
        }
        
        // Affichage d√©taill√© (liste compl√®te)
        function renderDetailedEvents(events, container) {
            let html = '<table><thead><tr><th>Date</th><th>Type</th><th>Utilisateur</th><th>D√©tails</th></tr></thead><tbody>';
            
            events.forEach(event => {
                const date = new Date(event.created_at).toLocaleString('fr-FR');
                const badgeClass = getBadgeClass(event.event_type);
                const details = formatEventData(event.event_data);
                const username = getUserName(event.user_id);
                const isMe = event.user_id === currentUser?.id;
                const sessionShort = event.session_id ? event.session_id.substring(0, 6) : '-';
                
                let userDisplay = username;
                if (!event.user_id) {
                    userDisplay = `<span class="badge badge-anon">Anon</span> <span class="session-fingerprint">${sessionShort}</span>`;
                }
                if (isMe) userDisplay += ' <span class="badge badge-me">MOI</span>';
                
                html += `<tr class="${isMe ? 'session-row-me' : ''}">
                    <td>${date}</td>
                    <td><span class="badge ${badgeClass}">${event.event_type}</span></td>
                    <td>${userDisplay}</td>
                    <td>${details}</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // Affichage agr√©g√© (r√©sum√© par utilisateur)
        function renderAggregatedEvents(events, container) {
            // Grouper par utilisateur
            const userStats = new Map();
            
            events.forEach(e => {
                const userId = e.user_id || 'anon_' + (e.event_data?.visitor_id || e.session_id || 'unknown');
                
                if (!userStats.has(userId)) {
                    userStats.set(userId, {
                        user_id: e.user_id,
                        username: getUserName(e.user_id),
                        visitor_id: e.event_data?.visitor_id,
                        session_id: e.session_id,
                        events: {},
                        last_seen: e.created_at,
                        first_seen: e.created_at
                    });
                }
                
                const stats = userStats.get(userId);
                stats.events[e.event_type] = (stats.events[e.event_type] || 0) + 1;
                if (new Date(e.created_at) > new Date(stats.last_seen)) stats.last_seen = e.created_at;
                if (new Date(e.created_at) < new Date(stats.first_seen)) stats.first_seen = e.created_at;
            });
            
            // Trier par derni√®re activit√©
            const sorted = Array.from(userStats.values())
                .sort((a, b) => new Date(b.last_seen) - new Date(a.last_seen));
            
            let html = '<table><thead><tr><th>Utilisateur</th><th>Activit√©</th><th>Derni√®re action</th></tr></thead><tbody>';
            
            let realVisitorCount = 0;
            let legacySessionCount = 0;
            
            sorted.slice(0, 50).forEach(stats => {
                const isMe = stats.user_id === currentUser?.id;
                let userDisplay = stats.username;
                
                if (!stats.user_id) {
                    // Distinguer visitor_id (fiable) vs session_id (legacy)
                    const hasVisitorId = stats.visitor_id && stats.visitor_id.startsWith('v_');
                    
                    if (hasVisitorId) {
                        realVisitorCount++;
                        const visitorShort = stats.visitor_id.substring(0, 10);
                        userDisplay = `<span class="badge badge-anon" style="background: #1abc9c33; color: #1abc9c;">‚úì Visiteur</span> <span class="session-fingerprint">${visitorShort}...</span>`;
                    } else {
                        legacySessionCount++;
                        const sessionShort = stats.session_id?.substring(0, 6) || '?';
                        userDisplay = `<span class="badge badge-anon" style="background: #95a5a633; color: #95a5a6;">? Session</span> <span class="session-fingerprint">${sessionShort}...</span>`;
                    }
                }
                if (isMe) userDisplay += ' <span class="badge badge-me">MOI</span>';
                
                // R√©sum√© des activit√©s
                const activityParts = [];
                if (stats.events.login) activityParts.push(`<span class="badge badge-login">üîë ${stats.events.login} login${stats.events.login > 1 ? 's' : ''}</span>`);
                if (stats.events.signup) activityParts.push(`<span class="badge badge-signup">üÜï ${stats.events.signup} inscription${stats.events.signup > 1 ? 's' : ''}</span>`);
                if (stats.events.search) activityParts.push(`<span class="badge badge-search">üîç ${stats.events.search} recherche${stats.events.search > 1 ? 's' : ''}</span>`);
                if (stats.events.share) activityParts.push(`<span class="badge badge-share">üì§ ${stats.events.share} partage${stats.events.share > 1 ? 's' : ''}</span>`);
                if (stats.events.page_view) activityParts.push(`<span class="badge badge-other">üìÑ ${stats.events.page_view} pages</span>`);
                if (stats.events.exploration) activityParts.push(`<span class="badge badge-other">üß≠ ${stats.events.exploration} explo</span>`);
                if (stats.events.session_start) activityParts.push(`<span class="badge badge-other">üöÄ ${stats.events.session_start} visite${stats.events.session_start > 1 ? 's' : ''}</span>`);
                
                const lastSeenDate = new Date(stats.last_seen).toLocaleString('fr-FR');
                
                html += `<tr class="${isMe ? 'session-row-me' : ''}">
                    <td>${userDisplay}</td>
                    <td><div style="display: flex; flex-wrap: wrap; gap: 4px;">${activityParts.join('')}</div></td>
                    <td>${lastSeenDate}</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            
            // Compter les utilisateurs connect√©s
            const loggedUsers = sorted.filter(s => s.user_id).length;
            
            html += `<div style="margin-top: 0.75rem; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 8px; font-size: 0.85rem;">
                <strong>üìä R√©sum√© :</strong><br>
                üë§ <strong>${loggedUsers}</strong> utilisateur(s) connect√©(s)<br>
                ‚úì <strong>${realVisitorCount}</strong> visiteur(s) anonyme(s) identifi√©(s) <span style="color: #1abc9c;">(fiable)</span><br>
                ? <strong>${legacySessionCount}</strong> session(s) non tra√ßable(s) <span style="color: #95a5a6;">(anciennes donn√©es, peut-√™tre 1 seule personne)</span>
            </div>`;
            container.innerHTML = html;
        }
        
        function applyFilters() {
            filterEvents(currentFilter);
        }

        function isMyEvent(event) {
            if (currentUser?.id && event.user_id === currentUser.id) return true;
            if (adminVisitorId && event.event_data?.visitor_id === adminVisitorId) return true;
            if (adminSessionId && event.session_id === adminSessionId) return true;
            return false;
        }
        
        function filterEvents(type) {
            currentFilter = type;
            
            // Update active button
            document.querySelectorAll('.time-filter button').forEach(btn => {
                btn.classList.remove('active');
                if ((type === 'all' && btn.textContent === 'Tous') ||
                    (type === 'others' && btn.textContent.includes('Autres')) ||
                    (type === 'search' && btn.textContent === 'Recherches') ||
                    (type === 'share' && btn.textContent === 'Partages')) {
                    btn.classList.add('active');
                }
            });
            
            const hideMyEvents = document.getElementById('hideMyEvents')?.checked;
            
            let filtered = allEvents;
            
            // Filtrer par type
            switch(type) {
                case 'all':
                    break;
                case 'others':
                    filtered = filtered.filter(e => !isMyEvent(e));
                    break;
                case 'search':
                case 'share':
                    filtered = filtered.filter(e => e.event_type === type);
                    break;
            }
            
            // Masquer mes √©v√©nements si coch√©
            if (hideMyEvents) {
                filtered = filtered.filter(e => !isMyEvent(e));
            }

            if (type === 'all' && hideMyEvents && !aggregateMode) {
                filtered = filtered.slice(0, 100);
            }
            
            renderEvents(filtered);
        }
        
        // Afficher un r√©sum√© de mon activit√© (toujours visible)
        function updateMyActivitySummary() {
            const summaryDiv = document.getElementById('myActivitySummary');
            if (!summaryDiv || !currentUser) return;
            
            const myEvents = allEvents.filter(e => e.user_id === currentUser.id);
            if (myEvents.length === 0) {
                summaryDiv.innerHTML = '<strong>üë§ Votre activit√© :</strong> Aucun √©v√©nement r√©cent';
                return;
            }
            
            // Compter par type
            const counts = {};
            myEvents.forEach(e => {
                counts[e.event_type] = (counts[e.event_type] || 0) + 1;
            });
            
            const parts = [];
            if (counts.login) parts.push(`üîë ${counts.login} login${counts.login > 1 ? 's' : ''}`);
            if (counts.search) parts.push(`üîç ${counts.search} recherche${counts.search > 1 ? 's' : ''}`);
            if (counts.share) parts.push(`üì§ ${counts.share} partage${counts.share > 1 ? 's' : ''}`);
            if (counts.page_view) parts.push(`üìÑ ${counts.page_view} page${counts.page_view > 1 ? 's' : ''}`);
            if (counts.exploration) parts.push(`üß≠ ${counts.exploration} exploration${counts.exploration > 1 ? 's' : ''}`);
            if (counts.session_start) parts.push(`üöÄ ${counts.session_start} visite${counts.session_start > 1 ? 's' : ''}`);
            
            const lastEvent = myEvents[0];
            const lastTime = new Date(lastEvent.created_at).toLocaleString('fr-FR');
            
            summaryDiv.innerHTML = `
                <strong>üë§ Votre activit√© (masqu√©e ci-dessous) :</strong> 
                ${parts.join(' ‚Ä¢ ')} 
                <span style="color: var(--text-muted); margin-left: 1rem;">Derni√®re action: ${lastTime}</span>
            `;
        }
        
        async function loadEventTypes() {
            const container = document.getElementById('eventTypesContainer');
            
            try {
                // Agr√©ger les √©v√©nements par type
                const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString();
                
                const { data: events, error } = await supabaseClient
                    .from('analytics_events')
                    .select('event_type')
                    .gte('created_at', thirtyDaysAgo);
                
                if (error) throw error;
                
                // Compter par type
                const counts = {};
                (events || []).forEach(e => {
                    counts[e.event_type] = (counts[e.event_type] || 0) + 1;
                });
                
                const sortedTypes = Object.entries(counts).sort((a, b) => b[1] - a[1]);
                
                if (sortedTypes.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-muted)">Aucune donn√©e sur les 30 derniers jours</p>';
                    return;
                }
                
                let html = '<table><thead><tr><th>Type d\'√©v√©nement</th><th>Nombre (30j)</th><th>%</th></tr></thead><tbody>';
                
                const total = sortedTypes.reduce((sum, [, count]) => sum + count, 0);
                
                sortedTypes.forEach(([type, count]) => {
                    const percent = ((count / total) * 100).toFixed(1);
                    const badgeClass = getBadgeClass(type);
                    
                    html += `<tr>
                        <td><span class="badge ${badgeClass}">${type}</span></td>
                        <td>${count}</td>
                        <td>${percent}%</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
                
            } catch (e) {
                console.error('Event types error:', e);
                container.innerHTML = '<p style="color: var(--text-muted)">Table analytics_events non disponible</p>';
            }
        }
        
        function getBadgeClass(eventType) {
            switch (eventType) {
                case 'login': return 'badge-login';
                case 'logout': return 'badge-logout';
                case 'signup': return 'badge-signup';
                case 'search': return 'badge-search';
                case 'share': return 'badge-share';
                default: return 'badge-other';
            }
        }
        
        function formatEventData(data) {
            if (!data || Object.keys(data).length === 0) return '-';
            
            const parts = [];
            if (data.query) parts.push(`"${data.query}"`);
            if (data.page) parts.push(data.page);
            if (data.source) parts.push(data.source);
            if (data.method) parts.push(data.method);
            
            return parts.length > 0 ? escapeHtml(parts.join(', ')) : '-';
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Auto-refresh toutes les 30 secondes
        setInterval(loadDashboard, 30000);
        
        // Initialiser au chargement
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
